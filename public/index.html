<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClinicalSpeak EHR</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #E85D4F 0%, #F4A261 50%, #E76F51 100%);
            min-height: 100vh;
        }
        .auth-container {
            max-width: 450px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(232, 93, 79, 0.3);
        }
        .auth-container h2 { margin-bottom: 10px; color: #E85D4F; text-align: center; }
        .auth-tabs { display: flex; gap: 10px; margin-bottom: 30px; }
        .auth-tab {
            flex: 1; padding: 12px; border: 2px solid #e5e5e5; border-radius: 8px;
            background: white; cursor: pointer; text-align: center; transition: all 0.3s;
        }
        .auth-tab.active { border-color: #E85D4F; background: #FFE5E0; color: #E85D4F; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .app-container { display: none; min-height: 100vh; }
        .client-portal { display: none; min-height: 100vh; background: white; }
        .header {
            background: white; padding: 20px 40px; box-shadow: 0 2px 10px rgba(232, 93, 79, 0.15);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { color: #E85D4F; font-size: 24px; }
        .tabs { background: white; display: flex; padding: 0 40px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn {
            padding: 15px 20px; border: none; background: none; cursor: pointer;
            font-size: 14px; font-weight: 500; color: #666; border-bottom: 3px solid transparent;
        }
        .tab-btn.active { color: #E85D4F; border-bottom-color: #E85D4F; }
        .content { padding: 40px; max-width: 1400px; margin: 0 auto; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .content-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .content-header h2 { color: white; font-size: 28px; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;
            font-size: 14px; font-weight: 500; transition: all 0.3s;
        }
        .btn-primary { background: #E85D4F; color: white; }
        .btn-primary:hover { background: #D64C3D; }
        .input {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 14px; margin-bottom: 15px;
        }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .client-card {
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 8px rgba(232, 93, 79, 0.1); cursor: pointer; transition: all 0.3s;
        }
        .client-card:hover { transform: translateY(-4px); box-shadow: 0 6px 20px rgba(232, 93, 79, 0.2); }
        .loading { text-align: center; padding: 40px; color: white; font-size: 18px; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 20px 0; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(232, 93, 79, 0.5); z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; margin: 50px auto; padding: 30px; border-radius: 12px; max-width: 600px; box-shadow: 0 10px 40px rgba(232, 93, 79, 0.3); }
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #999; }
        .close:hover { color: #E85D4F; }
        .notification-badge { background: #e74c3c; color: white; border-radius: 50%; padding: 2px 6px; font-size: 11px; margin-left: 8px; }
        
        /* Client Portal Styles */
        .client-portal-content {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .document-header {
            background: linear-gradient(135deg, #FFE5E0 0%, #FFD6CC 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            border: 1px solid #F4A261;
        }
        .document-header h1 {
            color: #E85D4F;
            margin-bottom: 10px;
        }
        .form-section {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(232, 93, 79, 0.1);
            margin-bottom: 20px;
        }
        .form-field {
            margin-bottom: 20px;
        }
        .form-field label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #E85D4F;
        }
        .form-field input,
        .form-field textarea,
        .form-field select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-field textarea {
            min-height: 100px;
            resize: vertical;
        }
        .signature-pad {
            border: 2px dashed #F4A261;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            background: #FFF5F0;
        }
        .signature-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #E85D4F;
            border-radius: 6px;
            font-family: 'Brush Script MT', cursive;
            font-size: 24px;
            text-align: center;
        }
        .submit-section {
            background: #FFE5E0;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            margin-top: 30px;
        }

        /* Phase 1 Styles */
        .search-filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }
        .search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid white;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        .search-input::placeholder {
            color: #999;
        }
        .filter-select {
            padding: 12px;
            border: 2px solid white;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            min-width: 200px;
        }
        .edit-icon {
            cursor: pointer;
            color: #E85D4F;
            font-size: 18px;
            margin-left: 10px;
        }
        .edit-icon:hover {
            color: #D64C3D;
        }

        /* Multi-doc navigation */
        .doc-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 10px 0;
        }
        .doc-nav-item {
            padding: 10px 20px;
            background: white;
            border: 2px solid #E85D4F;
            border-radius: 6px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }
        .doc-nav-item.active {
            background: #E85D4F;
            color: white;
        }
        .doc-nav-item.completed {
            background: #27ae60;
            border-color: #27ae60;
            color: white;
        }
        
        /* HIPAA Content */
        .hipaa-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(232, 93, 79, 0.1);
            margin-bottom: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .hipaa-content h3 {
            color: #E85D4F;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .hipaa-content h4 {
            color: #E85D4F;
            margin-top: 15px;
            margin-bottom: 8px;
        }
        .hipaa-content p {
            margin-bottom: 12px;
            line-height: 1.6;
            color: #333;
        }
        .hipaa-content ul, .hipaa-content ol {
            margin-left: 25px;
            margin-bottom: 12px;
        }
        .hipaa-content li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="auth-container" id="authContainer">
        <h2>üè• ClinicalSpeak</h2>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">HIPAA-Compliant Clinical Platform</p>
        
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchAuthTab('clinician')">üë®‚Äç‚öïÔ∏è Clinician</div>
            <div class="auth-tab" onclick="switchAuthTab('client')">üìÑ Client</div>
        </div>

        <div id="clinicianAuth" class="auth-form active">
            <input type="text" id="username" placeholder="Username" class="input">
            <input type="password" id="password" placeholder="Password" class="input">
            <button onclick="clinicianLogin()" class="btn btn-primary" style="width: 100%;">Sign In</button>
            <p style="margin-top: 20px; font-size: 12px; color: #666; text-align: center;">Demo: admin / admin123</p>
        </div>

        <div id="clientAuth" class="auth-form">
            <input type="text" id="authCode" placeholder="Enter Code" class="input" style="text-transform: uppercase;">
            <button onclick="accessDocument()" class="btn btn-primary" style="width: 100%;">Access Document</button>
            <p style="margin-top: 20px; font-size: 12px; color: #666; text-align: center;">Demo: <strong>DEMO-123456</strong></p>
        </div>
    </div>

    <!-- Client Portal -->
    <div class="client-portal" id="clientPortal">
        <div class="header">
            <h1>üè• ClinicalSpeak</h1>
            <button onclick="clientLogout()" class="btn">Exit</button>
        </div>
        <div class="client-portal-content" id="clientPortalContent">
            <!-- Document will be rendered here -->
        </div>
    </div>

    <!-- Remaining HTML structure same as before, just showing the script changes -->

<script>
// Global variables and templates
const API_URL = window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : '/api';
let authToken = null;
let currentUser = null;
let clients = [];
let assignedDocs = [];
let currentDocuments = [];
let currentDocIndex = 0;

// UPDATED HIPAA TEMPLATE with your content
const documentTemplates = {
    hipaa: {
        id: 'hipaa',
        name: 'HIPAA Notice of Privacy Practices',
        fullContent: `
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #E85D4F;">Riverstone Behavioral Health</h2>
                <p>75 Manhattan Drive, Ste. 206<br>Boulder, CO 80303</p>
                <p>joseph@steadyhandllc.com | 720-808-2150</p>
            </div>
            
            <h3>NOTICE OF PRIVACY PRACTICES</h3>
            <p><strong>THIS NOTICE DESCRIBES HOW HEALTH INFORMATION MAY BE USED AND DISCLOSED AND HOW YOU CAN GET ACCESS TO THIS INFORMATION. PLEASE REVIEW IT CAREFULLY.</strong></p>
            
            <h4>I. MY PLEDGE REGARDING HEALTH INFORMATION:</h4>
            <p>I understand that health information about you and your health care is personal. I am committed to protecting health information about you. I create a record of the care and services you receive from me. I need this record to provide you with quality care and to comply with certain legal requirements. This notice applies to all of the records of your care generated by this mental health care practice. This notice will tell you about the ways in which I may use and disclose health information about you. I also describe your rights to the health information I keep about you, and describe certain obligations I have regarding the use and disclosure of your health information.</p>
            
            <p><strong>I am required by law to:</strong></p>
            <ul>
                <li>Make sure that protected health information ("PHI") that identifies you is kept private.</li>
                <li>Give you this notice of my legal duties and privacy practices with respect to health information.</li>
                <li>Follow the terms of the notice that is currently in effect.</li>
            </ul>
            
            <p>I can change the terms of this Notice, and such changes will apply to all information I have about you. The new Notice will be available upon request, in my office, and on my website.</p>
            
            <h4>II. HOW I MAY USE AND DISCLOSE HEALTH INFORMATION ABOUT YOU:</h4>
            <p><strong>For Treatment, Payment, or Health Care Operations:</strong> Federal privacy rules (regulations) allow health care providers who have direct treatment relationship with the patient/client to use or disclose the patient/client's personal health information without the patient's written authorization, to carry out the health care provider's own treatment, payment or health care operations. I may also disclose your protected health information for the treatment activities of any health care provider.</p>
            
            <p>Disclosures for treatment purposes are not limited to the minimum necessary standard because therapists and other health care providers need access to the full record and/or full and complete information in order to provide quality care. The word "treatment" includes, among other things, the coordination and management of health care providers with a third party, consultations between health care providers and referrals of a patient for health care from one health care provider to another.</p>
            
            <p><strong>Lawsuits and Disputes:</strong> If you are involved in a lawsuit, I may disclose health information in response to a court or administrative order. I may also disclose health information about your child in response to a subpoena, discovery request, or other lawful process by someone else involved in the dispute, but only if efforts have been made to tell you about the request or to obtain an order protecting the information requested.</p>
            
            <h4>III. CERTAIN USES AND DISCLOSURES REQUIRE YOUR AUTHORIZATION:</h4>
            <p><strong>Psychotherapy Notes:</strong> I do keep "psychotherapy notes" as that term is defined in 45 CFR ¬ß 164.501, and any use or disclosure of such notes requires your Authorization unless the use or disclosure is:</p>
            <ol style="list-style-type: lower-alpha;">
                <li>For my use in treating you.</li>
                <li>For my use in training or supervising mental health practitioners to help them improve their skills in group, joint, family, or individual counseling or therapy.</li>
                <li>For my use in defending myself in legal proceedings instituted by you.</li>
                <li>For use by the Secretary of Health and Human Services to investigate my compliance with HIPAA.</li>
                <li>Required by law and the use or disclosure is limited to the requirements of such law.</li>
                <li>Required by law for certain health oversight activities pertaining to the originator of the psychotherapy notes.</li>
                <li>Required by a coroner who is performing duties authorized by law.</li>
                <li>Required to help avert a serious threat to the health and safety of others.</li>
            </ol>
            
            <p><strong>Marketing Purposes:</strong> As a psychotherapist, I will not use or disclose your PHI for marketing purposes.</p>
            
            <p><strong>Sale of PHI:</strong> As a psychotherapist, I will not sell your PHI in the regular course of my business.</p>
            
            <h4>IV. CERTAIN USES AND DISCLOSURES DO NOT REQUIRE YOUR AUTHORIZATION:</h4>
            <p>Subject to certain limitations in the law, I can use and disclose your PHI without your Authorization for the following reasons:</p>
            <ol>
                <li>When disclosure is required by state or federal law, and the use or disclosure complies with and is limited to the relevant requirements of such law.</li>
                <li>For public health activities, including reporting suspected child, elder, or dependent adult abuse, or preventing or reducing a serious threat to anyone's health or safety.</li>
                <li>For health oversight activities, including audits and investigations.</li>
                <li>For judicial and administrative proceedings, including responding to a court or administrative order, although my preference is to obtain an Authorization from you before doing so.</li>
                <li>For law enforcement purposes, including reporting crimes occurring on my premises.</li>
                <li>To coroners or medical examiners, when such individuals are performing duties authorized by law.</li>
                <li>For research purposes, including studying and comparing the mental health of patients who received one form of therapy versus those who received another form of therapy for the same condition.</li>
                <li>Specialized government functions, including ensuring the proper execution of military missions; protecting the President of the United States; conducting intelligence or counter-intelligence operations; or helping to ensure the safety of those working within or housed in correctional institutions.</li>
                <li>For workers' compensation purposes. Although my preference is to obtain an Authorization from you, I may provide your PHI in order to comply with workers' compensation laws.</li>
                <li>Appointment reminders and health related benefits or services. I may use and disclose your PHI to contact you to remind you that you have an appointment with me. I may also use and disclose your PHI to tell you about treatment alternatives, or other health care services or benefits that I offer.</li>
            </ol>
            
            <h4>V. CERTAIN USES AND DISCLOSURES REQUIRE YOU TO HAVE THE OPPORTUNITY TO OBJECT:</h4>
            <p><strong>Disclosures to family, friends, or others:</strong> I may provide your PHI to a family member, friend, or other person that you indicate is involved in your care or the payment for your health care, unless you object in whole or in part. The opportunity to consent may be obtained retroactively in emergency situations.</p>
            
            <h4>VI. YOU HAVE THE FOLLOWING RIGHTS WITH RESPECT TO YOUR PHI:</h4>
            <ol>
                <li><strong>The Right to Request Limits on Uses and Disclosures of Your PHI:</strong> You have the right to ask me not to use or disclose certain PHI for treatment, payment, or health care operations purposes. I am not required to agree to your request, and I may say "no" if I believe it would affect your health care.</li>
                <li><strong>The Right to Request Restrictions for Out-of-Pocket Expenses Paid for In Full:</strong> You have the right to request restrictions on disclosures of your PHI to health plans for payment or health care operations purposes if the PHI pertains solely to a health care item or a health care service that you have paid for out-of-pocket in full.</li>
                <li><strong>The Right to Choose How I Send PHI to You:</strong> You have the right to ask me to contact you in a specific way (for example, home or office phone) or to send mail to a different address, and I will agree to all reasonable requests.</li>
                <li><strong>The Right to See and Get Copies of Your PHI:</strong> Other than "psychotherapy notes," you have the right to get an electronic or paper copy of your medical record and other information that I have about you. I will provide you with a copy of your record, or a summary of it, if you agree to receive a summary, within 30 days of receiving your written request, and I may charge a reasonable, cost based fee for doing so.</li>
                <li><strong>The Right to Get a List of the Disclosures I Have Made:</strong> You have the right to request a list of instances in which I have disclosed your PHI for purposes other than treatment, payment, or health care operations, or for which you provided me with an Authorization. I will respond to your request for an accounting of disclosures within 60 days of receiving your request. The list I will give you will include disclosures made in the last six years unless you request a shorter time. I will provide the list to you at no charge, but if you make more than one request in the same year, I will charge you a reasonable cost based fee for each additional request.</li>
                <li><strong>The Right to Correct or Update Your PHI:</strong> If you believe that there is a mistake in your PHI, or that a piece of important information is missing from your PHI, you have the right to request that I correct the existing information or add the missing information. I may say "no" to your request, but I will tell you why in writing within 60 days of receiving your request.</li>
                <li><strong>The Right to Get a Paper or Electronic Copy of this Notice:</strong> You have the right get a paper copy of this Notice, and you have the right to get a copy of this notice by e-mail. And, even if you have agreed to receive this Notice via e-mail, you also have the right to request a paper copy of it.</li>
            </ol>
            
            <h4>Acknowledgement of Receipt of Privacy Notice</h4>
            <p>Under the Health Insurance Portability and Accountability Act of 1996 (HIPAA), you have certain rights regarding the use and disclosure of your protected health information. By checking the box below, you are acknowledging that you have received a copy of HIPAA Notice of Privacy Practices.</p>
            <p><strong>BY SIGNING BELOW I AM AGREEING THAT I HAVE READ, UNDERSTOOD AND AGREE TO THE ITEMS CONTAINED IN THIS DOCUMENT.</strong></p>
        `,
        fields: [
            { id: 'received_notice', label: 'I acknowledge that I have received and reviewed the complete Notice of Privacy Practices above', type: 'checkbox' },
            { id: 'understand_rights', label: 'I understand my rights regarding the privacy of my health information', type: 'checkbox' },
            { id: 'understand_uses', label: 'I understand how my health information may be used and disclosed', type: 'checkbox' },
            { id: 'preferred_contact', label: 'Preferred Method of Contact', type: 'select', options: ['Phone', 'Secure Portal', 'Mail'] },
            { id: 'contact_restrictions', label: 'Are there any restrictions on how we may contact you?', type: 'textarea' }
        ]
    },
    // ... other templates remain the same
    consent: {
        id: 'consent',
        name: 'Informed Consent',
        fields: [
            { id: 'understand_services', label: 'I understand the services being provided', type: 'checkbox' },
            { id: 'confidentiality', label: 'I understand confidentiality and its limits', type: 'checkbox' },
            { id: 'emergency_contact', label: 'Emergency Contact Name', type: 'text' },
            { id: 'emergency_phone', label: 'Emergency Contact Phone', type: 'tel' },
            { id: 'additional_notes', label: 'Additional Notes or Questions', type: 'textarea' }
        ]
    },
    intake: {
        id: 'intake',
        name: 'Initial Intake',
        fields: [
            { id: 'chief_complaint', label: 'What brings you here today?', type: 'textarea' },
            { id: 'previous_treatment', label: 'Have you received mental health treatment before?', type: 'select', options: ['No', 'Yes - Therapy', 'Yes - Medication', 'Yes - Both'] },
            { id: 'current_medications', label: 'Current Medications', type: 'textarea' },
            { id: 'goals', label: 'What are your goals for treatment?', type: 'textarea' }
        ]
    }
};

const templateNames = { 
    consent: 'Informed Consent', 
    intake: 'Initial Intake',
    hipaa: 'HIPAA Notice of Privacy Practices'
};

// ==================== CLIENT PORTAL - FIXED MULTI DOC ====================
function renderClientDocuments() {
    const container = document.getElementById('clientPortalContent');
    
    if (currentDocuments.length === 0) {
        container.innerHTML = '<div class="error">No documents found</div>';
        return;
    }
    
    // Navigation for multiple documents
    let navHTML = '';
    if (currentDocuments.length > 1) {
        navHTML = '<div class="doc-nav">';
        currentDocuments.forEach((doc, index) => {
            const isActive = index === currentDocIndex;
            const isCompleted = doc.status === 'completed';
            navHTML += `<div class="doc-nav-item ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}" onclick="switchDocument(${index})">
                ${index + 1}. ${templateNames[doc.template_id]}
            </div>`;
        });
        navHTML += '</div>';
    }
    
    const currentDoc = currentDocuments[currentDocIndex];
    const template = documentTemplates[currentDoc.template_id];
    
    if (!template) {
        container.innerHTML = '<div class="error">Document template not found</div>';
        return;
    }
    
    let html = navHTML + `
        <div class="document-header">
            <h1>${template.name}</h1>
            <p style="color: #666;">Client: ${currentDoc.client_name}</p>
            ${currentDocuments.length > 1 ? `<p style="color: #999; font-size: 14px; margin-top: 5px;">Document ${currentDocIndex + 1} of ${currentDocuments.length}</p>` : ''}
        </div>
    `;
    
    // HIPAA gets special treatment with full content display
    if (currentDoc.template_id === 'hipaa') {
        html += `<div class="hipaa-content">${template.fullContent}</div>`;
    }
    
    html += `
        <div class="form-section">
            <h2 style="margin-bottom: 20px;">Please complete the following:</h2>
            <form id="clientDocumentForm">
    `;
    
    template.fields.forEach(field => {
        html += `<div class="form-field">`;
        html += `<label for="${field.id}">${field.label}</label>`;
        
        if (field.type === 'checkbox') {
            html += `<input type="checkbox" id="${field.id}" name="${field.id}" style="width: auto; margin-right: 10px;">`;
        } else if (field.type === 'select') {
            html += `<select id="${field.id}" name="${field.id}">`;
            field.options.forEach(opt => {
                html += `<option value="${opt}">${opt}</option>`;
            });
            html += `</select>`;
        } else if (field.type === 'textarea') {
            html += `<textarea id="${field.id}" name="${field.id}"></textarea>`;
        } else {
            html += `<input type="${field.type}" id="${field.id}" name="${field.id}">`;
        }
        
        html += `</div>`;
    });
    
    html += `
            </form>
        </div>
        
        <div class="form-section">
            <h3 style="margin-bottom: 20px;">Signature</h3>
            <div class="signature-pad">
                <p style="margin-bottom: 10px; color: #666;">Type your full name to sign:</p>
                <input type="text" id="clientSignature" class="signature-input" placeholder="Your Full Name">
                <p style="margin-top: 10px; font-size: 12px; color: #999;">By typing your name, you agree that this constitutes a legal signature</p>
            </div>
        </div>
        
        <div class="submit-section">
            <p style="margin-bottom: 20px; color: #666;">Once you submit, this document will be sent to your clinician for review</p>
            <button onclick="submitClientDocument()" class="btn btn-primary" style="font-size: 16px; padding: 15px 40px;">Submit This Document</button>
        </div>
    `;
    
    container.innerHTML = html;
}

function switchDocument(index) {
    currentDocIndex = index;
    renderClientDocuments();
}

// FIXED SUBMISSION FUNCTION
async function submitClientDocument() {
    // Get signature first
    const signatureInput = document.getElementById('clientSignature');
    if (!signatureInput) {
        alert('Error: Signature field not found');
        return;
    }
    
    const signature = signatureInput.value.trim();
    
    if (!signature) {
        alert('Please provide your signature');
        return;
    }
    
    // Collect form data
    const form = document.getElementById('clientDocumentForm');
    if (!form) {
        alert('Error: Form not found');
        return;
    }
    
    const responses = {};
    const currentDoc = currentDocuments[currentDocIndex];
    const template = documentTemplates[currentDoc.template_id];
    
    // Collect all field values
    template.fields.forEach(field => {
        const element = document.getElementById(field.id);
        if (element) {
            if (element.type === 'checkbox') {
                responses[field.id] = element.checked;
            } else {
                responses[field.id] = element.value;
            }
        }
    });
    
    try {
        // This would normally call your API
        console.log('Submitting document:', {
            doc_id: currentDoc.id,
            responses: responses,
            signature: signature
        });
        
        // Mark as completed locally
        currentDocuments[currentDocIndex].status = 'completed';
        
        // Check if there are more documents
        const remainingDocs = currentDocuments.filter(d => d.status === 'pending');
        
        if (remainingDocs.length > 0) {
            alert(`‚úÖ Document submitted! You have ${remainingDocs.length} more document(s) to complete.`);
            // Move to next pending document
            currentDocIndex = currentDocuments.findIndex(d => d.status === 'pending');
            renderClientDocuments();
        } else {
            alert('‚úÖ All documents submitted successfully! Thank you.');
            clientLogout();
        }
    } catch (error) {
        alert('Error submitting document: ' + error.message);
        console.error('Submission error:', error);
    }
}

// ==================== AUTH & NAVIGATION ====================
function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tab + 'Auth').classList.add('active');
}

async function accessDocument() {
    const code = document.getElementById('authCode').value.toUpperCase().trim();
    if (!code) {
        alert('Please enter an access code');
        return;
    }
    
    // Demo mode - simulate multiple documents
    if (code === 'DEMO-123456') {
        currentDocuments = [
            {
                id: 1,
                template_id: 'hipaa',
                client_name: 'Demo Client',
                status: 'pending',
                auth_code: code
            },
            {
                id: 2,
                template_id: 'consent',
                client_name: 'Demo Client',
                status: 'pending',
                auth_code: code
            },
            {
                id: 3,
                template_id: 'intake',
                client_name: 'Demo Client',
                status: 'pending',
                auth_code: code
            }
        ];
        currentDocIndex = 0;
        showClientPortal();
    } else {
        alert('Invalid code. Try: DEMO-123456');
    }
}

function showClientPortal() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('clientPortal').style.display = 'block';
    renderClientDocuments();
}

function clientLogout() {
    currentDocuments = [];
    currentDocIndex = 0;
    document.getElementById('authContainer').style.display = 'block';
    document.getElementById('clientPortal').style.display = 'none';
    document.getElementById('authCode').value = '';
}

// Demo initialization
console.log('ClinicalSpeak Client Portal - Demo Mode');
console.log('Use code: DEMO-123456 to test multi-document flow with updated HIPAA notice');
</script>
</body>
</html>
