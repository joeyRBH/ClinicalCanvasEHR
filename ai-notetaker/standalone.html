<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Clinical NoteTaker - Riverstone EHR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .recorder-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .record-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .record-button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .record-button.recording {
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .record-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .timer {
            font-size: 3em;
            text-align: center;
            color: #667eea;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #f7f7f7;
            border-radius: 10px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status.info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .status.success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .status.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .status.warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }

        .transcript-box {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f7f7f7;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 1.05em;
        }

        .notes-output {
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
            padding: 20px;
            background: #f7f7f7;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            line-height: 1.8;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            margin-bottom: 15px;
        }

        select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .settings-panel {
            background: #f0f0f0;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .settings-panel label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .audio-visualizer {
            width: 100%;
            height: 80px;
            background: #f7f7f7;
            border-radius: 10px;
            margin: 15px 0;
        }

        .instructions {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .instructions h3 {
            color: #f57c00;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéôÔ∏è AI Clinical NoteTaker</h1>
            <p>Record sessions and automatically generate HIPAA-compliant clinical notes</p>
        </div>

        <div class="instructions">
            <h3>How to Use:</h3>
            <ol>
                <li>Click "Start Recording" to begin capturing your session</li>
                <li>Speak naturally during the session</li>
                <li>Click "Stop Recording" when finished</li>
                <li>Review the transcript and select your desired note format</li>
                <li>Click "Generate Clinical Notes" to create professional documentation</li>
            </ol>
        </div>

        <div class="main-content">
            <!-- Recording Panel -->
            <div class="card">
                <h2>üìπ Session Recording</h2>

                <div class="recorder-controls">
                    <div class="timer" id="timer">00:00:00</div>

                    <button class="record-button" id="recordBtn">
                        <span id="recordIcon">üéôÔ∏è</span>
                        <span id="recordText">Start Recording</span>
                    </button>

                    <canvas class="audio-visualizer" id="visualizer"></canvas>

                    <div id="statusMessage"></div>
                </div>

                <div class="settings-panel">
                    <label for="noteFormat">Note Format:</label>
                    <select id="noteFormat">
                        <option value="soap">SOAP Note</option>
                        <option value="dap">DAP Note</option>
                        <option value="progress">Progress Note</option>
                        <option value="psychotherapy">Psychotherapy Note</option>
                        <option value="intake">Initial Intake Note</option>
                        <option value="discharge">Discharge Summary</option>
                    </select>

                    <label for="clientName">Client Name (Optional):</label>
                    <input type="text" id="clientName" placeholder="Enter client name">

                    <label for="sessionType">Session Type:</label>
                    <select id="sessionType">
                        <option value="individual">Individual Therapy</option>
                        <option value="couples">Couples Therapy</option>
                        <option value="family">Family Therapy</option>
                        <option value="group">Group Therapy</option>
                        <option value="assessment">Assessment</option>
                    </select>
                </div>
            </div>

            <!-- Transcript Panel -->
            <div class="card">
                <h2>üìù Session Transcript</h2>
                <div class="transcript-box" id="transcript">
                    Transcript will appear here as you record...
                </div>
                <div class="button-group" style="margin-top: 15px;">
                    <button class="btn btn-secondary" id="clearTranscript">Clear Transcript</button>
                    <button class="btn btn-secondary" id="editTranscript">Edit Transcript</button>
                </div>
            </div>

            <!-- Generated Notes Panel -->
            <div class="card full-width">
                <h2>üìã Generated Clinical Notes</h2>

                <div class="button-group" style="margin-bottom: 15px;">
                    <button class="btn btn-primary" id="generateBtn" disabled>
                        Generate Clinical Notes
                    </button>
                    <button class="btn btn-success" id="copyBtn" disabled>
                        Copy to Clipboard
                    </button>
                    <button class="btn btn-secondary" id="downloadBtn" disabled>
                        Download Note
                    </button>
                </div>

                <div class="notes-output" id="notesOutput">
                    Generated clinical notes will appear here...
                </div>
            </div>
        </div>
    </div>

    <script>
        // State Management
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let startTime = null;
        let timerInterval = null;
        let audioContext = null;
        let analyser = null;
        let recognition = null;
        let transcript = '';

        // DOM Elements
        const recordBtn = document.getElementById('recordBtn');
        const recordIcon = document.getElementById('recordIcon');
        const recordText = document.getElementById('recordText');
        const timer = document.getElementById('timer');
        const statusMessage = document.getElementById('statusMessage');
        const transcriptBox = document.getElementById('transcript');
        const notesOutput = document.getElementById('notesOutput');
        const generateBtn = document.getElementById('generateBtn');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const clearTranscriptBtn = document.getElementById('clearTranscript');
        const editTranscriptBtn = document.getElementById('editTranscript');
        const visualizerCanvas = document.getElementById('visualizer');
        const visualizerCtx = visualizerCanvas.getContext('2d');

        // Initialize Speech Recognition
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcriptPiece = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcriptPiece + ' ';
                        } else {
                            interimTranscript += transcriptPiece;
                        }
                    }

                    if (finalTranscript) {
                        transcript += finalTranscript;
                        transcriptBox.textContent = transcript + interimTranscript;
                        generateBtn.disabled = false;
                    } else {
                        transcriptBox.textContent = transcript + interimTranscript;
                    }
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    showStatus('Speech recognition error: ' + event.error, 'warning');
                };
            } else {
                showStatus('Speech recognition not supported. You can manually enter or paste the transcript.', 'warning');
            }
        }

        // Audio Visualization
        function setupAudioVisualization(stream) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            analyser.fftSize = 256;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function draw() {
                if (!isRecording) return;

                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);

                visualizerCtx.fillStyle = '#f7f7f7';
                visualizerCtx.fillRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);

                const barWidth = (visualizerCanvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    barHeight = (dataArray[i] / 255) * visualizerCanvas.height;
                    visualizerCtx.fillStyle = `rgb(${barHeight + 100}, 126, 234)`;
                    visualizerCtx.fillRect(x, visualizerCanvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            }

            draw();
        }

        // Timer Functions
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timer.textContent = '00:00:00';
        }

        function updateTimer() {
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);

            timer.textContent =
                String(hours).padStart(2, '0') + ':' +
                String(minutes).padStart(2, '0') + ':' +
                String(seconds).padStart(2, '0');
        }

        // Status Messages
        function showStatus(message, type = 'info') {
            statusMessage.className = `status ${type}`;
            statusMessage.textContent = message;
            statusMessage.style.display = 'block';
        }

        // Recording Functions
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    // You can upload this to a transcription service if needed
                };

                mediaRecorder.start();
                if (recognition) recognition.start();

                setupAudioVisualization(stream);
                startTimer();

                isRecording = true;
                recordBtn.classList.add('recording');
                recordIcon.textContent = '‚èπÔ∏è';
                recordText.textContent = 'Stop Recording';

                showStatus('Recording in progress...', 'success');
            } catch (error) {
                console.error('Error starting recording:', error);
                showStatus('Error accessing microphone. Please check permissions.', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }

            if (recognition) {
                recognition.stop();
            }

            if (audioContext) {
                audioContext.close();
            }

            stopTimer();

            isRecording = false;
            recordBtn.classList.remove('recording');
            recordIcon.textContent = 'üéôÔ∏è';
            recordText.textContent = 'Start Recording';

            showStatus('Recording stopped. Ready to generate notes.', 'info');
        }

        // Generate Clinical Notes using Claude API
        async function generateClinicalNotes() {
            const noteFormat = document.getElementById('noteFormat').value;
            const clientName = document.getElementById('clientName').value || '[Client Name]';
            const sessionType = document.getElementById('sessionType').value;

            if (!transcript.trim()) {
                showStatus('No transcript available. Please record a session first.', 'error');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="loading"></span> Generating Notes...';
            showStatus('Generating clinical notes...', 'info');

            try {
                const prompt = createNotePrompt(noteFormat, clientName, sessionType, transcript);

                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4000,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate notes');
                }

                const data = await response.json();
                const generatedNotes = data.content[0].text;

                notesOutput.innerHTML = formatNotes(generatedNotes);
                copyBtn.disabled = false;
                downloadBtn.disabled = false;

                showStatus('Clinical notes generated successfully!', 'success');
            } catch (error) {
                console.error('Error generating notes:', error);
                showStatus('Error generating notes. Please try again.', 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Clinical Notes';
            }
        }

        // Create appropriate prompt based on note format
        function createNotePrompt(format, clientName, sessionType, transcript) {
            const basePrompt = `You are a licensed mental health professional creating clinical documentation. Generate a professional, HIPAA-compliant ${format.toUpperCase()} note based on the following therapy session transcript.

CLIENT: ${clientName}
SESSION TYPE: ${sessionType}

TRANSCRIPT:
${transcript}

Please create a comprehensive ${format.toUpperCase()} note that includes:`;

            const formatSpecifics = {
                soap: `
- SUBJECTIVE: Client's reported experiences, feelings, and concerns
- OBJECTIVE: Observable behaviors, appearance, and clinical observations
- ASSESSMENT: Clinical impressions, progress toward goals, and diagnosis considerations
- PLAN: Treatment recommendations, interventions, and next steps`,

                dap: `
- DATA: Objective observations and information gathered during session
- ASSESSMENT: Clinical analysis and interpretation
- PLAN: Treatment goals and action items`,

                progress: `
- Session focus and therapeutic interventions used
- Client progress toward treatment goals
- Clinical observations and mental status
- Plan for next session`,

                psychotherapy: `
- Analysis of client's psychological processes
- Therapeutic techniques employed
- Clinical impressions and dynamics observed
- Treatment planning and recommendations`,

                intake: `
- Presenting problem and chief complaint
- Relevant history (mental health, medical, family, social)
- Mental status examination
- Initial diagnosis and treatment recommendations
- Risk assessment`,

                discharge: `
- Summary of treatment course
- Progress made toward goals
- Current functioning and status
- Discharge recommendations and aftercare plan
- Follow-up needs`
            };

            return basePrompt + formatSpecifics[format] + '\n\nEnsure the note is professional, thorough, and suitable for medical records. Use appropriate clinical terminology and maintain objectivity.';
        }

        // Format notes for display
        function formatNotes(notes) {
            return notes
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^/, '<p>')
                .replace(/$/, '</p>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        // Copy to clipboard
        function copyToClipboard() {
            const notesText = notesOutput.innerText;
            navigator.clipboard.writeText(notesText).then(() => {
                showStatus('Notes copied to clipboard!', 'success');
            }).catch(err => {
                showStatus('Failed to copy notes', 'error');
            });
        }

        // Download notes as text file
        function downloadNotes() {
            const notesText = notesOutput.innerText;
            const clientName = document.getElementById('clientName').value || 'Client';
            const date = new Date().toISOString().split('T')[0];
            const filename = `${clientName}_Clinical_Note_${date}.txt`;

            const blob = new Blob([notesText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);

            showStatus('Notes downloaded successfully!', 'success');
        }

        // Edit transcript
        function editTranscript() {
            const currentText = transcriptBox.textContent;
            const textarea = document.createElement('textarea');
            textarea.value = currentText;
            textarea.style.width = '100%';
            textarea.style.minHeight = '200px';
            textarea.style.fontSize = '1.05em';

            transcriptBox.innerHTML = '';
            transcriptBox.appendChild(textarea);

            const saveBtn = document.createElement('button');
            saveBtn.className = 'btn btn-success';
            saveBtn.textContent = 'Save Changes';
            saveBtn.style.marginTop = '10px';
            saveBtn.onclick = () => {
                transcript = textarea.value;
                transcriptBox.textContent = transcript;
                generateBtn.disabled = !transcript.trim();
            };

            transcriptBox.appendChild(saveBtn);
        }

        // Event Listeners
        recordBtn.addEventListener('click', () => {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        });

        generateBtn.addEventListener('click', generateClinicalNotes);
        copyBtn.addEventListener('click', copyToClipboard);
        downloadBtn.addEventListener('click', downloadNotes);
        clearTranscriptBtn.addEventListener('click', () => {
            transcript = '';
            transcriptBox.textContent = 'Transcript will appear here as you record...';
            generateBtn.disabled = true;
            showStatus('Transcript cleared', 'info');
        });
        editTranscriptBtn.addEventListener('click', editTranscript);

        // Initialize
        initSpeechRecognition();
        visualizerCanvas.width = visualizerCanvas.offsetWidth;
        visualizerCanvas.height = visualizerCanvas.offsetHeight;
    </script>
</body>
</html>
