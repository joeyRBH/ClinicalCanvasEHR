<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClinicalSpeak EHR - HIPAA Compliant</title>
    <meta name="description" content="HIPAA-compliant clinical documentation platform">
    <style>
        /* Embedded CSS - No external dependencies */
        :root {
            --primary-color: #00a86b;
            --primary-hover: #008f5a;
            --background: #f8f9fa;
            --surface: #ffffff;
            --text-primary: #333333;
            --text-secondary: #6c757d;
            --border: #e9ecef;
            --shadow: 0 2px 8px rgba(0, 168, 107, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            text-align: center;
        }

        .header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .auth-container {
            background: var(--surface);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            max-width: 400px;
            margin: 50px auto;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            border-radius: 6px 6px 0 0;
        }

        .tab.active {
            background: var(--surface);
            color: var(--primary-color);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: var(--primary-hover);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .app-container {
            display: none;
        }

        .app-container.active {
            display: block;
        }

        .nav-tabs {
            display: flex;
            background: var(--surface);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .nav-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
        }

        .nav-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .content {
            background: var(--surface);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            min-height: 400px;
        }

        .content.hidden {
            display: none;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .client-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .client-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .alert {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .close:hover {
            color: var(--primary-color);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .auth-container {
                margin: 20px;
                padding: 30px 20px;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="auth-container">
        <h2>üè• ClinicalSpeak EHR</h2>
        <p style="text-align: center; color: var(--text-secondary); margin-bottom: 30px;">
            HIPAA-Compliant Clinical Documentation Platform
        </p>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('clinician')">üë®‚Äç‚öïÔ∏è Clinician</button>
            <button class="tab" onclick="switchTab('client')">üìÑ Client</button>
        </div>

        <!-- Clinician Login -->
        <div id="clinicianForm">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password">
            </div>
            <button class="btn" onclick="clinicianLogin()">Sign In</button>
            <p style="text-align: center; margin-top: 20px; font-size: 12px; color: var(--text-secondary);">
                Demo: admin / admin123
            </p>
        </div>

        <!-- Client Access -->
        <div id="clientForm" style="display: none;">
            <div class="form-group">
                <label for="authCode">Authentication Code</label>
                <input type="text" id="authCode" class="form-control" placeholder="Enter access code" style="text-transform: uppercase;">
            </div>
            <button class="btn" onclick="clientAccess()">Access Document</button>
            <p style="text-align: center; margin-top: 20px; font-size: 12px; color: var(--text-secondary);">
                Enter the code provided by your clinician
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appScreen" class="container" style="display: none;">
        <div class="header">
            <h1>üè• ClinicalSpeak EHR</h1>
            <p>Welcome, <span id="userName">Admin</span></p>
            <button class="btn" onclick="logout()" style="width: auto; padding: 8px 16px; margin-top: 10px;">Logout</button>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('dashboard')">üìä Dashboard</button>
            <button class="nav-tab" onclick="showSection('clients')">üë• Clients</button>
            <button class="nav-tab" onclick="showSection('appointments')">üìÖ Appointments</button>
            <button class="nav-tab" onclick="showSection('documents')">üìÑ Documents</button>
            <button class="nav-tab" onclick="showSection('audit')">üìã Audit Log</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="content">
            <h2>üìä Analytics Dashboard</h2>
            <div class="grid">
                <div class="card">
                    <h3>Total Clients</h3>
                    <div style="font-size: 32px; font-weight: bold; color: var(--primary-color);" id="totalClients">0</div>
                </div>
                <div class="card">
                    <h3>Upcoming Appointments</h3>
                    <div style="font-size: 32px; font-weight: bold; color: var(--primary-color);" id="upcomingAppointments">0</div>
                </div>
                <div class="card">
                    <h3>Pending Documents</h3>
                    <div style="font-size: 32px; font-weight: bold; color: var(--primary-color);" id="pendingDocuments">0</div>
                </div>
                <div class="card">
                    <h3>Total Revenue</h3>
                    <div style="font-size: 32px; font-weight: bold; color: var(--primary-color);" id="totalRevenue">$0</div>
                </div>
            </div>
        </div>

        <!-- Clients -->
        <div id="clients" class="content hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üë• Clients</h2>
                <button class="btn" onclick="showAddClient()" style="width: auto; padding: 8px 16px;">+ New Client</button>
            </div>
            <div id="clientsList" class="grid"></div>
        </div>

        <!-- Appointments -->
        <div id="appointments" class="content hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìÖ Appointments</h2>
                <button class="btn" onclick="showAddAppointment()" style="width: auto; padding: 8px 16px;">+ New Appointment</button>
            </div>
            <div id="appointmentsList"></div>
        </div>

        <!-- Documents -->
        <div id="documents" class="content hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>üìÑ Documents</h2>
                <button class="btn" onclick="showAssignDocument()" style="width: auto; padding: 8px 16px;">+ Assign Document</button>
            </div>
            <div id="documentsList"></div>
        </div>

        <!-- Audit Log -->
        <div id="audit" class="content hidden">
            <h2>üìã Audit Log</h2>
            <div id="auditList"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addClientModal')">&times;</span>
            <h3>New Client</h3>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="clientName" class="form-control">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="clientEmail" class="form-control">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="clientPhone" class="form-control">
            </div>
            <div class="form-group">
                <label>Date of Birth</label>
                <input type="date" id="clientDOB" class="form-control">
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="clientNotes" class="form-control" rows="3"></textarea>
            </div>
            <button class="btn" onclick="saveClient()">Save Client</button>
        </div>
    </div>

    <div id="addAppointmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addAppointmentModal')">&times;</span>
            <h3>New Appointment</h3>
            <div class="form-group">
                <label>Client</label>
                <select id="appointmentClient" class="form-control">
                    <option value="">Select Client</option>
                </select>
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="appointmentDate" class="form-control">
            </div>
            <div class="form-group">
                <label>Time</label>
                <input type="time" id="appointmentTime" class="form-control">
            </div>
            <div class="form-group">
                <label>Type</label>
                <select id="appointmentType" class="form-control">
                    <option value="">Select Type</option>
                    <option value="90791">Psychiatric Diagnostic Evaluation - $200</option>
                    <option value="90834">Psychotherapy 45 min - $150</option>
                    <option value="90837">Psychotherapy 60 min - $180</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes</label>
                <textarea id="appointmentNotes" class="form-control" rows="3"></textarea>
            </div>
            <button class="btn" onclick="saveAppointment()">Save Appointment</button>
        </div>
    </div>

    <div id="assignDocumentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assignDocumentModal')">&times;</span>
            <h3>Assign Document</h3>
            <div class="form-group">
                <label>Client</label>
                <select id="assignClient" class="form-control">
                    <option value="">Select Client</option>
                </select>
            </div>
            <div class="form-group">
                <label>Document Type</label>
                <select id="documentType" class="form-control">
                    <option value="">Select Document</option>
                    <option value="informed_consent">Informed Consent</option>
                    <option value="treatment_plan">Treatment Plan</option>
                    <option value="progress_note">Progress Note</option>
                </select>
            </div>
            <button class="btn" onclick="saveDocumentAssignment()">Assign Document</button>
        </div>
    </div>

    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('successModal')">&times;</span>
            <h3>‚úÖ Document Assigned!</h3>
            <div class="alert alert-success">
                <strong>Authentication Code:</strong>
                <div id="generatedCode" style="font-family: monospace; font-size: 24px; font-weight: bold; text-align: center; padding: 15px; background: white; border-radius: 6px; margin: 10px 0; color: #000;"></div>
                <p>Share this code with your client.</p>
            </div>
            <button class="btn" onclick="closeModal('successModal')">Done</button>
        </div>
    </div>

    <!-- Client Portal -->
    <div id="clientPortal" class="container" style="display: none;">
        <div class="header">
            <h1>üìÑ Client Portal</h1>
            <button class="btn" onclick="clientLogout()" style="width: auto; padding: 8px 16px;">Exit</button>
        </div>
        <div id="clientContent" class="content"></div>
    </div>

    <script>
        // HIPAA-Compliant Single-File EHR System
        // Pure JavaScript - No external dependencies
        // Embedded CSS - No external stylesheets
        // Single HTML file - Clean deployment

        // Global state management
        let currentUser = null;
        let clients = [];
        let appointments = [];
        let documents = [];
        let auditLog = [];

        // HIPAA-compliant audit logging
        function logAuditEvent(action, details = {}) {
            const event = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                user: currentUser?.username || 'system',
                ip: 'client-side', // In real implementation, this would be server-side
                userAgent: navigator.userAgent
            };
            auditLog.unshift(event);
            
            // Keep only last 1000 events for performance
            if (auditLog.length > 1000) {
                auditLog = auditLog.slice(0, 1000);
            }
            
            // Store in localStorage for persistence
            try {
                localStorage.setItem('auditLog', JSON.stringify(auditLog));
            } catch (e) {
                console.warn('Could not save audit log to localStorage');
            }
        }

        // Load audit log from localStorage
        function loadAuditLog() {
            try {
                const stored = localStorage.getItem('auditLog');
                if (stored) {
                    auditLog = JSON.parse(stored);
                }
            } catch (e) {
                console.warn('Could not load audit log from localStorage');
            }
        }

        // Data encryption for HIPAA compliance
        function encryptData(data) {
            // Simple encryption for demo - in production use proper encryption
            return btoa(JSON.stringify(data));
        }

        function decryptData(encrypted) {
            try {
                return JSON.parse(atob(encrypted));
            } catch (e) {
                return null;
            }
        }

        // Load data from localStorage
        function loadData() {
            try {
                const storedClients = localStorage.getItem('clients');
                if (storedClients) {
                    clients = decryptData(storedClients) || [];
                }
                
                const storedAppointments = localStorage.getItem('appointments');
                if (storedAppointments) {
                    appointments = decryptData(storedAppointments) || [];
                }
                
                const storedDocuments = localStorage.getItem('documents');
                if (storedDocuments) {
                    documents = decryptData(storedDocuments) || [];
                }
                
                loadAuditLog();
            } catch (e) {
                console.warn('Could not load data from localStorage');
            }
        }

        // Save data to localStorage
        function saveData() {
            try {
                localStorage.setItem('clients', encryptData(clients));
                localStorage.setItem('appointments', encryptData(appointments));
                localStorage.setItem('documents', encryptData(documents));
            } catch (e) {
                console.warn('Could not save data to localStorage');
            }
        }

        // Initialize demo data
        function initializeDemoData() {
            if (clients.length === 0) {
                clients = [
                    {
                        id: 1,
                        name: 'John Doe',
                        email: 'john@example.com',
                        phone: '555-0123',
                        dob: '1990-01-15',
                        notes: 'Demo client',
                        created: new Date().toISOString()
                    },
                    {
                        id: 2,
                        name: 'Jane Smith',
                        email: 'jane@example.com',
                        phone: '555-0456',
                        dob: '1985-03-22',
                        notes: 'Regular patient',
                        created: new Date().toISOString()
                    }
                ];
            }

            if (appointments.length === 0) {
                appointments = [
                    {
                        id: 1,
                        clientId: 1,
                        clientName: 'John Doe',
                        date: new Date().toISOString().split('T')[0],
                        time: '10:00',
                        type: 'Psychotherapy 45 min',
                        notes: 'Follow-up session',
                        created: new Date().toISOString()
                    }
                ];
            }

            if (documents.length === 0) {
                documents = [
                    {
                        id: 1,
                        clientId: 1,
                        clientName: 'John Doe',
                        type: 'Informed Consent',
                        authCode: 'DEMO-123456',
                        status: 'pending',
                        created: new Date().toISOString()
                    }
                ];
            }

            saveData();
        }

        // Authentication
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('clinicianForm').style.display = tab === 'clinician' ? 'block' : 'none';
            document.getElementById('clientForm').style.display = tab === 'client' ? 'block' : 'none';
        }

        function clinicianLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Demo authentication
            if (username === 'admin' && password === 'admin123') {
                currentUser = {
                    id: 1,
                    username: 'admin',
                    name: 'Admin User',
                    role: 'admin'
                };
                
                logAuditEvent('login_success', { username });
                showApp();
            } else if (username && password) {
                // Allow any username/password for demo
                currentUser = {
                    id: Date.now(),
                    username: username,
                    name: username,
                    role: 'clinician'
                };
                
                logAuditEvent('login_success', { username });
                showApp();
            } else {
                alert('Please enter username and password');
            }
        }

        function clientAccess() {
            const code = document.getElementById('authCode').value.toUpperCase().trim();
            
            if (!code) {
                alert('Please enter an access code');
                return;
            }
            
            const document = documents.find(d => d.authCode === code && d.status === 'pending');
            
            if (document) {
                logAuditEvent('client_access', { code, documentId: document.id });
                showClientPortal(document);
            } else {
                logAuditEvent('client_access_failed', { code });
                alert('Invalid or expired access code');
            }
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.name;
            
            loadData();
            initializeDemoData();
            updateDashboard();
            renderClients();
            renderAppointments();
            renderDocuments();
            renderAuditLog();
        }

        function showClientPortal(document) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('clientPortal').style.display = 'block';
            
            const content = document.getElementById('clientContent');
            content.innerHTML = `
                <h2>${document.type}</h2>
                <p><strong>Client:</strong> ${document.clientName}</p>
                <div class="alert alert-success">
                    <p>Please complete the form below:</p>
                </div>
                <form onsubmit="submitClientDocument(event, ${document.id})">
                    <div class="form-group">
                        <label>I have read and understand the information provided</label>
                        <input type="checkbox" required>
                    </div>
                    <div class="form-group">
                        <label>I consent to treatment</label>
                        <input type="checkbox" required>
                    </div>
                    <div class="form-group">
                        <label>Signature (Type your full name)</label>
                        <input type="text" required placeholder="Your full name">
                    </div>
                    <button type="submit" class="btn">Submit Document</button>
                </form>
            `;
        }

        function submitClientDocument(event, documentId) {
            event.preventDefault();
            
            const doc = documents.find(d => d.id === documentId);
            if (doc) {
                doc.status = 'completed';
                doc.completedAt = new Date().toISOString();
                doc.clientSignature = 'Digital signature provided';
                
                saveData();
                logAuditEvent('document_completed', { documentId, clientId: doc.clientId });
                
                alert('‚úÖ Document submitted successfully!');
                clientLogout();
            }
        }

        function clientLogout() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('clientPortal').style.display = 'none';
            document.getElementById('authCode').value = '';
        }

        function logout() {
            logAuditEvent('logout', { username: currentUser.username });
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('appScreen').style.display = 'none';
        }

        // Navigation
        function showSection(section) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content').forEach(c => c.classList.add('hidden'));
            
            event.target.classList.add('active');
            document.getElementById(section).classList.remove('hidden');
        }

        // Dashboard
        function updateDashboard() {
            document.getElementById('totalClients').textContent = clients.length;
            document.getElementById('upcomingAppointments').textContent = 
                appointments.filter(a => new Date(a.date) >= new Date()).length;
            document.getElementById('pendingDocuments').textContent = 
                documents.filter(d => d.status === 'pending').length;
            document.getElementById('totalRevenue').textContent = 
                '$' + (appointments.length * 150).toFixed(2);
        }

        // Clients
        function renderClients() {
            const container = document.getElementById('clientsList');
            container.innerHTML = clients.map(client => `
                <div class="client-card" onclick="editClient(${client.id})">
                    <h3>${client.name}</h3>
                    <p>üìß ${client.email}</p>
                    <p>üìû ${client.phone}</p>
                    <p>üéÇ ${new Date(client.dob).toLocaleDateString()}</p>
                    <div class="status-badge status-success">Active</div>
                </div>
            `).join('');
        }

        function showAddClient() {
            document.getElementById('addClientModal').classList.add('active');
        }

        function saveClient() {
            const client = {
                id: Date.now(),
                name: document.getElementById('clientName').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                dob: document.getElementById('clientDOB').value,
                notes: document.getElementById('clientNotes').value,
                created: new Date().toISOString()
            };
            
            clients.push(client);
            saveData();
            logAuditEvent('client_created', { clientId: client.id, name: client.name });
            
            closeModal('addClientModal');
            renderClients();
            updateDashboard();
            
            // Clear form
            document.getElementById('clientName').value = '';
            document.getElementById('clientEmail').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientDOB').value = '';
            document.getElementById('clientNotes').value = '';
        }

        // Appointments
        function renderAppointments() {
            const container = document.getElementById('appointmentsList');
            container.innerHTML = appointments.map(apt => `
                <div class="card">
                    <h3>${apt.clientName}</h3>
                    <p>üìÖ ${new Date(apt.date).toLocaleDateString()} at ${apt.time}</p>
                    <p>‚è±Ô∏è ${apt.type}</p>
                    ${apt.notes ? `<p>üìù ${apt.notes}</p>` : ''}
                    <div class="status-badge status-warning">Scheduled</div>
                </div>
            `).join('');
        }

        function showAddAppointment() {
            const select = document.getElementById('appointmentClient');
            select.innerHTML = '<option value="">Select Client</option>' +
                clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            document.getElementById('appointmentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('addAppointmentModal').classList.add('active');
        }

        function saveAppointment() {
            const clientId = document.getElementById('appointmentClient').value;
            const client = clients.find(c => c.id == clientId);
            
            const appointment = {
                id: Date.now(),
                clientId: clientId,
                clientName: client.name,
                date: document.getElementById('appointmentDate').value,
                time: document.getElementById('appointmentTime').value,
                type: document.getElementById('appointmentType').value,
                notes: document.getElementById('appointmentNotes').value,
                created: new Date().toISOString()
            };
            
            appointments.push(appointment);
            saveData();
            logAuditEvent('appointment_created', { appointmentId: appointment.id, clientId: appointment.clientId });
            
            closeModal('addAppointmentModal');
            renderAppointments();
            updateDashboard();
        }

        // Documents
        function renderDocuments() {
            const container = document.getElementById('documentsList');
            const pending = documents.filter(d => d.status === 'pending');
            const completed = documents.filter(d => d.status === 'completed');
            
            container.innerHTML = `
                <div class="card">
                    <h3>‚è≥ Pending (${pending.length})</h3>
                    ${pending.map(d => `
                        <div style="padding: 10px; border-bottom: 1px solid var(--border);">
                            <strong>${d.clientName}</strong> - ${d.type}
                            <br><code style="background: #f8f9fa; padding: 2px 6px; border-radius: 3px;">${d.authCode}</code>
                        </div>
                    `).join('')}
                </div>
                <div class="card">
                    <h3>‚úÖ Completed (${completed.length})</h3>
                    ${completed.map(d => `
                        <div style="padding: 10px; border-bottom: 1px solid var(--border);">
                            <strong>${d.clientName}</strong> - ${d.type}
                            <br><small>Completed: ${new Date(d.completedAt).toLocaleDateString()}</small>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showAssignDocument() {
            const select = document.getElementById('assignClient');
            select.innerHTML = '<option value="">Select Client</option>' +
                clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            document.getElementById('assignDocumentModal').classList.add('active');
        }

        function saveDocumentAssignment() {
            const clientId = document.getElementById('assignClient').value;
            const client = clients.find(c => c.id == clientId);
            const type = document.getElementById('documentType').value;
            
            const authCode = 'DEMO-' + Math.random().toString(36).substr(2, 6).toUpperCase();
            
            const document = {
                id: Date.now(),
                clientId: clientId,
                clientName: client.name,
                type: type,
                authCode: authCode,
                status: 'pending',
                created: new Date().toISOString()
            };
            
            documents.push(document);
            saveData();
            logAuditEvent('document_assigned', { documentId: document.id, clientId: document.clientId, authCode });
            
            closeModal('assignDocumentModal');
            document.getElementById('generatedCode').textContent = authCode;
            document.getElementById('successModal').classList.add('active');
            
            renderDocuments();
            updateDashboard();
        }

        // Audit Log
        function renderAuditLog() {
            const container = document.getElementById('auditList');
            container.innerHTML = auditLog.slice(0, 50).map(log => `
                <div style="padding: 10px; border-bottom: 1px solid var(--border); font-size: 14px;">
                    <strong>${new Date(log.timestamp).toLocaleString()}</strong> - ${log.user}
                    <br>${log.action} ${JSON.stringify(log.details)}
                </div>
            `).join('');
        }

        // Modal functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        // Close modals on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // Close modals when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
    </script>
</body>
</html>
