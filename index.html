<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClinicalSpeak EHR - Enhanced</title>
    <meta name="description" content="HIPAA-compliant clinical documentation platform with modern UI and advanced features">
    <meta name="theme-color" content="#FFE066">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-color: #00a86b;
            --primary-hover: #008f5a;
            --secondary-color: #6c757d;
            --accent-color: #00a86b;
            --background-gradient: #e5e5e5;
            --surface-color: #ffffff;
            --surface-elevated: #ffffff;
            --text-primary: #000000;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --shadow-light: 0 2px 8px rgba(0, 168, 107, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 168, 107, 0.15);
            --shadow-heavy: 0 10px 40px rgba(0, 168, 107, 0.2);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        *:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            line-height: 1.6;
            color: var(--text-primary);
            scroll-behavior: smooth;
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        .auth-container {
            max-width: 450px; 
            margin: 100px auto; 
            background: var(--surface-color); 
            padding: 48px 40px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-heavy);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .auth-container h2 { 
            margin-bottom: 16px; 
            color: var(--primary-color); 
            text-align: center; 
            font-size: 28px;
            font-weight: 600;
        }

        .auth-container .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 14px;
        }

        .auth-tabs { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 32px; 
            background: #f8f9fa;
            padding: 4px;
            border-radius: 8px;
        }

        .auth-tab {
            flex: 1; 
            padding: 12px 16px; 
            border: none; 
            border-radius: 6px;
            background: transparent; 
            cursor: pointer; 
            text-align: center; 
            transition: var(--transition);
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .auth-tab.active { 
            background: var(--surface-color); 
            color: var(--primary-color); 
            box-shadow: var(--shadow-light);
        }

        .auth-tab:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .app-container { 
            display: none; 
            min-height: 100vh; 
            background: #e5e5e5 !important;
            color: #000000 !important;
        }
        .client-portal { display: none; min-height: 100vh; background: var(--surface-color); }
        
        .header {
            background: var(--surface-color); 
            padding: 24px 40px; 
            box-shadow: var(--shadow-light);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 { 
            color: var(--primary-color); 
            font-size: 28px; 
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header .logo {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-menu:hover {
            background: #f8f9fa;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            min-width: 220px;
            z-index: 1000;
            display: none;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .user-menu-dropdown.active {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .user-menu-item:last-child {
            border-bottom: none;
        }

        .user-menu-item:hover {
            background: #f8f9fa;
        }

        .user-menu-item-icon {
            width: 20px;
            height: 20px;
            color: var(--text-secondary);
        }

        .user-menu-item-text {
            flex: 1;
            font-size: 14px;
        }

        .user-menu-item-arrow {
            color: var(--text-secondary);
            font-size: 12px;
        }

        .user-menu-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: #f8f9fa;
        }

        .user-menu-header-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .user-menu-header-email {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .tabs { 
            background: var(--surface-color); 
            display: flex; 
            padding: 0 40px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .tab-btn {
            padding: 16px 24px; 
            border: none; 
            background: none; 
            cursor: pointer;
            font-size: 14px; 
            font-weight: 500; 
            color: var(--text-secondary); 
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
            position: relative;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background: rgba(232, 93, 79, 0.05);
        }

        .tab-btn.active { 
            color: var(--primary-color); 
            border-bottom-color: var(--primary-color);
            background: rgba(232, 93, 79, 0.05);
        }

        .tab-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }
        .content { 
            padding: 40px; 
            max-width: 1400px; 
            margin: 0 auto; 
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content { 
            display: none; 
            animation: slideIn 0.4s ease-out; 
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        .content-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .content-header h2 { 
            color: white; 
            font-size: 32px; 
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-size: 14px; 
            font-weight: 600; 
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .btn-primary { 
            background: var(--primary-color); 
            color: white; 
            box-shadow: var(--shadow-light);
        }

        .btn-primary:hover { 
            background: var(--primary-hover); 
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-icon {
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
        }
        .input {
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid var(--border-color); 
            border-radius: 8px;
            font-size: 14px; 
            margin-bottom: 16px; 
            transition: var(--transition);
            background: var(--surface-color);
            color: var(--text-primary);
        }

        .input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(232, 93, 79, 0.1);
        }

        .input::placeholder {
            color: var(--text-secondary);
        }

        .input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .input-error {
            border-color: #FF6B6B;
        }

        .error-message {
            color: #FF6B6B;
            font-size: 12px;
            margin-top: 4px;
        }

        .card { 
            background: var(--surface-color); 
            padding: 24px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-light); 
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 24px; 
        }

        .client-card {
            background: var(--surface-color); 
            padding: 24px; 
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light); 
            cursor: pointer; 
            transition: var(--transition);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .client-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .client-card:hover { 
            transform: translateY(-4px); 
            box-shadow: var(--shadow-medium);
        }

        .client-card:hover::before {
            transform: scaleY(1);
        }

        .client-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .client-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .client-info {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.6); 
            z-index: 1000; 
            overflow-y: auto;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content { 
            background: var(--surface-color); 
            margin: 0; 
            padding: 32px; 
            border-radius: var(--border-radius); 
            max-width: 600px; 
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            animation: slideUp 0.3s ease-out;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close { 
            background: none;
            border: none;
            font-size: 24px; 
            cursor: pointer; 
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close:hover { 
            color: var(--primary-color);
            background: rgba(232, 93, 79, 0.1);
        }

        .close:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .notification-badge { 
            background: #FF6B6B; 
            color: white; 
            border-radius: 50%; 
            padding: 4px 8px; 
            font-size: 12px; 
            font-weight: 600;
            margin-left: 8px; 
            min-width: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface-color);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-medium);
            border-left: 4px solid var(--primary-color);
            z-index: 1001;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
        }

        .notification.success {
            border-left-color: #27ae60;
        }

        .notification.error {
            border-left-color: #e74c3c;
        }

        .notification.warning {
            border-left-color: #f39c12;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
                flex-direction: column;
                gap: 16px;
            }

            .header h1 {
                font-size: 24px;
            }

            .tabs {
                padding: 0 20px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-btn {
                padding: 12px 16px;
                font-size: 13px;
            }

            .content {
                padding: 20px;
            }

            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .content-header h2 {
                font-size: 24px;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .auth-container {
                margin: 20px;
                padding: 32px 24px;
                max-width: none;
            }

            .modal-content {
                margin: 20px;
                padding: 24px;
                max-height: calc(100vh - 40px);
            }

            .btn {
                padding: 14px 20px;
                font-size: 16px;
            }

            .client-card {
                padding: 20px;
            }

            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 12px 16px;
            }

            .content {
                padding: 16px;
            }

            .auth-container {
                margin: 16px;
                padding: 24px 20px;
            }

            .modal-content {
                margin: 16px;
                padding: 20px;
            }

            .grid {
                gap: 12px;
            }

            .client-card {
                padding: 16px;
            }
        }

        /* Dark mode support */
        /* Dark mode disabled - force light theme */
        @media (prefers-color-scheme: dark) {
            :root {
                --surface-color: #ffffff;
                --surface-elevated: #ffffff;
                --text-primary: #000000;
                --text-secondary: #6c757d;
                --border-color: #e9ecef;
            }

            body {
                background: #e5e5e5;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #000000;
                --text-secondary: #000000;
            }

            .btn {
                border: 2px solid var(--text-primary);
            }

            .card {
                border: 2px solid var(--border-color);
            }
        }

        /* Print styles */
        @media print {
            .header,
            .tabs,
            .btn,
            .modal {
                display: none !important;
            }

            .content {
                padding: 0;
            }

            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                break-inside: avoid;
            }
        }
        .client-portal-content { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
        .document-header {
            background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
            padding: 30px; border-radius: 12px; margin-bottom: 30px; text-align: center; border: 1px solid #FFE066;
        }
        .document-header h1 { color: #FFE066; margin-bottom: 10px; }
        .form-section { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(232, 93, 79, 0.1); margin-bottom: 20px; }
        .form-field { margin-bottom: 20px; }
        .form-field label { display: block; font-weight: 500; margin-bottom: 8px; color: #FFE066; }
        .form-field input, .form-field textarea, .form-field select {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;
        }
        .form-field textarea { min-height: 100px; resize: vertical; }
        .signature-pad {
            border: 2px dashed #FFE066; border-radius: 8px; padding: 20px; text-align: center; margin: 20px 0; background: #FFF8E1;
        }
        .signature-input {
            width: 100%; padding: 15px; border: 2px solid #FFE066; border-radius: 6px;
            font-family: 'Brush Script MT', cursive; font-size: 24px; text-align: center;
        }
        .submit-section { background: #FFF8E1; padding: 30px; border-radius: 8px; text-align: center; margin-top: 30px; }
        .search-input {
            flex: 1; padding: 12px; border: 2px solid white; border-radius: 6px; font-size: 14px; background: white; margin-bottom: 20px;
        }
        .doc-nav { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding: 10px 0; }
        .doc-nav-item {
            padding: 10px 20px; background: white; border: 2px solid #FFE066; border-radius: 6px;
            cursor: pointer; white-space: nowrap; transition: all 0.3s;
        }
        .doc-nav-item.active { background: #FFE066; color: white; }
        .doc-nav-item.completed { background: #27ae60; border-color: #27ae60; color: white; }
        
        /* New Features Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(232, 93, 79, 0.1);
            text-align: center;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card h3 {
            color: #FFE066;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(232, 93, 79, 0.1);
        }
        .chart-card h3 {
            color: #FFE066;
            margin-bottom: 20px;
        }
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .calendar-view-toggle {
            display: flex;
            gap: 5px;
        }
        .calendar-view-toggle .btn-sm {
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 6px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        .calendar-view-toggle .btn-sm.active,
        .calendar-view-toggle .btn-sm:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .calendar-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(232, 93, 79, 0.1);
            margin-bottom: 20px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .calendar-day {
            background: white;
            padding: 15px 10px;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            color: #000000;
        }
        .calendar-day:hover {
            background: #FFF8E1;
        }
        .calendar-day.other-month {
            color: #ccc;
        }
        .calendar-day.today {
            background: #FFF8E1;
            font-weight: bold;
        }
        .calendar-day.has-appointment {
            background: #E8F5E8;
            border-left: 4px solid #27ae60;
        }
        .appointment-dot {
            width: 8px;
            height: 8px;
            background: #FFE066;
            border-radius: 50%;
            margin: 2px auto;
        }
        
        .appointment-widgets {
            position: absolute;
            top: 25px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }
        
        .appointment-widget {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 2px 4px;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2px;
            overflow: hidden;
            max-height: 25px;
        }
        
        .appointment-widget.expanded {
            max-height: 120px;
            padding: 4px 6px;
            z-index: 10;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .appointment-widget:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
            transform: scale(1.02);
        }
        
        .widget-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .widget-expanded {
            margin-top: 4px;
            border-top: 1px solid #e9ecef;
            padding-top: 4px;
        }
        
        .expanded-info {
            font-size: 9px;
            color: #000000;
            line-height: 1.2;
        }
        
        .client-name {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .appointment-type {
            color: #666;
            margin-bottom: 1px;
        }
        
        .appointment-duration {
            color: #666;
            margin-bottom: 1px;
        }
        
        .appointment-notes {
            color: #888;
            font-style: italic;
            margin-top: 2px;
            max-height: 20px;
            overflow: hidden;
        }
        
        .widget-actions {
            display: flex;
            gap: 2px;
            margin-top: 4px;
        }
        
        .btn-widget-edit, .btn-widget-delete {
            padding: 1px 4px;
            font-size: 8px;
            border: none;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-widget-edit {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .btn-widget-edit:hover {
            background: #bbdefb;
        }
        
        .btn-widget-delete {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .btn-widget-delete:hover {
            background: #ffcdd2;
        }
        
        .widget-time {
            color: #000000;
            font-weight: bold;
            font-size: 9px;
            line-height: 1;
        }
        
        .widget-initials {
            display: flex;
            gap: 2px;
            margin-top: 1px;
        }
        
        .client-initial, .clinician-initial {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            color: #000000;
        }
        
        .client-initial {
            background: #e3f2fd;
            border: 1px solid #2196f3;
        }
        
        .clinician-initial {
            background: #f3e5f5;
            border: 1px solid #9c27b0;
        }
        
        /* Appointment Detail Panel */
        .appointment-detail-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--surface-color);
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: right 0.3s ease-in-out;
            overflow-y: auto;
            border-left: 1px solid var(--border-color);
        }
        
        .appointment-detail-panel.active {
            right: 0;
        }
        
        .appointment-detail-header {
            background: var(--primary-color);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .appointment-detail-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        
        .appointment-detail-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .appointment-detail-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .appointment-detail-content {
            padding: 20px;
        }
        
        .detail-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-section:last-child {
            border-bottom: none;
        }
        
        .detail-section h3 {
            margin: 0 0 12px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 100px;
            font-size: 13px;
        }
        
        .detail-value {
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .status-badge.scheduled {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status-badge.confirmed {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .status-badge.completed {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .status-badge.cancelled {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .detail-notes {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
            white-space: pre-wrap;
        }
        
        .appointment-detail-actions {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }
        
        .appointment-detail-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-detail-edit {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-detail-edit:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 168, 107, 0.2);
        }
        
        .btn-detail-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-detail-delete:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(220, 53, 69, 0.2);
        }
        
        /* Clinical Notes Styling */
        .clinical-notes-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .clinical-notes-textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            line-height: 1.6;
            resize: vertical;
            transition: border-color 0.2s;
        }
        
        .clinical-notes-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 168, 107, 0.1);
        }
        
        .clinical-notes-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-ai-note, .btn-save-note {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-ai-note {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-ai-note:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-save-note {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-save-note:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 168, 107, 0.3);
        }
        
        .btn-sign-note {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }
        
        .btn-sign-note:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        /* Session History Styling */
        .session-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            transition: box-shadow 0.2s;
        }
        
        .session-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .session-header:hover {
            background: #f8f9fa;
        }
        
        .session-info {
            flex: 1;
        }
        
        .session-info h4 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .session-type {
            color: var(--text-secondary);
            font-size: 14px;
            margin: 4px 0;
        }
        
        .session-summary {
            color: var(--text-secondary);
            font-size: 13px;
            margin: 8px 0 0 0;
            line-height: 1.5;
        }
        
        .session-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .session-toggle {
            color: var(--primary-color);
            font-size: 18px;
            font-weight: bold;
        }
        
        .session-details {
            padding: 0 16px 16px 16px;
            background: #f8f9fa;
        }
        
        .session-detail-section {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        .session-detail-section h5 {
            margin: 0 0 12px 0;
            color: var(--primary-color);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .clinical-notes-display {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid var(--primary-color);
        }
        
        .clinical-notes-display pre {
            white-space: pre-wrap;
            font-family: inherit;
            font-size: 13px;
            line-height: 1.6;
            margin: 0;
            color: var(--text-primary);
        }
        
        .signature-display {
            background: #e8f5e9;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid #4caf50;
        }
        
        .signature-row {
            display: flex;
            margin-bottom: 8px;
        }
        
        .signature-row:last-child {
            margin-bottom: 0;
        }
        
        .signature-row .detail-label {
            font-weight: 600;
            color: #2e7d32;
            min-width: 80px;
        }
        
        .signature-row .detail-value {
            color: #1b5e20;
        }
        
        .calendar-header {
            background: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            color: #666;
        }
        .day-number {
            font-weight: bold;
            margin-bottom: 5px;
            color: #000000;
        }
        .more-appointments {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 2px;
        }
        
        /* Week View Styles */
        .week-calendar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 168, 107, 0.1);
        }
        .week-grid {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            gap: 1px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }
        .time-column {
            background: #f8f9fa;
        }
        .time-header {
            padding: 15px 10px;
            font-weight: bold;
            text-align: center;
            background: var(--primary-color);
            color: white;
        }
        .time-slot {
            padding: 8px;
            text-align: center;
            font-size: 12px;
            border-bottom: 1px solid #e9ecef;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .time-slot:hover {
            background: #f8f9fa;
        }
        .day-column {
            background: white;
        }
        .day-header {
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            background: var(--primary-color);
            color: white;
            border-bottom: 1px solid #e9ecef;
        }
        .time-slot.has-appointment {
            background: #E8F5E8;
            cursor: pointer;
        }
        .appointment-block {
            background: var(--primary-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            text-align: center;
        }
        
        /* Day View Styles */
        .day-view {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 168, 107, 0.1);
        }
        .day-appointments {
            margin-bottom: 20px;
        }
        .day-appointment {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .day-appointment:hover {
            background: #f8f9fa;
            border-color: var(--primary-color);
        }
        .appointment-time {
            font-weight: bold;
            color: var(--primary-color);
            min-width: 80px;
            margin-right: 15px;
        }
        .appointment-details {
            flex: 1;
        }
        .client-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .appointment-notes {
            color: #666;
            font-size: 14px;
        }
        .appointment-duration {
            color: #666;
            font-size: 14px;
        }
        .no-appointments {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }
        .day-actions {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        /* Drag and Drop Styles */
        .calendar-day[draggable="true"] {
            cursor: grab;
        }
        .calendar-day[draggable="true"]:active {
            cursor: grabbing;
        }
        .drag-over {
            background: #E8F5E8 !important;
            border: 2px dashed var(--primary-color) !important;
        }
        
        /* Enhanced Analytics Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 168, 107, 0.1);
            border: 1px solid #e9ecef;
        }
        .stat-card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 16px;
        }
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
        }
        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }
        .stat-value {
            color: var(--primary-color);
            font-weight: bold;
            font-size: 14px;
        }
        .charts-section {
            margin-top: 30px;
        }
        .chart-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 168, 107, 0.1);
            border: 1px solid #e9ecef;
        }
        .chart-card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 16px;
        }
        .chart-container {
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
        }
        .export-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 168, 107, 0.1);
            border: 1px solid #e9ecef;
            margin-top: 20px;
        }
        .export-section h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .appointments-list {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(232, 93, 79, 0.1);
        }
        .appointment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        .appointment-item:hover {
            background: #FFF8E1;
            transform: translateX(5px);
        }
        .appointment-info h4 {
            color: #FFE066;
            margin-bottom: 5px;
        }
        .appointment-info p {
            color: #666;
            font-size: 14px;
        }
        .appointment-actions {
            display: flex;
            gap: 10px;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* Client Chart Styles */
        .client-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            overflow-x: auto;
        }
        .chart-tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .chart-tab-btn:hover {
            color: var(--primary-color);
        }
        .chart-tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .chart-tab-content {
            display: none;
        }
        .chart-tab-content.active {
            display: block;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn-danger {
            background: #FF6B6B;
            color: white;
        }
        .invoices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        .invoice-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(232, 93, 79, 0.1);
            transition: transform 0.3s;
        }
        .invoice-card:hover {
            transform: translateY(-5px);
        }
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .invoice-number {
            font-weight: bold;
            color: #FFE066;
        }
        .invoice-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .invoice-status.pending {
            background: #FFF3CD;
            color: #856404;
        }
        .invoice-status.paid {
            background: #D4EDDA;
            color: #155724;
        }
        .invoice-status.overdue {
            background: #F8D7DA;
            color: #721C24;
        }
        .invoice-amount {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        .invoice-details {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .invoice-actions {
            display: flex;
            gap: 10px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Report Styles */
        .report-section {
            margin-bottom: 30px;
        }

        .report-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .stat-card h5 {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        .report-table th,
        .report-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .report-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .report-table tr:hover {
            background: rgba(255, 224, 102, 0.05);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.active {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .status-breakdown {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .status-count {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 18px;
        }

        /* Notification Styles */
        .notification-settings {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 224, 102, 0.05);
            border-radius: var(--border-radius);
        }

        .notification-settings h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .setting-item {
            margin-bottom: 12px;
        }

        .setting-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        .setting-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .notification-item {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            position: relative;
        }

        .notification-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .notification-item.unread {
            border-left: 4px solid var(--primary-color);
            background: rgba(255, 224, 102, 0.05);
        }

        .notification-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .notification-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .notification-message {
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.4;
        }

        .notification-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        .notification-actions button {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-actions .mark-read {
            background: var(--primary-color);
            color: white;
        }

        .notification-actions .delete {
            background: #FF6B6B;
            color: white;
        }

        .notification-actions button:hover {
            opacity: 0.8;
        }

        .notification-badge {
            background: #FF6B6B;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #E85D4F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .services-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        .service-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .invoice-total {
            text-align: center;
            padding: 20px;
            background: #FFF8E1;
            border-radius: 8px;
            margin: 20px 0;
        }
        .invoice-total h3 {
            color: #FFE066;
            font-size: 28px;
        }
        .invoice-filters {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="auth-container" id="authContainer">
        <h2> ClinicalSpeak EHR</h2>
        <p class="subtitle">HIPAA-compliant clinical documentation platform</p>
        
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchAuthTab('clinician')" role="tab" aria-selected="true"> Clinician</div>
            <div class="auth-tab" onclick="switchAuthTab('client')" role="tab" aria-selected="false"> Client</div>
        </div>

        <div id="clinicianAuth" class="auth-form active" role="tabpanel">
            <div style="text-align: center; padding: 20px;">
                <h3 style="margin-bottom: 30px; color: var(--text-primary);">Ready to access your EHR?</h3>
                <button onclick="simpleLogin()" class="btn btn-primary" style="width: 200px; height: 50px; font-size: 18px; background: #3498db; border: none; border-radius: 8px; color: white; cursor: pointer;">
                     Login to EHR
                </button>
                <p style="margin-top: 20px; color: #666; font-size: 14px;">Click to access the ClinicalSpeak platform</p>
            </div>
            
            <p style="margin-top: 20px; font-size: 12px; color: var(--text-secondary); text-align: center;">
                Demo: admin / admin123
            </p>
        </div>

        <div id="clientAuth" class="auth-form" role="tabpanel">
            <div class="input-group">
                <label for="authCode" class="input-label">Authentication Code</label>
                <input type="text" id="authCode" placeholder="Enter your access code" class="input" style="text-transform: uppercase;" aria-describedby="authcode-help">
                <div id="authcode-help" class="error-message" style="display: none;"></div>
            </div>
            
            <button onclick="accessDocument()" class="btn btn-primary" style="width: 100%;">
                <span>Access Document</span>
                <div class="loading-spinner" style="display: none;"></div>
            </button>
            
            <p style="margin-top: 20px; font-size: 12px; color: var(--text-secondary); text-align: center;">
                Enter the code provided by your clinician
            </p>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="header">
            <h1>
                <div class="logo">CS</div>
                ClinicalSpeak EHR
            </h1>
            <div class="header-actions">
                <div class="user-menu" onclick="toggleUserMenu()" tabindex="0" role="button" aria-label="User menu">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">Admin</span>
                    <span style="font-size: 12px; color: var(--text-secondary);"></span>
                    
                    <!-- User Menu Dropdown -->
                    <div class="user-menu-dropdown" id="userMenuDropdown">
                        <div class="user-menu-header">
                            <div class="user-menu-header-name" id="dropdownUserName">Admin User</div>
                            <div class="user-menu-header-email" id="dropdownUserEmail">admin@clinicalspeak.com</div>
                        </div>
                        <div class="user-menu-item" onclick="openProfileModal()">
                            <svg class="user-menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                            </svg>
                            <span class="user-menu-item-text">Profile</span>
                            <span class="user-menu-item-arrow"></span>
                        </div>
                        <div class="user-menu-item" onclick="openSettingsModal()">
                            <svg class="user-menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span class="user-menu-item-text">Settings</span>
                            <span class="user-menu-item-arrow"></span>
                        </div>
                        <div class="user-menu-item" onclick="openAccountModal()">
                            <svg class="user-menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                            <span class="user-menu-item-text">Account</span>
                            <span class="user-menu-item-arrow"></span>
                        </div>
                        <div class="user-menu-item" onclick="logout()">
                            <svg class="user-menu-item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                            <span class="user-menu-item-text">Logout</span>
                        </div>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-icon" aria-label="Logout" style="display: none;">
                    <span></span>
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')"> Dashboard</button>
            <button class="tab-btn" onclick="showTab('clients')"> Clients</button>
            <button class="tab-btn" onclick="showTab('appointments')"> Appointments</button>
            <button class="tab-btn" onclick="showTab('documents')"> Documents <span class="notification-badge" id="docBadge" style="display: none;">0</span></button>
            <button class="tab-btn" onclick="showTab('invoices')"> Invoices</button>
            <button class="tab-btn" onclick="showTab('audit')"> Audit Log</button>
            <button class="tab-btn" onclick="showTab('reports')"> Reports</button>
            <button class="tab-btn" onclick="showTab('notifications')"> Notifications <span class="notification-badge" id="notifBadge" style="display: none;">0</span></button>
        </div>

        <div class="content">
            <div id="dashboardContent" class="tab-content" style="display: block;">
                <div class="content-header">
                    <h2> Analytics Dashboard</h2>
                    <div>
                        <select id="timeframeSelect" class="input" style="width: auto; margin-right: 10px;" onchange="loadAnalytics()">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="365">Last year</option>
                        </select>
                        <button onclick="loadAnalytics()" class="btn btn-primary">Refresh</button>
                    </div>
                </div>
                <div id="analyticsContent">
                    <div class="analytics-grid">
                        <div class="stat-card">
                            <h3> Total Clients</h3>
                            <div class="stat-number" id="totalClients">-</div>
                        </div>
                        <div class="stat-card">
                            <h3> Upcoming Appointments</h3>
                            <div class="stat-number" id="upcomingAppointments">-</div>
                        </div>
                        <div class="stat-card">
                            <h3> Pending Documents</h3>
                            <div class="stat-number" id="pendingDocuments">-</div>
                        </div>
                        <div class="stat-card">
                            <h3> Total Revenue</h3>
                            <div class="stat-number" id="totalRevenue">$-</div>
                        </div>
                    </div>
                    <div class="charts-container">
                        <div class="chart-card">
                            <h3> Monthly Trends</h3>
                            <div id="monthlyChart"></div>
                        </div>
                        <div class="chart-card">
                            <h3> Top Clients</h3>
                            <div id="topClientsList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="clientsContent" class="tab-content">
                <div class="content-header">
                    <h2> Clients</h2>
                    <button onclick="openNewClient()" class="btn btn-primary">+ New Client</button>
                </div>
                <input type="text" id="clientSearchInput" class="search-input" placeholder=" Search clients..." oninput="filterClients()">
                <div id="clientsList" class="grid"></div>
            </div>

            <div id="appointmentsContent" class="tab-content">
                <div class="content-header">
                    <h2> Appointments</h2>
                    <button onclick="openNewAppointment()" class="btn btn-primary">+ New Appointment</button>
                </div>
                <div class="calendar-controls">
                    <button onclick="previousMonth()" class="btn"> Previous</button>
                    <h3 id="currentMonth">Current Month</h3>
                    <button onclick="nextMonth()" class="btn">Next </button>
                    <div class="calendar-view-toggle">
                        <button id="monthViewBtn" onclick="setCalendarView('month')" class="btn btn-sm active">Month</button>
                        <button id="weekViewBtn" onclick="setCalendarView('week')" class="btn btn-sm">Week</button>
                        <button id="dayViewBtn" onclick="setCalendarView('day')" class="btn btn-sm">Day</button>
                    </div>
                </div>
                <div id="calendarView" class="calendar-container"></div>
                <div id="appointmentsList" class="appointments-list"></div>
                
                <!-- Appointment Detail Panel -->
                <div id="appointmentDetailPanel" class="appointment-detail-panel">
                    <div class="appointment-detail-header">
                        <h2>Appointment Details</h2>
                        <button class="appointment-detail-close" onclick="closeAppointmentDetail()" aria-label="Close"></button>
                    </div>
                    
                    <div class="appointment-detail-content">
                        <!-- Client Information Section -->
                        <div class="detail-section">
                            <h3>Client Information</h3>
                            <div class="detail-row">
                                <span class="detail-label">Name:</span>
                                <span class="detail-value" id="detailClientName">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Email:</span>
                                <span class="detail-value" id="detailClientEmail">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Phone:</span>
                                <span class="detail-value" id="detailClientPhone">-</span>
                            </div>
                        </div>
                        
                        <!-- Appointment Details Section -->
                        <div class="detail-section">
                            <h3>Appointment Details</h3>
                            <div class="detail-row">
                                <span class="detail-label">Date:</span>
                                <span class="detail-value" id="detailDate">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Time:</span>
                                <span class="detail-value" id="detailTime">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Duration:</span>
                                <span class="detail-value" id="detailDuration">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Type:</span>
                                <span class="detail-value" id="detailType">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Location:</span>
                                <span class="detail-value" id="detailLocation">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span class="detail-value">
                                    <span class="status-badge" id="detailStatus">-</span>
                                </span>
                            </div>
                            <!-- TODO: Add Stripe integration fields -->
                            <!-- <div class="detail-row">
                                <span class="detail-label">Service:</span>
                                <span class="detail-value" id="detailService">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Price:</span>
                                <span class="detail-value" id="detailPrice">-</span>
                            </div> -->
                        </div>
                        
                        <!-- Notes Section -->
                        <div class="detail-section">
                            <h3>Notes</h3>
                            <div class="detail-notes" id="detailNotes">No notes available</div>
                        </div>
                        
                        <!-- Clinical Notes Section -->
                        <div class="detail-section">
                            <h3>Clinical Notes</h3>
                            <div class="clinical-notes-container">
                                <textarea id="detailClinicalNotes" class="clinical-notes-textarea" placeholder="Enter clinical notes here..."></textarea>
                                <div class="clinical-notes-actions">
                                    <button class="btn-ai-note" onclick="generateAINote()">
                                         AI Note Taker
                                    </button>
                                    <button class="btn-save-note" onclick="saveClinicalNote()">
                                         Save Note
                                    </button>
                                    <button class="btn-sign-note" onclick="signClinicalNote()">
                                         Sign & Lock Note
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="appointment-detail-actions">
                        <button class="btn-detail-edit" onclick="editAppointmentFromDetail()">
                             Edit Appointment
                        </button>
                        <button class="btn-detail-delete" onclick="deleteAppointmentFromDetail()">
                             Delete
                        </button>
                    </div>
                </div>
            </div>

            <div id="documentsContent" class="tab-content">
                <div class="content-header">
                    <h2> Documents</h2>
                    <button onclick="openAssignDoc()" class="btn btn-primary">+ Assign Document</button>
                </div>
                <div id="docsList"></div>
            </div>

            <div id="invoicesContent" class="tab-content">
                <div class="content-header">
                    <h2> Invoices</h2>
                    <button onclick="openNewInvoice()" class="btn btn-primary">+ New Invoice</button>
                </div>
                <div class="invoice-filters">
                    <select id="invoiceStatusFilter" class="input" style="width: auto;" onchange="filterInvoices()">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
                <div id="invoicesList" class="invoices-grid"></div>
            </div>

            <div id="auditContent" class="tab-content">
                <div class="content-header">
                    <h2> Audit Log</h2>
                </div>
                <div id="auditList"></div>
            </div>

            <div id="reportsContent" class="tab-content">
                <div class="content-header">
                    <h2> Reports & Analytics</h2>
                    <div>
                        <select id="reportType" class="input" style="width: auto; margin-right: 10px;" onchange="generateReport()">
                            <option value="client-summary">Client Summary</option>
                            <option value="appointment-trends">Appointment Trends</option>
                            <option value="revenue-report">Revenue Report</option>
                            <option value="document-completion">Document Completion</option>
                        </select>
                        <button class="btn" onclick="exportReport()"> Export PDF</button>
                    </div>
                </div>
                <div id="reportContent">
                    <div class="card">
                        <h3> Report Generator</h3>
                        <p>Select a report type above to generate detailed analytics and insights for your practice.</p>
                        <div class="report-preview" style="display: none;">
                            <div class="report-header">
                                <h4 id="reportTitle"></h4>
                                <p id="reportDate"></p>
                            </div>
                            <div id="reportData"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="notificationsContent" class="tab-content">
                <div class="content-header">
                    <h2> Notifications Center</h2>
                    <div>
                        <button class="btn" onclick="markAllAsRead()"> Mark All Read</button>
                        <button class="btn" onclick="clearAllNotifications()"> Clear All</button>
                    </div>
                </div>
                <div id="notificationsList">
                    <div class="card">
                        <h3> Real-time Notifications</h3>
                        <p>Stay updated with important events in your practice.</p>
                        <div class="notification-settings">
                            <h4> Notification Settings</h4>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="emailNotifications" checked>
                                    Email notifications for new appointments
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="docNotifications" checked>
                                    Notifications for completed documents
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="paymentNotifications" checked>
                                    Payment reminders and updates
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="systemNotifications" checked>
                                    System updates and maintenance alerts
                                </label>
                            </div>
                        </div>
                    </div>
                    <div id="notificationsContainer">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="client-portal" id="clientPortal">
        <div class="header">
            <h1> ClinicalSpeak</h1>
            <button onclick="clientLogout()" class="btn">Exit</button>
        </div>
        <div class="client-portal-content" id="clientPortalContent"></div>
    </div>

    <!-- Modals -->
    <div id="newClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newClientModal')">&times;</span>
            <h2>New Client</h2>
            <input type="text" id="clientName" placeholder="Full Name" class="input">
            <input type="email" id="clientEmail" placeholder="Email" class="input">
            <input type="tel" id="clientPhone" placeholder="Phone" class="input">
            <input type="date" id="clientDOB" class="input">
            <textarea id="clientNotes" placeholder="Notes" class="input"></textarea>
            <button onclick="saveClient()" class="btn btn-primary">Save Client</button>
        </div>
    </div>

    <div id="editClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editClientModal')">&times;</span>
            <h2>Edit Client</h2>
            <input type="hidden" id="editClientId">
            <input type="text" id="editClientName" placeholder="Full Name" class="input">
            <input type="email" id="editClientEmail" placeholder="Email" class="input">
            <input type="tel" id="editClientPhone" placeholder="Phone" class="input">
            <input type="date" id="editClientDOB" class="input">
            <textarea id="editClientNotes" placeholder="Notes" class="input"></textarea>
            <button onclick="updateClient()" class="btn btn-primary">Update Client</button>
        </div>
    </div>

    <div id="assignDocModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assignDocModal')">&times;</span>
            <h2>Assign Documents</h2>
            
            <!-- Assignment Mode Toggle -->
            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="radio" name="assignMode" value="single" checked onchange="toggleAssignMode()">
                    Single Client
                </label>
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="radio" name="assignMode" value="bulk" onchange="toggleAssignMode()">
                    Bulk Assignment
                </label>
            </div>
            
            <!-- Single Client Assignment -->
            <div id="singleClientSection">
            <select id="assignClient" class="input"><option value="">Select Client</option></select>
            </div>
            
            <!-- Bulk Client Assignment -->
            <div id="bulkClientSection" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 500;">Select Clients (check multiple):</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <button onclick="selectAllClients()" class="btn btn-sm">Select All Clients</button>
                        <button onclick="deselectAllClients()" class="btn btn-sm">Clear All</button>
                    </div>
                    <div id="clientCheckboxContainer" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 6px; background: #f8f9fa;"></div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 500;">Expiration Days:</label>
                    <input type="number" id="expirationDays" value="30" min="1" max="365" class="input" style="width: 100px;">
                </div>
            </div>
            
            <!-- Document Selection -->
            <div style="margin: 20px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <p style="font-weight: 500;">Select Documents (check multiple):</p>
                    <div>
                        <button onclick="selectAllDocs()" class="btn" style="font-size: 12px; padding: 5px 10px; margin-right: 5px;">Select All</button>
                        <button onclick="deselectAllDocs()" class="btn" style="font-size: 12px; padding: 5px 10px;">Clear All</button>
                    </div>
                </div>
                <div id="templateCheckboxContainer" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 6px; background: #f8f9fa;"></div>
                <p id="selectedCount" style="margin-top: 10px; font-size: 14px; color: #E85D4F; font-weight: 500;"></p>
            </div>
            
            <div style="display: flex; gap: 10px;">
            <button onclick="saveAssignDoc()" class="btn btn-primary">Assign Documents</button>
                <button onclick="openBulkAssignModal()" class="btn btn-secondary" id="bulkAssignBtn" style="display: none;">Bulk Assign</button>
            </div>
        </div>
    </div>

    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('successModal')">&times;</span>
            <h2> Documents Assigned!</h2>
            <div style="background: #FFE5E0; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3 style="color: #E85D4F;">Authentication Code:</h3>
                <div id="generatedCode" style="font-family: monospace; font-size: 24px; font-weight: bold; text-align: center; padding: 15px; background: white; border-radius: 6px; margin: 10px 0;"></div>
                <p style="font-size: 14px; color: #666; margin-top: 15px;">Share this code with your client.</p>
                <div id="assignedDocsList" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #F4A261;"></div>
            </div>
            <button onclick="closeModal('successModal')" class="btn btn-primary">Done</button>
        </div>
    </div>

    <!-- New Appointment Modal -->
    <div id="newAppointmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newAppointmentModal')">&times;</span>
            <h2> New Appointment</h2>
            <select id="appointmentClient" class="input">
                <option value="">Select Client</option>
            </select>
            <input type="date" id="appointmentDate" class="input">
            <input type="time" id="appointmentTime" class="input">
            <select id="appointmentType" class="input">
                <option value="">Select Type</option>
                <option value="90791">Psychiatric Diagnostic Evaluation (90791) - $200</option>
                <option value="90834">Psychotherapy 45 min (90834) - $150</option>
                <option value="90837">Psychotherapy 60 min (90837) - $180</option>
                <option value="90847">Family Psychotherapy (90847) - $200</option>
                <option value="90853">Group Psychotherapy (90853) - $75</option>
            </select>
            <input type="number" id="appointmentDuration" placeholder="Duration (minutes)" class="input" value="60">
            <textarea id="appointmentNotes" placeholder="Notes" class="input"></textarea>
            
            <!-- TODO: Stripe Integration - Uncomment when implementing payment processing -->
            <!-- <div style="border-top: 1px solid #e9ecef; padding-top: 16px; margin-top: 16px;">
                <h3 style="margin-bottom: 12px; font-size: 14px; color: var(--primary-color);">Billing Information</h3>
                <input type="text" id="appointmentService" placeholder="Service Name" class="input">
                <input type="number" id="appointmentPrice" placeholder="Price ($)" class="input" step="0.01">
                <select id="appointmentPaymentStatus" class="input">
                    <option value="pending">Payment Pending</option>
                    <option value="paid">Paid</option>
                    <option value="insurance">Insurance</option>
                </select>
            </div> -->
            
            <button onclick="saveAppointment()" class="btn btn-primary">Save Appointment</button>
        </div>
    </div>

    <!-- New Invoice Modal -->
    <div id="newInvoiceModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('newInvoiceModal')">&times;</span>
            <h2> New Invoice</h2>
            <select id="invoiceClient" class="input">
                <option value="">Select Client</option>
            </select>
            <input type="date" id="invoiceDueDate" class="input">
            <textarea id="invoiceNotes" placeholder="Additional Notes" class="input"></textarea>
            
            <h3>Services</h3>
            <div id="servicesList" class="services-container">
                <div class="service-item">
                    <input type="text" placeholder="Service Description" class="input service-desc">
                    <select class="input service-cpt">
                        <option value="">CPT Code</option>
                        <option value="90791">90791 - Psychiatric Diagnostic Evaluation</option>
                        <option value="90834">90834 - Psychotherapy 45 min</option>
                        <option value="90837">90837 - Psychotherapy 60 min</option>
                        <option value="90847">90847 - Family Psychotherapy</option>
                        <option value="90853">90853 - Group Psychotherapy</option>
                    </select>
                    <input type="number" placeholder="Amount" class="input service-amount" step="0.01">
                    <button onclick="removeService(this)" class="btn btn-danger btn-small">Remove</button>
                </div>
            </div>
            <button onclick="addService()" class="btn">+ Add Service</button>
            
            <div class="invoice-total">
                <h3>Total: $<span id="invoiceTotal">0.00</span></h3>
            </div>
            
            <button onclick="saveInvoice()" class="btn btn-primary">Create Invoice</button>
        </div>
    </div>

    <!-- Client Chart Modal -->
    <div id="clientChartModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('clientChartModal')">&times;</span>
            <div class="client-chart-header">
                <div>
                    <h2 id="chartClientName">Client Chart</h2>
                    <p id="chartClientInfo" style="color: #666; font-size: 14px;"></p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="scheduleFromChart()" class="btn btn-primary btn-small"> Schedule</button>
                    <button onclick="assignDocFromChart()" class="btn btn-primary btn-small"> Assign Doc</button>
                    <button onclick="createInvoiceFromChart()" class="btn btn-primary btn-small"> Invoice</button>
                    <button onclick="openEditClientFromChart()" class="btn btn-small"> Edit</button>
                </div>
            </div>
            
            <div class="chart-tabs">
                <button class="chart-tab-btn active" onclick="showChartTab('overview')"> Overview</button>
                <button class="chart-tab-btn" onclick="showChartTab('appointments')"> Appointments</button>
                <button class="chart-tab-btn" onclick="showChartTab('documents')"> Documents</button>
                <button class="chart-tab-btn" onclick="showChartTab('invoices')"> Invoices</button>
                <button class="chart-tab-btn" onclick="showChartTab('notes')"> Notes</button>
            </div>
            
            <div id="chartOverviewTab" class="chart-tab-content active">
                <div class="analytics-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <h3>Total Appointments</h3>
                        <div class="stat-number" id="chartTotalAppts">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Completed Sessions</h3>
                        <div class="stat-number" id="chartCompletedAppts">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Documents</h3>
                        <div class="stat-number" id="chartPendingDocs">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Billed</h3>
                        <div class="stat-number" id="chartTotalBilled">$0</div>
                    </div>
                </div>
                <div id="chartOverviewContent"></div>
            </div>
            
            <div id="chartAppointmentsTab" class="chart-tab-content">
                <div id="clientAppointmentsList" class="appointments-list" style="margin-top: 20px;"></div>
            </div>
            
            <div id="chartDocumentsTab" class="chart-tab-content">
                <div id="chartDocumentsContent" style="margin-top: 20px;"></div>
            </div>
            
            <div id="chartInvoicesTab" class="chart-tab-content">
                <div id="chartInvoicesContent" style="margin-top: 20px;"></div>
            </div>
            
            <div id="chartNotesTab" class="chart-tab-content">
                <div id="chartNotesContent" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

<script>
// Client-side localStorage implementation - no API calls needed
let authToken = null;
let currentUser = null;
let clients = [];
let assignedDocs = [];
let currentDocuments = [];
let currentDocIndex = 0;
let documentTemplates = {};
let templateNames = {};
let currentChartClient = null;

// Stripe Configuration
// Use your Stripe publishable key from Vercel environment
const stripe = Stripe('pk_test_51SJ5QBKfOEPgyMAooTwIKAxHZK2cCaPuJSXWlLE2LHCRYFJMOYEVA2UF7TbJi6RScA3vaFv5QIWkfgVzrwmuA5s200PbzGr863');
let clientCalendarDate = new Date();
let clientAppointments = [];
let clientInvoices = [];
let clientDocs = [];

// Simple login function - defined early to be globally available
function simpleLogin() {
    try {
        // Simple one-click login - no credentials needed
        authToken = 'demo-token-' + Date.now();
        currentUser = { 
            name: 'Demo User',
            email: 'demo@clinicalspeak.com',
            role: 'admin',
            loginMethod: 'simple'
        };
        
        saveToStorage('auth_token', authToken);
        saveToStorage('current_user', currentUser);
        
        logLocalAudit('login', { method: 'simple' });
        showApp();
        
        console.log(' Simple login successful!');
        
    } catch (error) {
        console.error('Login error:', error);
        alert('Login failed: ' + error.message);
    }
}

// localStorage management functions
function getStorageKey(key) {
    return `clinicalspeak_${key}`;
}

function saveToStorage(key, data) {
    try {
        localStorage.setItem(getStorageKey(key), JSON.stringify(data));
        // Log audit event for HIPAA compliance
        logLocalAudit('data_save', { key, dataCount: Array.isArray(data) ? data.length : 1 });
    } catch (error) {
        console.error('Failed to save to localStorage:', error);
    }
}

function loadFromStorage(key, defaultValue = null) {
    try {
        const data = localStorage.getItem(getStorageKey(key));
        return data ? JSON.parse(data) : defaultValue;
    } catch (error) {
        console.error('Failed to load from localStorage:', error);
        return defaultValue;
    }
}

function logLocalAudit(action, details = {}) {
    const auditLogs = loadFromStorage('audit_logs', []);
    const logEntry = {
        id: Date.now() + Math.random(),
        timestamp: new Date().toISOString(),
        action,
        details,
        user_name: currentUser?.name || 'System'
    };
    auditLogs.unshift(logEntry);
    // Keep only last 1000 audit logs
    if (auditLogs.length > 1000) {
        auditLogs.splice(1000);
    }
    saveToStorage('audit_logs', auditLogs);
}

// Initialize demo data if localStorage is empty
function initializeDemoData() {
    const hasData = localStorage.getItem(getStorageKey('clients'));
    if (!hasData) {
        // Initialize demo clinicians
        const demoClinicians = [
            {
                id: 'clinician-demo-1',
                username: 'admin',
                password: 'admin123',
                fullName: 'Admin User',
                email: 'admin@clinicalspeak.com',
                role: 'admin',
                createdAt: new Date().toISOString(),
                isActive: true
            }
        ];
        saveToStorage('clinicians', demoClinicians);
        
        // Initialize with demo data
        const demoClients = [
            { id: 1, name: 'John Doe', email: 'john@example.com', phone: '555-0123', status: 'active', created_at: new Date().toISOString() },
            { id: 2, name: 'Jane Smith', email: 'jane@example.com', phone: '555-0124', status: 'active', created_at: new Date().toISOString() }
        ];
        const demoTemplates = {
            '1': { id: 1, name: 'Consent Form', content: 'Default consent form content...' },
            '2': { id: 2, name: 'Medical History', content: 'Default medical history form...' },
            '3': { 
                id: 3, 
                name: 'ACE Questionnaire', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Adverse Childhood Experience (ACE) Questionnaire</h2>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>Instructions:</strong> While you were growing up, during your first 18 years of life, please answer the following questions. Mark "Yes" or "No" for each question.</p>
                    </div>
                    
                    <form id="aceForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>1.</strong> Did a parent or other adult in the household often swear at you, insult you, put you down, or humiliate you? Did they act in a way that made you afraid that you might be physically hurt?</p>
                            <label><input type="radio" name="q1" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q1" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>2.</strong> Did a parent or other adult in the household often push, grab, slap, or throw something at you? Did they ever hit you so hard that you had marks or were injured?</p>
                            <label><input type="radio" name="q2" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q2" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>3.</strong> Did an adult or person at least 5 years older than you ever touch or fondle you or have you touch their body in a sexual way? Did they try to or actually have oral, anal, or vaginal sex with you?</p>
                            <label><input type="radio" name="q3" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q3" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>4.</strong> Did you often feel that no one in your family loved you or thought you were important or special? Did you often feel as your family didn't look out for each other, feel close to each other, or support each other?</p>
                            <label><input type="radio" name="q4" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q4" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>5.</strong> Did you often feel that you didn't have enough to eat, had to wear dirty clothes, and had no one to protect you? Did you often feel that your parents were too drunk or high to take care of you or take you to the doctor if you needed it?</p>
                            <label><input type="radio" name="q5" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q5" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>6.</strong> Were your parents ever separated or divorced?</p>
                            <label><input type="radio" name="q6" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q6" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>7.</strong> Was your mother or stepmother often pushed, grabbed, slapped, or had something thrown at her? Was she sometimes or often kicked, bitten, hit with a fist, or hit with something hard? Or ever repeatedly hit over at least a few minutes or threatened with a gun or knife?</p>
                            <label><input type="radio" name="q7" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q7" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>8.</strong> Did you live with anyone who was a problem drinker or alcoholic or who used street drugs?</p>
                            <label><input type="radio" name="q8" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q8" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>9.</strong> Was a household member depressed or mentally ill or did a household member attempt suicide?</p>
                            <label><input type="radio" name="q9" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q9" value="0"> No (0)</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>10.</strong> Did a household member go to prison?</p>
                            <label><input type="radio" name="q10" value="1"> Yes (1)</label>
                            <label style="margin-left: 20px;"><input type="radio" name="q10" value="0"> No (0)</label>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p><strong>ACE Score Calculation:</strong></p>
                            <p>Now add up your "Yes" answers and enter the total below:</p>
                            <label><strong>Total ACE Score:</strong> <input type="number" id="aceScore" min="0" max="10" style="width: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"></label>
                        </div>
                    </form>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                        <p><strong>Source:</strong> CDC-Kaiser Permanente ACE Study, 1998.</p>
                    </div>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitACEDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Completed Form
                        </button>
                    </div>
                </div>` 
            },
            '4': { 
                id: 4, 
                name: 'AUDIT Questionnaire', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Alcohol Use Disorders Identification Test (AUDIT): Self-Report Version</h2>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>Instructions:</strong> Because alcohol use can affect your health and can interfere with certain medications and treatments, it is important that we ask some questions about your use of alcohol. Your answers will remain confidential so please be honest. Check the option that best describes your answer to each question.</p>
                    </div>
                    
                    <form id="auditForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>1.</strong> How often do you have a drink containing alcohol?</p>
                            <label><input type="radio" name="q1" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q1" value="1"> (1) Monthly or less</label><br>
                            <label><input type="radio" name="q1" value="2"> (2) 2 to 4 times a month</label><br>
                            <label><input type="radio" name="q1" value="3"> (3) 2 to 3 times a week</label><br>
                            <label><input type="radio" name="q1" value="4"> (4) 4 or more times a week</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>2.</strong> How many drinks containing alcohol do you have on a typical day when you are drinking?</p>
                            <label><input type="radio" name="q2" value="0"> (0) 1 or 2</label><br>
                            <label><input type="radio" name="q2" value="1"> (1) 3 or 4</label><br>
                            <label><input type="radio" name="q2" value="2"> (2) 5 or 6</label><br>
                            <label><input type="radio" name="q2" value="3"> (3) 7, 8, or 9</label><br>
                            <label><input type="radio" name="q2" value="4"> (4) 10 or more</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>3.</strong> How often do you have six or more drinks on one occasion?</p>
                            <label><input type="radio" name="q3" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q3" value="1"> (1) Less than monthly</label><br>
                            <label><input type="radio" name="q3" value="2"> (2) Monthly</label><br>
                            <label><input type="radio" name="q3" value="3"> (3) Weekly</label><br>
                            <label><input type="radio" name="q3" value="4"> (4) Daily or almost daily</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>4.</strong> How often during the last year have you found that you were not able to stop drinking once you had started?</p>
                            <label><input type="radio" name="q4" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q4" value="1"> (1) Less than monthly</label><br>
                            <label><input type="radio" name="q4" value="2"> (2) Monthly</label><br>
                            <label><input type="radio" name="q4" value="3"> (3) Weekly</label><br>
                            <label><input type="radio" name="q4" value="4"> (4) Daily or almost daily</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>5.</strong> How often during the last year have you failed to do what was normally expected from you because of drinking?</p>
                            <label><input type="radio" name="q5" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q5" value="1"> (1) Less than monthly</label><br>
                            <label><input type="radio" name="q5" value="2"> (2) Monthly</label><br>
                            <label><input type="radio" name="q5" value="3"> (3) Weekly</label><br>
                            <label><input type="radio" name="q5" value="4"> (4) Daily or almost daily</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>6.</strong> How often during the last year have you needed a first drink in the morning to get yourself going after a heavy drinking session?</p>
                            <label><input type="radio" name="q6" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q6" value="1"> (1) Less than monthly</label><br>
                            <label><input type="radio" name="q6" value="2"> (2) Monthly</label><br>
                            <label><input type="radio" name="q6" value="3"> (3) Weekly</label><br>
                            <label><input type="radio" name="q6" value="4"> (4) Daily or almost daily</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>7.</strong> How often during the last year have you had a feeling of guilt or remorse after drinking?</p>
                            <label><input type="radio" name="q7" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q7" value="1"> (1) Less than monthly</label><br>
                            <label><input type="radio" name="q7" value="2"> (2) Monthly</label><br>
                            <label><input type="radio" name="q7" value="3"> (3) Weekly</label><br>
                            <label><input type="radio" name="q7" value="4"> (4) Daily or almost daily</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>8.</strong> How often during the last year have you been unable to remember what happened the night before because you had been drinking?</p>
                            <label><input type="radio" name="q8" value="0"> (0) Never</label><br>
                            <label><input type="radio" name="q8" value="1"> (1) Less than monthly</label><br>
                            <label><input type="radio" name="q8" value="2"> (2) Monthly</label><br>
                            <label><input type="radio" name="q8" value="3"> (3) Weekly</label><br>
                            <label><input type="radio" name="q8" value="4"> (4) Daily or almost daily</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>9.</strong> Have you or someone else been injured as a result of your drinking?</p>
                            <label><input type="radio" name="q9" value="0"> (0) No</label><br>
                            <label><input type="radio" name="q9" value="2"> (2) Yes, but not in the last year</label><br>
                            <label><input type="radio" name="q9" value="4"> (4) Yes, during the last year</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>10.</strong> Has a relative, friend, doctor, or another health worker been concerned about your drinking or suggested you cut down?</p>
                            <label><input type="radio" name="q10" value="0"> (0) No</label><br>
                            <label><input type="radio" name="q10" value="2"> (2) Yes, but not in the last year</label><br>
                            <label><input type="radio" name="q10" value="4"> (4) Yes, during the last year</label>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p><strong>AUDIT Score Calculation:</strong></p>
                            <p>Now add up the total for your answers using the number in parentheses next to each answer you selected. Record your total score here:</p>
                            <label><strong>Total AUDIT Score:</strong> <input type="number" id="auditScore" min="0" max="40" style="width: 60px; padding: 5px; border: 1px solid #ccc; border-radius: 4px;"></label>
                        </div>
                    </form>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                        <p><strong>Source:</strong> Babor TF; de la Fuente JR; Saunders J; Grant M. AUDIT: The Alcohol Use Disorders Identification Test. Guidelines for use in primary health care. WHO/MNH/DAT 89.4, World Health Organization, Geneva, 1989.</p>
                    </div>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitAUDITDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Completed Form
                        </button>
                    </div>
                </div>` 
            },
            '5': { 
                id: 5, 
                name: 'Authorization for Disclosure of Information', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Authorization for Disclosure of Information</h2>
                    
                    <form id="disclosureForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>I hereby authorize and direct (enter name of clinician):</strong></label><br>
                            <input type="text" name="clinicianName" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>To:</strong></label><br>
                            <input type="text" name="authorizedTo" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>DISCLOSE the following information:</strong></p>
                            <textarea name="discloseInfo" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Specify information to be disclosed..."></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <p><strong>EXCHANGE the following information:</strong></p>
                            <textarea name="exchangeInfo" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Specify information to be exchanged..."></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>To / With:</strong></label><br>
                            <input type="text" name="recipient" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>For the following purpose(s):</strong></label><br>
                            <textarea name="purpose" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>This authorization expires on:</strong></label><br>
                            <input type="date" name="expirationDate" style="padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                            <p style="font-size: 12px; color: #666; margin-top: 5px;">This authorization expires on the date selected or in 90 days, whichever date is sooner.</p>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p><strong>By signing this authorization form:</strong> I understand that my records contain information regarding my mental health. I give specific permission for this information to be released. I understand that my records are protected under State and Federal law and cannot be disclosed without my written consent unless otherwise provided for by law.</p>
                        </div>
                    </form>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitDisclosureDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Authorization
                        </button>
                    </div>
                </div>` 
            },
            '6': { 
                id: 6, 
                name: 'Biopsychosocial Assessment', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Biopsychosocial Assessment</h2>
                    
                    <form id="biopsychosocialForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>1. Presenting Problem:</strong></label><br>
                            <textarea name="presentingProblem" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>2. Signs and Symptoms (DSM-V-TR based) resulting in impairment(s):</strong></label><br>
                            <textarea name="signsSymptoms" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Include current examples for treatment planning, e.g., social, occupational, affective, cognitive, physical"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>3. History of Presenting Problem:</strong></label><br>
                            <textarea name="historyProblem" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Events, precipitating factors, or incidents leading to need for services"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Frequency/duration/severity/cycling of symptoms:</strong></label><br>
                            <textarea name="frequencyDuration" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Was there a clear time when symptoms worsened?</strong></label><br>
                            <textarea name="symptomsWorsened" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>4. Current Family and Significant Relationships:</strong></label><br>
                            <p><strong>Strengths/support:</strong></p>
                            <textarea name="familyStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Stressors/problems:</strong></p>
                            <textarea name="familyStressors" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Recent changes:</strong></p>
                            <textarea name="familyChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Changes desired:</strong></p>
                            <textarea name="familyDesiredChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Comment on family circumstances:</strong></p>
                            <textarea name="familyCircumstances" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>5. Childhood/Adolescent History:</strong></label><br>
                            <textarea name="childhoodHistory" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="Developmental milestones, past behavioral concerns, environment, abuse, school, social, mental health"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>6. Social Relationships:</strong></label><br>
                            <p><strong>Strengths/support:</strong></p>
                            <textarea name="socialStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Stressors/problems:</strong></p>
                            <textarea name="socialStressors" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Recent changes:</strong></p>
                            <textarea name="socialChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Changes desired:</strong></p>
                            <textarea name="socialDesiredChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>7. Cultural/Ethnic:</strong></label><br>
                            <p><strong>Strengths/support:</strong></p>
                            <textarea name="culturalStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Stressors/problems:</strong></p>
                            <textarea name="culturalStressors" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Beliefs/practices to incorporate into therapy:</strong></p>
                            <textarea name="culturalBeliefs" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>8. Spiritual/Religious:</strong></label><br>
                            <p><strong>Strengths/support:</strong></p>
                            <textarea name="spiritualStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Stressors/problems:</strong></p>
                            <textarea name="spiritualStressors" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Beliefs/practices to incorporate into therapy:</strong></p>
                            <textarea name="spiritualBeliefs" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Recent changes:</strong></p>
                            <textarea name="spiritualChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Changes desired:</strong></p>
                            <textarea name="spiritualDesiredChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>9. Legal:</strong></label><br>
                            <p><strong>History:</strong></p>
                            <textarea name="legalHistory" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Status/impact/stressors:</strong></p>
                            <textarea name="legalStatus" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>10. Education:</strong></label><br>
                            <p><strong>Strengths:</strong></p>
                            <textarea name="educationStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Weaknesses:</strong></p>
                            <textarea name="educationWeaknesses" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>11. Employment/Vocational:</strong></label><br>
                            <p><strong>Strengths/support:</strong></p>
                            <textarea name="employmentStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Stressors/problems:</strong></p>
                            <textarea name="employmentStressors" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>12. Military:</strong></label><br>
                            <p><strong>Current impact:</strong></p>
                            <textarea name="militaryImpact" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>13. Leisure/Recreational:</strong></label><br>
                            <p><strong>Strengths/support:</strong></p>
                            <textarea name="leisureStrengths" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Recent changes:</strong></p>
                            <textarea name="leisureChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Changes desired:</strong></p>
                            <textarea name="leisureDesiredChanges" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>14. Physical Health:</strong></label><br>
                            <p><strong>Summary of health:</strong></p>
                            <textarea name="healthSummary" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Physical factors affecting mental condition:</strong></p>
                            <textarea name="physicalFactors" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>15. Chemical Use History:</strong></label><br>
                            <p><strong>Summary of use:</strong></p>
                            <textarea name="chemicalSummary" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Patient's perception of problem:</strong></p>
                            <textarea name="chemicalPerception" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>16. Counseling/Prior Treatment History:</strong></label><br>
                            <p><strong>Summary of prior treatment:</strong></p>
                            <textarea name="treatmentSummary" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Benefits of previous treatment:</strong></p>
                            <textarea name="treatmentBenefits" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                            
                            <p style="margin-top: 15px;"><strong>Setbacks of previous treatment:</strong></p>
                            <textarea name="treatmentSetbacks" rows="2" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Family mental health history:</strong></label><br>
                            <textarea name="familyMentalHealth" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
                        </div>
                    </form>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitBiopsychosocialDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Assessment
                        </button>
                    </div>
                </div>` 
            },
            '7': { 
                id: 7, 
                name: 'Consent for Use of AI Tools in Therapy', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Consent for Use of Artificial Intelligence (AI) Tools in Therapy Services</h2>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Introduction</h3>
                        <p>At [Therapist Name/Practice Name], we are [I am] committed to providing you with the best possible treatment. To help us [me] manage our [my] practice efficiently and enhance our [my] services, we [I] use technology, including certain artificial intelligence (AI) tools. This document explains how we [I] use these tools and asks for your consent to use them as part of your treatment. Your privacy, confidentiality, and the quality of your treatment remain our highest priorities.</p>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">How We [I] Use AI Tools</h3>
                        <p>AI tools are used strictly for administrative and supplementary support tasks under the direct supervision of your therapist. These tools do not provide therapy, make independent clinical decisions, or interact with you directly.</p>
                        <p><strong>The specific purposes for which we [I] may use AI now and in the future include:</strong></p>
                        <ul>
                            <li>Assisting your therapist in drafting and organizing session notes;</li>
                            <li>Managing appointment scheduling and/or sending reminders;</li>
                            <li>Processing billing and insurance claims;</li>
                            <li>Analyzing data to identify therapy trends and track progress, which is always reviewed by your therapist;</li>
                            <li>Analyzing business information and generating reports or trends to help me manage my business; or</li>
                            <li>Helping to identify and organize external resources or referrals for your use.</li>
                        </ul>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">How We [I] DO NOT Use AI Tools</h3>
                        <p><strong>To be clear, we [I] do not use AI to:</strong></p>
                        <ul>
                            <li>Make independent therapeutic decisions or diagnoses;</li>
                            <li>Communicate with you directly to provide therapeutic advice;</li>
                            <li>Generate treatment recommendations without the direct review, approval, and input of your licensed therapist; or</li>
                            <li>Detect or interpret your emotions or mental state.</li>
                        </ul>
                    </div>
                    
                    <form id="aiConsentForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">Consent for Session Transcription (If Applicable)</h3>
                            <p>To help create accurate and detailed session notes, your therapist uses [I use] an AI tool called Note Taker that transcribes our sessions and then prepares a draft progress note. Note Taker is a feature in the Electronic Health Record and practice management platform that I use from ClinicalSpeak.</p>
                            <p><strong>Please check one of the following:</strong></p>
                            
                            <label style="display: block; margin: 10px 0;">
                                <input type="radio" name="transcriptionConsent" value="yes">
                                I consent to the use of an AI transcription tool to record and transcribe my therapy sessions for the purpose of assisting my therapist with note-taking.
                            </label>
                            
                            <label style="display: block; margin: 10px 0;">
                                <input type="radio" name="transcriptionConsent" value="no">
                                I do not consent to the use of an AI transcription tool to record or transcribe my therapy sessions. I understand this will not affect the quality of my care.
                            </label>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">Your Rights and Confidentiality</h3>
                            <p><strong>Confidentiality:</strong> All information, including any data processed by an AI tool, is treated as part of your confidential health record and is protected by the same privacy and security standards as all other aspects of your care, including HIPAA.</p>
                            <ul>
                                <li>ClinicalSpeak and its Note Taker tool are HIPAA-compliant and HITRUST certified.</li>
                                <li>All audio-recordings of therapy sessions through Note Taker are immediately deleted as soon as a transcript is created, generally within minutes of a session ending.</li>
                                <li>Transcripts that are created through Note Taker are only retained for the shorter of 7 days or when the progress note is signed and locked by your therapist. After that, they are permanently deleted.</li>
                                <li>During the time that transcripts are available in Note Taker, they always remain confidential and secure, and are only available for your therapist's use to verify the accuracy of the progress note. They are not used for any other purpose.</li>
                            </ul>
                            <p><strong>Right to Revoke Consent:</strong> Your consent is voluntary. You have the right to withdraw this consent at any time by notifying your therapist in writing. Revoking your consent will not affect your ability to receive therapy services.</p>
                        </div>
                        
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">Client Acknowledgment and Consent</h3>
                            <p>By signing below, I confirm that:</p>
                            <ol>
                                <li>I have read and understood this form.</li>
                                <li>I have had the opportunity to ask questions about the use of AI tools in my treatment.</li>
                                <li>I voluntarily agree to the use of AI tools for the purposes described above.</li>
                            </ol>
                        </div>
                    </form>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitAIConsentDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Consent Form
                        </button>
                    </div>
                </div>` 
            },
            '8': { 
                id: 8, 
                name: 'Couple Therapy Policy: Limited Secrets Policy', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Couple Therapy Policy: Limited Secrets Policy</h2>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Couple Therapy Policy</h3>
                        <p>If you are here to work on a relationship problem, it's important for you to understand what I believe about relationships and marriage. First of all, I do not have preconceived notions about whether you should stay together or part ways. I believe it is important to explore such questions openly, honestly, and thoroughly. Once your goals are established, I will work diligently to support you in achieving them, whatever they may be.</p>
                        
                        <p style="margin-top: 15px;">Second, you are entrusting me to use my professional judgment as it relates to individual confidences. By signing this form, you are acknowledging that anything you communicate to me individually by phone, email, or any other means may be important to bring up and work on in a couple therapy session, and I reserve the right (but not the obligation) to do so.</p>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Important Understanding</h3>
                        <p>This policy helps ensure that both partners can work together effectively in therapy. It promotes transparency and honesty, which are essential for successful couple therapy outcomes.</p>
                    </div>
                    
                    <form id="couplePolicyForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="checkbox" name="acknowledgePolicy" required>
                                I acknowledge that I have read and understand this Couple Therapy Policy regarding limited secrets.
                            </label>
                            
                            <label style="display: block; margin-bottom: 10px;">
                                <input type="checkbox" name="consentToSharing" required>
                                I consent to sharing information provided here and understand that individual communications may be discussed in couple sessions when clinically appropriate.
                            </label>
                        </div>
                    </form>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitCouplePolicyDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Policy Agreement
                        </button>
                    </div>
                </div>` 
            },
            '9': { 
                id: 9, 
                name: 'Couples Counseling Initial Intake Form', 
                content: `<div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; line-height: 1.6;">
                    <h2 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">Couples Counseling Initial Intake Form</h2>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <p><strong>Instructions:</strong> Prior to your first appointment, please answer all questions below. Do not spend too much time on any question.</p>
                    </div>
                    
                    <form id="couplesIntakeForm" style="margin-bottom: 30px;">
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Name of partner:</strong></label><br>
                            <input type="text" name="partnerName" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Relationship status (check all that apply):</strong></label><br>
                            <label><input type="checkbox" name="status" value="married"> Married</label><br>
                            <label><input type="checkbox" name="status" value="separated"> Separated</label><br>
                            <label><input type="checkbox" name="status" value="divorced"> Divorced</label><br>
                            <label><input type="checkbox" name="status" value="dating"> Dating</label><br>
                            <label><input type="checkbox" name="status" value="cohabitating"> Cohabitating/living together</label><br>
                            <label><input type="checkbox" name="status" value="living-apart"> Living apart</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Length of time in current relationship:</strong></label><br>
                            <input type="text" name="relationshipLength" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>As you think about the primary reason that brings you here, how does it occur?</strong></label><br>
                            <select name="occurrence" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                                <option value="">Select frequency</option>
                                <option value="no-occurrence">No occurrence</option>
                                <option value="rarely">Occurs rarely</option>
                                <option value="sometimes">Occurs sometimes</option>
                                <option value="frequently">Occurs frequently</option>
                                <option value="nearly-always">Occurs nearly always</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>As you think about the primary reason that brings you here, how would you rate your overall concern about it?</strong></label><br>
                            <select name="concern" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                                <option value="">Select concern level</option>
                                <option value="no-concern">No concern</option>
                                <option value="little-concern">Little concern</option>
                                <option value="moderate-concern">Moderate concern</option>
                                <option value="serious-concern">Serious concern</option>
                                <option value="very-serious">Very serious concern</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>What do you hope to accomplish through counseling?</strong></label><br>
                            <textarea name="goals" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>What have you already done to deal with the difficulties?</strong></label><br>
                            <textarea name="attemptedSolutions" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>What are your biggest strengths as a couple?</strong></label><br>
                            <textarea name="strengths" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Please rate your current level of relationship happiness (1-10):</strong></label><br>
                            <select name="happiness" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                                <option value="">Select rating</option>
                                <option value="1">1 - Extremely unhappy</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 - Extremely happy</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Have you received prior couples counseling related to any of the above problems?</strong></label><br>
                            <label><input type="radio" name="priorCounseling" value="yes"> Yes</label>
                            <label style="margin-left: 20px;"><input type="radio" name="priorCounseling" value="no"> No</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Please make at least one suggestion as to something you could personally do to improve the relationship regardless of what your partner does:</strong></label><br>
                            <textarea name="personalImprovement" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If you have received prior couples counseling, when did this occur?</strong></label><br>
                            <input type="text" name="priorCounselingWhen" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="If not applicable, type N/A">
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If you have received prior couples counseling, where did this occur?</strong></label><br>
                            <input type="text" name="priorCounselingWhere" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="If not applicable, type N/A">
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If you have received prior couples counseling, who counseled you?</strong></label><br>
                            <input type="text" name="priorCounselingWho" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="If not applicable, type N/A">
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If you have received prior couples counseling, what was the length of treatment?</strong></label><br>
                            <input type="text" name="priorCounselingLength" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="If not applicable, type N/A">
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If you have received prior couples counseling, what were the problems that were treated?</strong></label><br>
                            <textarea name="priorCounselingProblems" rows="3" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" placeholder="If not applicable, type N/A"></textarea>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Have either you or your partner been in individual counseling before?</strong></label><br>
                            <label><input type="radio" name="individualCounseling" value="yes"> Yes</label>
                            <label style="margin-left: 20px;"><input type="radio" name="individualCounseling" value="no"> No</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Do either you or your partner drink alcohol to intoxication or take drugs to intoxication?</strong></label><br>
                            <label><input type="radio" name="substanceUse" value="yes"> Yes</label>
                            <label style="margin-left: 20px;"><input type="radio" name="substanceUse" value="no"> No</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If you have received prior couples counseling, what was the outcome?</strong></label><br>
                            <select name="priorCounselingOutcome" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Select outcome</option>
                                <option value="much-worse">Much worse</option>
                                <option value="somewhat-worse">Somewhat worse</option>
                                <option value="same">Stayed the same</option>
                                <option value="somewhat-successful">Somewhat successful</option>
                                <option value="very-successful">Very successful</option>
                                <option value="n/a">N/A</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If married, has either of you threatened to separate or divorce as a result of the current relationship problems?</strong></label><br>
                            <select name="separationThreat" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Select option</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                                <option value="n/a">N/A (Not married)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Have either you or your partner struck, physically restrained, used violence against, or injured the other person?</strong></label><br>
                            <label><input type="radio" name="violence" value="yes"> Yes</label>
                            <label style="margin-left: 20px;"><input type="radio" name="violence" value="no"> No</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>Do you perceive that either you or your partner has withdrawn from the relationship?</strong></label><br>
                            <label><input type="radio" name="withdrawal" value="yes"> Yes</label>
                            <label style="margin-left: 20px;"><input type="radio" name="withdrawal" value="no"> No</label>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>If married, have either you or your partner consulted with a lawyer about divorce?</strong></label><br>
                            <select name="lawyerConsultation" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Select option</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                                <option value="n/a">N/A (Not married)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>How frequently have you had sexual relations during the last month?</strong></label><br>
                            <input type="text" name="sexualFrequency" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>How satisfied are you with the frequency of your sexual relations? (1-10)</strong></label><br>
                            <select name="sexualSatisfaction" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Select rating</option>
                                <option value="1">1 - Extremely unsatisfied</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 - Extremely satisfied</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>How enjoyable is your sexual relationship? (1-10)</strong></label><br>
                            <select name="sexualEnjoyment" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="">Select rating</option>
                                <option value="1">1 - Extremely unpleasant</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 - Extremely pleasant</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>What is your current level of stress (overall)? (1-10)</strong></label><br>
                            <select name="overallStress" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                                <option value="">Select rating</option>
                                <option value="1">1 - No stress</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 - High stress</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>What is your current level of stress (in the relationship)? (1-10)</strong></label><br>
                            <select name="relationshipStress" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required>
                                <option value="">Select rating</option>
                                <option value="1">1 - No stress</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10 - High stress</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;">
                            <label><strong>List your top three concerns that you have in your relationship with your partner (1 being the most problematic):</strong></label><br>
                            <textarea name="topConcerns" rows="4" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;" required></textarea>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <p><strong>Thank you for completing this.</strong> Please note that you will be asked to talk about your answers in appointments, but your partner will not be shown this form.</p>
                        </div>
                    </form>
                    
                    <div style="border-top: 2px solid #e9ecef; padding-top: 30px; margin-top: 30px;">
                        <h3 style="color: #2c3e50; margin-bottom: 20px;">Digital Signatures</h3>
                        
                        <div style="display: flex; gap: 40px; margin-bottom: 30px;">
                            <div style="flex: 1;">
                                <h4 style="color: #1976d2; margin-bottom: 15px;">Client Signature</h4>
                                <div style="border: 2px dashed #1976d2; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clientSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Client Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Client Name: <input type="text" id="clientName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clientDate"></span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="flex: 1;">
                                <h4 style="color: #9c27b0; margin-bottom: 15px;">Clinician Signature</h4>
                                <div style="border: 2px dashed #9c27b0; border-radius: 8px; padding: 20px; text-align: center; min-height: 100px; background: #f8f9fa;">
                                    <div id="clinicianSignature" style="min-height: 60px; display: flex; align-items: center; justify-content: center; color: #666;">
                                        <span>Clinician Signature Required</span>
                                    </div>
                                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                                        <div>Clinician Name: <input type="text" id="clinicianName" style="border: none; border-bottom: 1px solid #ccc; background: transparent; width: 200px;"></div>
                                        <div style="margin-top: 5px;">Date: <span id="clinicianDate"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="submitCouplesIntakeDocument()" style="background: #00a86b; color: white; border: none; padding: 12px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                            Submit Intake Form
                        </button>
                    </div>
                </div>` 
            }
        };
        const demoAppointments = [
            { id: 1, client_id: 1, client_name: 'John Doe', appointment_date: new Date().toISOString().split('T')[0], appointment_time: '09:00', duration: 60, type: 'Initial Consultation', notes: 'Initial consultation', status: 'scheduled', created_at: new Date().toISOString() },
            { id: 2, client_id: 2, client_name: 'Jane Smith', appointment_date: new Date(Date.now() + 86400000).toISOString().split('T')[0], appointment_time: '14:00', duration: 45, type: 'Follow-up', notes: 'Follow-up appointment', status: 'scheduled', created_at: new Date().toISOString() }
        ];
        
        const demoAssignedDocs = [
            { id: 1, client_id: 1, client_name: 'John Doe', template_id: '1', template_name: 'Consent Form', auth_code: 'ABC123', status: 'pending', assigned_at: new Date().toISOString(), created_at: new Date().toISOString() },
            { id: 2, client_id: 2, client_name: 'Jane Smith', template_id: '2', template_name: 'Medical History', auth_code: 'XYZ789', status: 'pending', assigned_at: new Date().toISOString(), created_at: new Date().toISOString() }
        ];
        
        saveToStorage('clients', demoClients);
        saveToStorage('templates', demoTemplates);
        saveToStorage('appointments', demoAppointments);
        saveToStorage('assigned_docs', demoAssignedDocs);
        saveToStorage('invoices', []);
        
        logLocalAudit('system_init', { message: 'Demo data initialized' });
    }
}

async function loadTemplates() {
    try {
        const templates = loadFromStorage('templates', {});
        documentTemplates = templates;
        Object.keys(templates).forEach(id => {
            templateNames[id] = templates[id].name;
        });
        
        console.log(' Loaded', Object.keys(documentTemplates).length, 'templates');
    } catch (error) {
        console.error('Error loading templates:', error);
        alert('Failed to load templates');
    }
}

// localStorage-based API replacement functions
async function apiCall(endpoint, options = {}) {
    // DISABLED - No API calls allowed
    console.log('apiCall disabled - endpoint:', endpoint);
    throw new Error('API calls disabled - use localStorage functions directly');
}


function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tab + 'Auth').classList.add('active');
}


async function clinicianLogin() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!username || !password) {
        showNotification('Please enter both username and password', 'error');
        return;
    }
    
    try {
        // Load all clinicians from storage
        const clinicians = loadFromStorage('clinicians', []);
        console.log('Loaded clinicians from storage:', clinicians);
        console.log('Looking for username:', username);
        
        // Find matching clinician
        const clinician = clinicians.find(c => 
            c.username === username && c.password === password
        );
        console.log('Found clinician:', clinician);
        
        if (clinician) {
            // Login successful
            authToken = 'token-' + Date.now() + '-' + clinician.id;
            currentUser = {
                id: clinician.id,
                name: clinician.fullName,
                email: clinician.email,
                username: clinician.username,
                role: 'admin',
                createdAt: clinician.createdAt
            };
            
            saveToStorage('auth_token', authToken);
            saveToStorage('current_user', currentUser);
            
            logAudit('login', { 
                username: username,
                user_id: clinician.id,
                method: 'password'
            });
            
            showNotification('Login successful!', 'success');
            showApp();
            
        } else {
            showNotification('Invalid username or password', 'error');
        }
        
    } catch (error) {
        console.error('Login error:', error);
        showNotification('Login failed: ' + error.message, 'error');
    }
}

function showRegisterForm() {
    document.getElementById('clinicianAuth').style.display = 'none';
    document.getElementById('registerForm').style.display = 'block';
}

function showLoginForm() {
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('clinicianAuth').style.display = 'block';
}

function registerClinician() {
    const username = document.getElementById('regUsername').value.trim();
    const password = document.getElementById('regPassword').value;
    const confirmPassword = document.getElementById('regConfirmPassword').value;
    const fullName = document.getElementById('regFullName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    
    // Validation
    if (!username || !password || !confirmPassword || !fullName || !email) {
        showNotification('Please fill in all fields', 'error');
        return;
    }
    
    if (password !== confirmPassword) {
        showNotification('Passwords do not match', 'error');
        return;
    }
    
    if (password.length < 8) {
        showNotification('Password must be at least 8 characters', 'error');
        return;
    }
    
    if (!email.includes('@')) {
        showNotification('Please enter a valid email address', 'error');
        return;
    }
    
    try {
        // Load existing clinicians
        const clinicians = loadFromStorage('clinicians', []);
        
        // Check if username already exists
        if (clinicians.find(c => c.username === username)) {
            showNotification('Username already exists', 'error');
            return;
        }
        
        // Check if email already exists
        if (clinicians.find(c => c.email === email)) {
            showNotification('Email already registered', 'error');
            return;
        }
        
        // Create new clinician
        const newClinician = {
            id: 'clinician-' + Date.now(),
            username: username,
            password: password, // In production, this should be hashed
            fullName: fullName,
            email: email,
            role: 'admin',
            createdAt: new Date().toISOString(),
            isActive: true
        };
        
        // Add to clinicians array
        clinicians.push(newClinician);
        console.log('Saving clinicians:', clinicians);
        
        saveToStorage('clinicians', clinicians);
        
        // Verify save
        const verifyClinicians = loadFromStorage('clinicians', []);
        console.log('Verified clinicians after save:', verifyClinicians);
        
        // Log registration
        logAudit('clinician_registered', {
            username: username,
            email: email,
            user_id: newClinician.id
        });
        
        showNotification('Registration successful! Please login.', 'success');
        
        // Switch back to login form
        setTimeout(() => {
            showLoginForm();
            // Pre-fill username
            document.getElementById('loginUsername').value = username;
        }, 1500);
        
    } catch (error) {
        console.error('Registration error:', error);
        showNotification('Registration failed: ' + error.message, 'error');
    }
}


async function accessDocument() {
    const code = document.getElementById('authCode').value.toUpperCase().trim();
    if (!code) return alert('Please enter code');
    
    try {
        if (Object.keys(documentTemplates).length === 0) await loadTemplates();
        
        // Use localStorage instead of API call
        const allDocs = loadFromStorage('assigned_docs', []);
        const docs = allDocs.filter(d => d.auth_code === code);
        const pendingDocs = docs.filter(d => d.status === 'pending');
        
        console.log('All docs:', allDocs.length, 'Matching code:', docs.length, 'Pending:', pendingDocs.length);
        
        if (pendingDocs.length > 0) {
            currentDocuments = pendingDocs;
            currentDocIndex = 0;
            await logAudit('client_access', { code }, 'Client');
            showClientPortal();
        } else {
            alert('Invalid or expired code. Please check the code and try again.');
        }
    } catch (error) {
        console.error('Access document error:', error);
        alert('Error: ' + error.message);
    }
}

function logout() {
    // Clear authentication data
    authToken = null;
    currentUser = null;
    
    // Remove from localStorage
    localStorage.removeItem('auth_token');
    localStorage.removeItem('current_user');
    
    // Log the logout
    logAudit('logout', { method: currentUser?.loginMethod || 'unknown' });
    
    // Show login screen
    document.getElementById('authContainer').style.display = 'block';
    document.getElementById('appContainer').style.display = 'none';
    document.getElementById('clientPortal').style.display = 'none';
    
    // Clear form fields
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    
    alert(' Logged out successfully!');
}

function clientLogout() {
    // Clear client portal data
    currentDocuments = [];
    currentDocIndex = 0;
    
    // Clear the auth code input
    document.getElementById('authCode').value = '';
    
    // Return to login screen
    document.getElementById('clientPortal').style.display = 'none';
    document.getElementById('authContainer').style.display = 'block';
    document.getElementById('appContainer').style.display = 'none';
    
    console.log(' Client logged out');
}

async function showApp() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    document.getElementById('userName').textContent = currentUser.name;
    await loadData();
}

function showClientPortal() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('clientPortal').style.display = 'block';
    renderClientDocuments();
}

function renderClientDocuments() {
    const container = document.getElementById('clientPortalContent');
    if (currentDocuments.length === 0) {
        container.innerHTML = '<div>No documents found</div>';
        return;
    }
    
    let navHTML = '';
    if (currentDocuments.length > 1) {
        navHTML = '<div class="doc-nav">';
        currentDocuments.forEach((doc, i) => {
            navHTML += `<div class="doc-nav-item ${i === currentDocIndex ? 'active' : ''} ${doc.status === 'completed' ? 'completed' : ''}" onclick="switchDocument(${i})">
                ${i + 1}. ${templateNames[doc.template_id]}
            </div>`;
        });
        navHTML += '</div>';
    }
    
    const doc = currentDocuments[currentDocIndex];
    const template = documentTemplates[doc.template_id];
    
    let html = navHTML + `
        <div class="document-header">
            <h1>${template.name}</h1>
            <p style="color: #666;">Client: ${doc.client_name}</p>
            ${currentDocuments.length > 1 ? `<p style="font-size: 14px; margin-top: 5px;">Document ${currentDocIndex + 1} of ${currentDocuments.length}</p>` : ''}
        </div>
        <div class="form-section">
            <h2 style="margin-bottom: 20px;">Please complete:</h2>
            <form id="clientDocumentForm">
    `;
    
    template.fields.forEach(field => {
        html += `<div class="form-field"><label>${field.label}</label>`;
        if (field.type === 'checkbox') {
            html += `<input type="checkbox" id="${field.id}" style="width: auto;">`;
        } else if (field.type === 'select') {
            html += `<select id="${field.id}">`;
            field.options.forEach(opt => html += `<option>${opt}</option>`);
            html += `</select>`;
        } else if (field.type === 'textarea') {
            html += `<textarea id="${field.id}"></textarea>`;
        } else {
            html += `<input type="${field.type}" id="${field.id}">`;
        }
        html += `</div>`;
    });
    
    html += `</form></div>
        <div class="form-section">
            <h3 style="margin-bottom: 20px;">Signature</h3>
            <div class="signature-pad">
                <p style="margin-bottom: 10px;">Type your full name:</p>
                <input type="text" id="clientSignature" class="signature-input" placeholder="Your Full Name">
            </div>
        </div>
        <div class="submit-section">
            <button onclick="submitClientDocument()" class="btn btn-primary" style="font-size: 16px; padding: 15px 40px;">Submit Document</button>
        </div>
    `;
    
    container.innerHTML = html;
}

function switchDocument(index) {
    currentDocIndex = index;
    renderClientDocuments();
}

// Enhanced Document Workflow Functions
function addDocumentVersion(docId, changes) {
    const doc = assignedDocs.find(d => d.id === docId);
    if (doc) {
        if (!doc.versions) doc.versions = [];
        doc.versions.push({
            id: Date.now(),
            timestamp: new Date().toISOString(),
            changes,
            user: currentUser?.name || 'System'
        });
        saveToStorage('assigned_docs', assignedDocs);
        logLocalAudit('document_version_added', { docId, versionId: doc.versions[doc.versions.length - 1].id });
    }
}

function bulkAssignDocuments(clientIds, templateIds, expirationDays = 30) {
    const expirationDate = new Date();
    expirationDate.setDate(expirationDate.getDate() + expirationDays);
    
    const bulkDocs = [];
    clientIds.forEach(clientId => {
        templateIds.forEach(templateId => {
            const client = clients.find(c => c.id === clientId);
            const template = documentTemplates[templateId];
            if (client && template) {
                const newDoc = {
                    id: Date.now() + Math.random(),
                    client_id: clientId,
                    client_name: client.name,
                    template_id: templateId,
                    template_name: template.name,
                    auth_code: generateAuthCode(),
                    status: 'pending',
                    created_at: new Date().toISOString(),
                    expiration_date: expirationDate.toISOString(),
                    versions: []
                };
                bulkDocs.push(newDoc);
            }
        });
    });
    
    assignedDocs.push(...bulkDocs);
    saveToStorage('assigned_docs', assignedDocs);
    logLocalAudit('bulk_document_assign', { 
        clientCount: clientIds.length, 
        templateCount: templateIds.length, 
        totalDocs: bulkDocs.length 
    });
    
    return bulkDocs;
}

function checkDocumentExpirations() {
    const today = new Date();
    const expiredDocs = assignedDocs.filter(doc => {
        if (doc.expiration_date) {
            return new Date(doc.expiration_date) < today && doc.status === 'pending';
        }
        return false;
    });
    
    if (expiredDocs.length > 0) {
        showNotification(`${expiredDocs.length} documents have expired`, 'warning');
        logLocalAudit('document_expiration_check', { expiredCount: expiredDocs.length });
    }
    
    return expiredDocs;
}

function exportDocumentToPDF(docId) {
    const doc = assignedDocs.find(d => d.id === docId);
    if (!doc) return;
    
    const template = documentTemplates[doc.template_id];
    if (!template) return;
    
    // Create a new window for PDF generation
    const printWindow = window.open('', '_blank');
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>${template.name} - ${doc.client_name}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #00a86b; padding-bottom: 20px; }
                .field { margin-bottom: 15px; }
                .label { font-weight: bold; margin-bottom: 5px; }
                .value { margin-left: 20px; }
                .signature { margin-top: 30px; border-top: 1px solid #ccc; padding-top: 20px; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>${template.name}</h1>
                <p><strong>Client:</strong> ${doc.client_name}</p>
                <p><strong>Date:</strong> ${new Date(doc.created_at).toLocaleDateString()}</p>
                <p><strong>Status:</strong> ${doc.status}</p>
            </div>
            
            <div class="content">
                ${template.fields.map(field => `
                    <div class="field">
                        <div class="label">${field.label}:</div>
                        <div class="value">${doc.form_data?.[field.id] || '[Not completed]'}</div>
                    </div>
                `).join('')}
            </div>
            
            ${doc.status === 'completed' ? `
                <div class="signature">
                    <p><strong>Digital Signature:</strong> ${doc.signature || '[No signature]'}</p>
                    <p><strong>Completed:</strong> ${new Date(doc.completed_at).toLocaleString()}</p>
                </div>
            ` : ''}
        </body>
        </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
    
    logLocalAudit('document_pdf_export', { docId, clientName: doc.client_name });
}

function customizeDocumentTemplate(templateId, customizations) {
    const template = documentTemplates[templateId];
    if (template) {
        // Apply customizations (fields, styling, etc.)
        if (customizations.fields) {
            template.customFields = customizations.fields;
        }
        if (customizations.branding) {
            template.branding = customizations.branding;
        }
        
        saveToStorage('templates', documentTemplates);
        logLocalAudit('template_customized', { templateId, templateName: template.name });
        return template;
    }
}

function getDocumentAnalytics() {
    const totalDocs = assignedDocs.length;
    const completedDocs = assignedDocs.filter(doc => doc.status === 'completed').length;
    const pendingDocs = assignedDocs.filter(doc => doc.status === 'pending').length;
    const expiredDocs = checkDocumentExpirations().length;
    
    const completionRate = totalDocs > 0 ? (completedDocs / totalDocs * 100).toFixed(1) : 0;
    const avgCompletionTime = calculateAverageCompletionTime();
    
    return {
        totalDocs,
        completedDocs,
        pendingDocs,
        expiredDocs,
        completionRate: `${completionRate}%`,
        avgCompletionTime,
        templateStats: getTemplateStatistics()
    };
}

function calculateAverageCompletionTime() {
    const completedDocs = assignedDocs.filter(doc => doc.status === 'completed' && doc.completed_at && doc.created_at);
    if (completedDocs.length === 0) return 'N/A';
    
    const totalTime = completedDocs.reduce((sum, doc) => {
        const created = new Date(doc.created_at);
        const completed = new Date(doc.completed_at);
        return sum + (completed - created);
    }, 0);
    
    const avgMs = totalTime / completedDocs.length;
    const avgDays = Math.round(avgMs / (1000 * 60 * 60 * 24));
    return `${avgDays} days`;
}

function getTemplateStatistics() {
    const stats = {};
    assignedDocs.forEach(doc => {
        const templateName = doc.template_name || 'Unknown';
        if (!stats[templateName]) {
            stats[templateName] = { total: 0, completed: 0 };
        }
        stats[templateName].total++;
        if (doc.status === 'completed') {
            stats[templateName].completed++;
        }
    });
    
    return stats;
}

async function submitClientDocument() {
    const signature = document.getElementById('clientSignature').value.trim();
    if (!signature) return alert('Please sign');
    
    // Enhanced signature verification
    if (signature.length < 2) {
        return alert('Please enter your full name for the signature');
    }
    
    const responses = {};
    const template = documentTemplates[currentDocuments[currentDocIndex].template_id];
    const doc = currentDocuments[currentDocIndex];
    
    template.fields.forEach(field => {
        const el = document.getElementById(field.id);
        if (el) responses[field.id] = el.type === 'checkbox' ? el.checked : el.value;
    });
    
    try {
        const completedAt = new Date().toISOString();
        
        // Update document with completion data
        doc.status = 'completed';
        doc.responses = responses;
        doc.form_data = responses; // For backward compatibility
        doc.signature = signature;
        doc.completed_at = completedAt;
        doc.signature_timestamp = completedAt; // HIPAA-compliant timestamp
        
        // Add version history
        addDocumentVersion(doc.id, {
            action: 'completed',
            form_data: responses,
            signature: signature,
            timestamp: completedAt
        });
        
        // Save to localStorage
        const docIndex = assignedDocs.findIndex(d => d.id === doc.id);
        if (docIndex !== -1) {
            assignedDocs[docIndex] = doc;
            saveToStorage('assigned_docs', assignedDocs);
        }
        
        logLocalAudit('document_completed', { 
            docId: doc.id, 
            clientName: doc.client_name, 
            templateName: doc.template_name,
            signature: signature,
            completionTime: completedAt
        });
        
        const remaining = currentDocuments.filter(d => d.status === 'pending');
        
        if (remaining.length > 0) {
            alert(` Submitted! ${remaining.length} more to complete.`);
            currentDocIndex = currentDocuments.findIndex(d => d.status === 'pending');
            renderClientDocuments();
        } else {
            alert(' All documents submitted successfully!');
            clientLogout();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function loadData() {
    try {
        await loadTemplates();
        // Data is already loaded from localStorage in DOMContentLoaded
        renderClients();
        updateDocBadge();
    } catch (error) {
        console.error('Load error:', error);
    }
}

function updateDocBadge() {
    const needsReview = assignedDocs.filter(d => d.status === 'completed' && !d.clinician_signature).length;
    const badge = document.getElementById('docBadge');
    badge.style.display = needsReview > 0 ? 'inline-block' : 'none';
    badge.textContent = needsReview;
}

function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tab + 'Content').style.display = 'block';
    event.target.classList.add('active');
    
    if (tab === 'clients') renderClients();
    else if (tab === 'documents') renderDocs();
    else if (tab === 'audit') renderAudit();
}

function renderClients() {
    const container = document.getElementById('clientsList');
    if (clients.length === 0) {
        container.innerHTML = '<p style="color: white;">No clients yet</p>';
        return;
    }
    
    container.innerHTML = clients.map(c => `
        <div class="client-card" onclick="openClientChart(${c.id})">
            <h3>${c.name}</h3>
            <p> ${c.email || 'N/A'}</p>
            <p> ${c.phone || 'N/A'}</p>
            <p> ${c.dob ? new Date(c.dob).toLocaleDateString() : 'N/A'}</p>
        </div>
    `).join('');
}

function filterClients() {
    const term = document.getElementById('clientSearchInput').value.toLowerCase();
    const filtered = clients.filter(c => 
        c.name.toLowerCase().includes(term) ||
        (c.email && c.email.toLowerCase().includes(term)) ||
        (c.phone && c.phone.includes(term))
    );
    
    const container = document.getElementById('clientsList');
    container.innerHTML = filtered.map(c => `
        <div class="client-card" onclick="openClientChart(${c.id})">
            <h3>${c.name}</h3>
            <p> ${c.email || 'N/A'}</p>
            <p> ${c.phone || 'N/A'}</p>
            <p> ${c.dob ? new Date(c.dob).toLocaleDateString() : 'N/A'}</p>
        </div>
    `).join('');
}

function openNewClient() {
    document.getElementById('newClientModal').style.display = 'block';
}

async function saveClient() {
    const client = {
        name: document.getElementById('clientName').value,
        email: document.getElementById('clientEmail').value,
        phone: document.getElementById('clientPhone').value,
        dob: document.getElementById('clientDOB').value,
        notes: document.getElementById('clientNotes').value
    };
    
    try {
        // Save to localStorage
        client.id = Date.now();
        client.created_at = new Date().toISOString();
        clients.push(client);
        saveToStorage('clients', clients);
        await logAudit('create_client', { id: client.id, name: client.name });
        closeModal('newClientModal');
        renderClients();
        ['clientName','clientEmail','clientPhone','clientDOB','clientNotes'].forEach(id => document.getElementById(id).value = '');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function openEditClient(id) {
    const c = clients.find(c => c.id === id);
    if (!c) return;
    document.getElementById('editClientId').value = c.id;
    document.getElementById('editClientName').value = c.name;
    document.getElementById('editClientEmail').value = c.email || '';
    document.getElementById('editClientPhone').value = c.phone || '';
    document.getElementById('editClientDOB').value = c.dob || '';
    document.getElementById('editClientNotes').value = c.notes || '';
    document.getElementById('editClientModal').style.display = 'block';
}

async function updateClient() {
    const id = document.getElementById('editClientId').value;
    const client = {
        id: parseInt(id),
        name: document.getElementById('editClientName').value,
        email: document.getElementById('editClientEmail').value,
        phone: document.getElementById('editClientPhone').value,
        dob: document.getElementById('editClientDOB').value,
        notes: document.getElementById('editClientNotes').value
    };
    
    try {
        // Update in localStorage
        const index = clients.findIndex(c => c.id === client.id);
        if (index !== -1) {
            clients[index] = client;
            saveToStorage('clients', clients);
        }
        
        
        await logAudit('update_client', { id, name: client.name });
        closeModal('editClientModal');
        renderClients();
        alert(' Updated!');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Client Chart Functions
async function openClientChart(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    currentChartClient = client;
    clientCalendarDate = new Date();
    
    // Set header info
    document.getElementById('chartClientName').textContent = client.name;
    document.getElementById('chartClientInfo').textContent = 
        ` ${client.email || 'N/A'} |  ${client.phone || 'N/A'} |  ${client.dob ? new Date(client.dob).toLocaleDateString() : 'N/A'}`;
    
    // Load client data
    await loadClientChartData();
    
    // Show overview tab by default
    showChartTab('overview');
    
    // Open modal
    document.getElementById('clientChartModal').style.display = 'block';
}

function showChartTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.chart-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.chart-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`chart${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.add('active');
    event.target.classList.add('active');
    
    // Load tab-specific data
    if (tabName === 'appointments') {
        renderClientAppointmentsList();
    } else if (tabName === 'documents') {
        renderClientDocuments();
    } else if (tabName === 'invoices') {
        renderClientInvoices();
    } else if (tabName === 'notes') {
        renderClientNotes();
    }
}

async function loadClientChartData() {
    if (!currentChartClient) return;
    
    // Filter client's appointments
    clientAppointments = appointments.filter(apt => apt.client_id === currentChartClient.id);
    
    // Filter client's documents
    clientDocs = assignedDocs.filter(doc => doc.client_id === currentChartClient.id);
    
    // Filter client's invoices
    clientInvoices = invoices.filter(inv => inv.client_id === currentChartClient.id);
    
    // Update overview stats
    const completedAppts = clientAppointments.filter(apt => apt.status === 'completed').length;
    const pendingDocs = clientDocs.filter(doc => doc.status === 'pending').length;
    const totalBilled = clientInvoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
    
    document.getElementById('chartTotalAppts').textContent = clientAppointments.length;
    document.getElementById('chartCompletedAppts').textContent = completedAppts;
    document.getElementById('chartPendingDocs').textContent = pendingDocs;
    document.getElementById('chartTotalBilled').textContent = '$' + totalBilled.toFixed(2);
    
    // Render overview content
    renderClientOverview();
}

function renderClientOverview() {
    const container = document.getElementById('chartOverviewContent');
    
    // Show recent activity
    let html = '<div class="card"><h3> Recent Activity</h3>';
    
    // Get recent appointments
    const recentAppts = clientAppointments
        .sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date))
        .slice(0, 5);
    
    if (recentAppts.length > 0) {
        html += '<h4 style="margin-top: 20px; color: #E85D4F;">Recent Appointments</h4>';
        recentAppts.forEach(apt => {
            html += `<div style="padding: 10px; border-bottom: 1px solid #eee;">
                ${new Date(apt.appointment_date).toLocaleDateString()} at ${apt.appointment_time} - ${apt.type}
                <span style="float: right; color: #27ae60;">${apt.status}</span>
            </div>`;
        });
    }
    
    // Get recent documents
    const recentDocs = clientDocs
        .sort((a, b) => new Date(b.assigned_at) - new Date(a.assigned_at))
        .slice(0, 5);
    
    if (recentDocs.length > 0) {
        html += '<h4 style="margin-top: 20px; color: #E85D4F;">Recent Documents</h4>';
        recentDocs.forEach(doc => {
            const statusColor = doc.status === 'completed' ? '#27ae60' : '#e67e22';
            html += `<div style="padding: 10px; border-bottom: 1px solid #eee;">
                ${doc.template_name}
                <span style="float: right; color: ${statusColor};">${doc.status}</span>
            </div>`;
        });
    }
    
    html += '</div>';
    container.innerHTML = html;
}

function renderClientAppointmentsList() {
    const container = document.getElementById('clientAppointmentsList');
    
    if (clientAppointments.length === 0) {
        container.innerHTML = '<p>No appointments scheduled.</p>';
        return;
    }
    
    const sortedAppointments = clientAppointments.sort((a, b) => {
        const dateA = new Date(`${a.appointment_date} ${a.appointment_time}`);
        const dateB = new Date(`${b.appointment_date} ${b.appointment_time}`);
        return dateB - dateA;
    });
    
    container.innerHTML = '<h3>Session History</h3>' + sortedAppointments.map(apt => {
        const statusClass = apt.status === 'completed' ? 'success' : apt.status === 'cancelled' ? 'danger' : 'warning';
        const hasClinicalNotes = apt.clinical_notes && apt.clinical_notes.trim().length > 0;
        const hasSignature = apt.clinical_signature && apt.clinical_signature_timestamp;
        
        // Create session summary (first 150 characters)
        let sessionSummary = 'No clinical notes recorded';
        if (hasClinicalNotes) {
            const lines = apt.clinical_notes.split('\n');
            sessionSummary = lines.slice(0, 3).join(' ').substring(0, 150);
            if (apt.clinical_notes.length > 150) sessionSummary += '...';
        }
        
        return `<div class="session-item" data-session-id="${apt.id}">
                    <div class="session-header" onclick="toggleSessionDetails(${apt.id})">
                        <div class="session-info">
                            <h4>${new Date(apt.appointment_date).toLocaleDateString()} at ${apt.appointment_time}</h4>
                            <p class="session-type">${apt.type}  ${apt.duration} min</p>
                            <p class="session-summary">${sessionSummary}</p>
                        </div>
                        <div class="session-status">
                            <span class="btn btn-${statusClass} btn-small">${apt.status}</span>
                            <span class="session-toggle"></span>
                        </div>
                    </div>
                    <div class="session-details" id="session-details-${apt.id}" style="display: none;">
                        <div class="session-detail-section">
                            <h5>Session Details</h5>
                            <div class="detail-row">
                                <span class="detail-label">Date:</span>
                                <span class="detail-value">${new Date(apt.appointment_date).toLocaleDateString()}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Time:</span>
                                <span class="detail-value">${apt.appointment_time}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Duration:</span>
                                <span class="detail-value">${apt.duration} minutes</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Type:</span>
                                <span class="detail-value">${apt.type}</span>
                            </div>
                            ${apt.notes ? `
                            <div class="detail-row">
                                <span class="detail-label">Notes:</span>
                                <span class="detail-value">${apt.notes}</span>
                            </div>
                            ` : ''}
                        </div>
                        ${hasClinicalNotes ? `
                        <div class="session-detail-section">
                            <h5>Clinical Notes</h5>
                            <div class="clinical-notes-display">
                                <pre>${apt.clinical_notes}</pre>
                            </div>
                        </div>
                        ` : '<p style="color: #999; font-style: italic;">No clinical notes recorded for this session</p>'}
                        ${hasSignature ? `
                        <div class="session-detail-section">
                            <h5>Digital Signature</h5>
                            <div class="signature-display">
                                <div class="signature-row">
                                    <span class="detail-label">Clinician:</span>
                                    <span class="detail-value">${apt.clinical_signature}</span>
                                </div>
                                <div class="signature-row">
                                    <span class="detail-label">Signed:</span>
                                    <span class="detail-value">${new Date(apt.clinical_signature_timestamp).toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                        ` : `
                        <div class="session-detail-section">
                            <h5>Digital Signature</h5>
                            <p style="color: #d32f2f; font-style: italic;"> Not signed</p>
                        </div>
                        `}
                    </div>
                </div>`;
    }).join('');
}

function toggleSessionDetails(sessionId) {
    const detailsDiv = document.getElementById(`session-details-${sessionId}`);
    const sessionItem = document.querySelector(`[data-session-id="${sessionId}"]`);
    const toggle = sessionItem.querySelector('.session-toggle');
    
    if (detailsDiv.style.display === 'none') {
        detailsDiv.style.display = 'block';
        toggle.textContent = '';
    } else {
        detailsDiv.style.display = 'none';
        toggle.textContent = '';
    }
}

function renderClientDocuments() {
    const container = document.getElementById('chartDocumentsContent');
    
    if (clientDocs.length === 0) {
        container.innerHTML = '<div class="card"><p>No documents assigned to this client.</p></div>';
        return;
    }
    
    const pending = clientDocs.filter(d => d.status === 'pending');
    const completed = clientDocs.filter(d => d.status === 'completed');
    
    let html = '';
    
    if (pending.length > 0) {
        html += '<div class="card"><h3 style="color: #e67e22;"> Pending Documents</h3>';
        pending.forEach(d => {
            html += `<div style="padding: 15px; border-bottom: 1px solid #eee;">
                <h4>${d.template_name}</h4>
                <p>Assigned: ${new Date(d.assigned_at).toLocaleDateString()}</p>
                <p>Auth Code: <code>${d.auth_code}</code></p>
            </div>`;
        });
        html += '</div>';
    }
    
    if (completed.length > 0) {
        html += '<div class="card" style="margin-top: 20px;"><h3 style="color: #27ae60;"> Completed Documents</h3>';
        completed.forEach(d => {
            html += `<div style="padding: 15px; border-bottom: 1px solid #eee;">
                <h4>${d.template_name}</h4>
                <p>Completed: ${new Date(d.completed_at).toLocaleDateString()}</p>
            </div>`;
        });
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function renderClientInvoices() {
    const container = document.getElementById('chartInvoicesContent');
    
    if (clientInvoices.length === 0) {
        container.innerHTML = '<div class="card"><p>No invoices for this client.</p></div>';
        return;
    }
    
    const html = '<div class="invoices-grid">' + clientInvoices.map(invoice => {
        const statusClass = invoice.status;
        const dueDate = new Date(invoice.due_date);
        const isOverdue = invoice.status === 'pending' && dueDate < new Date();
        const displayStatus = isOverdue ? 'overdue' : invoice.status;
        
        return `<div class="invoice-card">
                    <div class="invoice-header">
                        <span class="invoice-number">${invoice.invoice_number}</span>
                        <span class="invoice-status ${displayStatus}">${displayStatus.toUpperCase()}</span>
                    </div>
                    <div class="invoice-amount">$${parseFloat(invoice.total_amount).toFixed(2)}</div>
                    <div class="invoice-details">
                        <p>Due: ${new Date(invoice.due_date).toLocaleDateString()}</p>
                        <p>Created: ${new Date(invoice.created_at).toLocaleDateString()}</p>
                        ${invoice.payment_date ? `<p>Paid: ${new Date(invoice.payment_date).toLocaleDateString()}</p>` : ''}
                    </div>
                    <div class="invoice-actions">
                        <button onclick="viewInvoice(${invoice.id})" class="btn btn-small">View</button>
                        ${invoice.status === 'pending' ? 
                            `<button onclick="markPaid(${invoice.id})" class="btn btn-success btn-small">Mark Paid</button>` : 
                            ''
                        }
                    </div>
                </div>`;
    }).join('') + '</div>';
    
    container.innerHTML = html;
}

function renderClientNotes() {
    const container = document.getElementById('chartNotesContent');
    container.innerHTML = '<div class="card"><p>Clinical notes feature coming soon...</p></div>';
}


// Quick actions from chart
function scheduleFromChart() {
    if (!currentChartClient) return;
    closeModal('clientChartModal');
    openNewAppointment();
    document.getElementById('appointmentClient').value = currentChartClient.id;
}

function assignDocFromChart() {
    if (!currentChartClient) return;
    closeModal('clientChartModal');
    openAssignDoc();
    document.getElementById('assignClient').value = currentChartClient.id;
}

// Enhanced Document Assignment Functions
function toggleAssignMode() {
    const singleMode = document.querySelector('input[name="assignMode"][value="single"]').checked;
    const singleSection = document.getElementById('singleClientSection');
    const bulkSection = document.getElementById('bulkClientSection');
    const bulkBtn = document.getElementById('bulkAssignBtn');
    
    if (singleMode) {
        singleSection.style.display = 'block';
        bulkSection.style.display = 'none';
        bulkBtn.style.display = 'none';
    } else {
        singleSection.style.display = 'none';
        bulkSection.style.display = 'block';
        bulkBtn.style.display = 'inline-block';
        populateClientCheckboxes();
    }
}

function populateClientCheckboxes() {
    const container = document.getElementById('clientCheckboxContainer');
    container.innerHTML = clients.map(c => `
        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <input type="checkbox" class="client-checkbox" value="${c.id}">
            <span>${c.name} (${c.email})</span>
        </label>
    `).join('');
}

function selectAllClients() {
    document.querySelectorAll('.client-checkbox').forEach(cb => cb.checked = true);
}

function deselectAllClients() {
    document.querySelectorAll('.client-checkbox').forEach(cb => cb.checked = false);
}

function openBulkAssignModal() {
    const selectedClients = Array.from(document.querySelectorAll('.client-checkbox:checked')).map(cb => parseInt(cb.value));
    const selectedTemplates = Array.from(document.querySelectorAll('.doc-checkbox:checked')).map(cb => cb.value);
    
    if (selectedClients.length === 0) {
        alert('Please select at least one client');
        return;
    }
    
    if (selectedTemplates.length === 0) {
        alert('Please select at least one document template');
        return;
    }
    
    const expirationDays = parseInt(document.getElementById('expirationDays').value) || 30;
    
    if (confirm(`Assign ${selectedTemplates.length} document(s) to ${selectedClients.length} client(s)? This will create ${selectedClients.length * selectedTemplates.length} total document assignments.`)) {
        const bulkDocs = bulkAssignDocuments(selectedClients, selectedTemplates, expirationDays);
        
        // Show success modal with summary
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2> Bulk Assignment Complete!</h2>
                <div style="background: #E8F5E8; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: var(--primary-color);">Assignment Summary:</h3>
                    <p><strong>Clients:</strong> ${selectedClients.length}</p>
                    <p><strong>Templates:</strong> ${selectedTemplates.length}</p>
                    <p><strong>Total Documents:</strong> ${bulkDocs.length}</p>
                    <p><strong>Expiration:</strong> ${expirationDays} days</p>
                </div>
                <div style="margin: 20px 0;">
                    <p><strong>Generated Auth Codes:</strong></p>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #f8f9fa;">
                        ${bulkDocs.map(doc => `
                            <div style="margin-bottom: 5px;">
                                <strong>${doc.client_name}:</strong> ${doc.auth_code}
                            </div>
                        `).join('')}
                    </div>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="btn btn-primary">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
        
        closeModal('assignDocModal');
        renderDocs();
        updateDocBadge();
    }
}

function createInvoiceFromChart() {
    if (!currentChartClient) return;
    closeModal('clientChartModal');
    openNewInvoice();
    document.getElementById('invoiceClient').value = currentChartClient.id;
}

function openEditClientFromChart() {
    if (!currentChartClient) return;
    closeModal('clientChartModal');
    openEditClient(currentChartClient.id);
}

function renderDocs() {
    const container = document.getElementById('docsList');
    
    // Load documents from localStorage if not already loaded
    if (assignedDocs.length === 0) {
        assignedDocs = loadFromStorage('assignedDocs') || [];
    }
    
    if (assignedDocs.length === 0) {
        container.innerHTML = '<div class="card"><p>No documents assigned</p></div>';
        return;
    }
    
    const pending = assignedDocs.filter(d => d.status === 'pending');
    const completed = assignedDocs.filter(d => d.status === 'completed');
    
    let html = '';
    if (pending.length > 0) {
        html += '<div class="card"><h3 style="color: #e67e22;"> Pending (' + pending.length + ')</h3><table style="width: 100%;"><thead><tr><th>Document</th><th>Client</th><th>Code</th></tr></thead><tbody>';
        pending.forEach(d => html += `<tr><td>${d.template_name}</td><td>${d.client_name}</td><td><code>${d.auth_code}</code></td></tr>`);
        html += '</tbody></table></div>';
    }
    
    if (completed.length > 0) {
        html += '<div class="card" style="margin-top: 20px;"><h3 style="color: #27ae60;"> Completed (' + completed.length + ')</h3><table style="width: 100%;"><thead><tr><th>Document</th><th>Client</th><th>Completed</th></tr></thead><tbody>';
        completed.forEach(d => html += `<tr><td>${d.template_name}</td><td>${d.client_name}</td><td>${new Date(d.completed_at).toLocaleDateString()}</td></tr>`);
        html += '</tbody></table></div>';
    }
    
    container.innerHTML = html;
}

function openAssignDoc() {
    const select = document.getElementById('assignClient');
    select.innerHTML = '<option value="">Select Client</option>' + 
        clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    const container = document.getElementById('templateCheckboxContainer');
    container.innerHTML = Object.keys(documentTemplates).map(id => {
        const t = documentTemplates[id];
        return `<label style="display: block; margin-bottom: 10px; cursor: pointer; padding: 8px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#e8f4f8'" onmouseout="this.style.background='transparent'">
            <input type="checkbox" value="${id}" class="doc-checkbox" style="margin-right: 8px;" onchange="updateSelectedCount()">
            <span style="font-weight: 500;">${t.name}</span>
        </label>`;
    }).join('');
    
    updateSelectedCount();
    document.getElementById('assignDocModal').style.display = 'block';
}

function selectAllDocs() {
    document.querySelectorAll('.doc-checkbox').forEach(cb => cb.checked = true);
    updateSelectedCount();
}

function deselectAllDocs() {
    document.querySelectorAll('.doc-checkbox').forEach(cb => cb.checked = false);
    updateSelectedCount();
}

function updateSelectedCount() {
    const count = document.querySelectorAll('.doc-checkbox:checked').length;
    const countEl = document.getElementById('selectedCount');
    if (count === 0) {
        countEl.textContent = 'No documents selected';
        countEl.style.color = '#999';
    } else {
        countEl.textContent = ` ${count} document${count > 1 ? 's' : ''} selected`;
        countEl.style.color = '#E85D4F';
    }
}

async function saveAssignDoc() {
    const clientId = document.getElementById('assignClient').value;
    const selected = Array.from(document.querySelectorAll('.doc-checkbox:checked')).map(cb => cb.value);
    
    if (!clientId || selected.length === 0) {
        return alert('Please select client and documents');
    }
    
    const code = generateAuthCode();
    const client = clients.find(c => c.id == clientId);
    const clientName = client ? client.name : 'Unknown Client';
    
    try {
        const created = [];
        for (const templateId of selected) {
            const doc = {
                id: Date.now() + Math.random(),
                    client_id: clientId,
                    client_name: clientName,
                    template_id: templateId,
                    template_name: templateNames[templateId],
                auth_code: code,
                status: 'pending',
                assigned_date: new Date().toISOString()
            };
            assignedDocs.push(doc);
            created.push(templateNames[templateId]);
            await logAudit('assign_document', { id: doc.id, code });
        }
        
        closeModal('assignDocModal');
        document.getElementById('generatedCode').textContent = code;
        document.getElementById('assignedDocsList').innerHTML = '<p><strong>Assigned:</strong></p><ul>' +
            created.map(name => `<li>${name}</li>`).join('') + '</ul>';
        document.getElementById('successModal').style.display = 'block';
        renderDocs();
        updateDocBadge();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function generateAuthCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 3; i++) code += chars[Math.floor(Math.random() * chars.length)];
    code += '-';
    for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
    return code;
}

async function renderAudit() {
    try {
        // Load audit logs from localStorage - FIX: use correct key 'audit_logs'
        const logs = loadFromStorage('audit_logs', []) || [];
        const container = document.getElementById('auditList');
        
        if (logs.length === 0) {
            container.innerHTML = '<div class="card"><p>No audit logs found</p></div>';
            return;
        }
        
        // Sort by timestamp, newest first
        logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        container.innerHTML = '<div class="card"><table style="width: 100%;"><thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead><tbody>' +
            logs.map(l => `<tr><td>${new Date(l.timestamp).toLocaleString()}</td><td>${l.user_name || 'System'}</td><td>${l.action}</td><td>${JSON.stringify(l.details || {})}</td></tr>`).join('') +
            '</tbody></table></div>';
    } catch (error) {
        console.error('Audit error:', error);
        document.getElementById('auditList').innerHTML = '<div class="card"><p>Error loading audit logs</p></div>';
    }
}

async function logAudit(action, details = {}, userName = null) {
    try {
        // Save audit log to localStorage
        logLocalAudit(action, details, userName || currentUser?.name);
    } catch (error) {
        console.error('Log error:', error);
    }
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

// New Features JavaScript
let appointments = [];
let invoices = [];
let analyticsData = {};
let currentCalendarDate = new Date();
let calendarViewMode = 'month'; // month, week, day

// Analytics Dashboard
async function loadAnalytics() {
    const timeframe = document.getElementById('timeframeSelect').value;
    try {
        document.getElementById('analyticsContent').innerHTML = '<div class="loading">Loading analytics...</div>';
        
        // Generate comprehensive analytics from localStorage data
        const data = generateComprehensiveAnalytics(timeframe);
        analyticsData = data;
        renderAnalytics(data);
    } catch (error) {
        console.error('Analytics error:', error);
        document.getElementById('analyticsContent').innerHTML = '<div class="card"><p>Error loading analytics</p></div>';
    }
}

function generateComprehensiveAnalytics(timeframe) {
    const now = new Date();
    const daysAgo = parseInt(timeframe);
    const startDate = new Date(now.getTime() - (daysAgo * 24 * 60 * 60 * 1000));
    
    // Filter data by timeframe
    const recentAppointments = appointments.filter(apt => {
        const aptDate = new Date(apt.appointment_date);
        return aptDate >= startDate;
    });
    
    const recentInvoices = invoices.filter(inv => {
        const invDate = new Date(inv.created_at);
        return invDate >= startDate;
    });
    
    // Overview statistics
    const overview = {
        total_clients: clients.length,
        active_clients: clients.filter(c => c.status === 'active').length,
        upcoming_appointments: appointments.filter(apt => new Date(apt.appointment_date) >= now).length,
        pending_documents: assignedDocs.filter(doc => doc.status === 'pending').length,
        completed_documents: assignedDocs.filter(doc => doc.status === 'completed').length,
        total_revenue: invoices.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0),
        paid_revenue: invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0),
        appointment_completion_rate: calculateAppointmentCompletionRate(),
        document_completion_rate: calculateDocumentCompletionRate()
    };
    
    // Trends data
    const trends = {
        monthly_appointments: generateMonthlyAppointmentTrends(daysAgo),
        weekly_revenue: generateWeeklyRevenueTrends(daysAgo),
        top_clients: generateTopClients(),
        appointment_types: generateAppointmentTypeBreakdown(),
        document_completion_trends: generateDocumentCompletionTrends(daysAgo),
        client_demographics: generateClientDemographics(),
        revenue_by_month: generateRevenueByMonth(daysAgo)
    };
    
    return { overview, trends, timeframe };
}

// Analytics Helper Functions
function calculateAppointmentCompletionRate() {
    const totalAppointments = appointments.length;
    if (totalAppointments === 0) return 0;
    
    const completedAppointments = appointments.filter(apt => {
        const aptDate = new Date(apt.appointment_date);
        return aptDate < new Date(); // Past appointments are considered completed
    }).length;
    
    return Math.round((completedAppointments / totalAppointments) * 100);
}

function calculateDocumentCompletionRate() {
    const totalDocs = assignedDocs.length;
    if (totalDocs === 0) return 0;
    
    const completedDocs = assignedDocs.filter(doc => doc.status === 'completed').length;
    return Math.round((completedDocs / totalDocs) * 100);
}

function generateMonthlyAppointmentTrends(daysAgo) {
    const months = [];
    const now = new Date();
    
    for (let i = 0; i < Math.ceil(daysAgo / 30); i++) {
        const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthAppointments = appointments.filter(apt => {
            const aptDate = new Date(apt.appointment_date);
            return aptDate.getMonth() === monthDate.getMonth() && 
                   aptDate.getFullYear() === monthDate.getFullYear();
        }).length;
        
        months.unshift({
            month: monthDate.toISOString(),
            appointment_count: monthAppointments
        });
    }
    
    return months;
}

function generateWeeklyRevenueTrends(daysAgo) {
    const weeks = [];
    const now = new Date();
    
    for (let i = 0; i < Math.ceil(daysAgo / 7); i++) {
        const weekStart = new Date(now.getTime() - (i * 7 * 24 * 60 * 60 * 1000));
        const weekEnd = new Date(weekStart.getTime() + (7 * 24 * 60 * 60 * 1000));
        
        const weekRevenue = invoices.filter(inv => {
            const invDate = new Date(inv.created_at);
            return invDate >= weekStart && invDate < weekEnd && inv.status === 'paid';
        }).reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);
        
        weeks.unshift({
            week_start: weekStart.toISOString(),
            revenue: weekRevenue
        });
    }
    
    return weeks;
}

function generateTopClients() {
    const clientStats = {};
    
    appointments.forEach(apt => {
        if (!clientStats[apt.client_id]) {
            clientStats[apt.client_id] = {
                id: apt.client_id,
                name: apt.client_name || 'Unknown',
                appointment_count: 0,
                total_revenue: 0
            };
        }
        clientStats[apt.client_id].appointment_count++;
    });
    
    invoices.forEach(inv => {
        if (clientStats[inv.client_id]) {
            clientStats[inv.client_id].total_revenue += parseFloat(inv.total_amount) || 0;
        }
    });
    
    return Object.values(clientStats)
        .sort((a, b) => b.appointment_count - a.appointment_count)
        .slice(0, 5);
}

function generateAppointmentTypeBreakdown() {
    const types = {};
    
    appointments.forEach(apt => {
        const type = apt.notes ? apt.notes.split(' ')[0] : 'General';
        types[type] = (types[type] || 0) + 1;
    });
    
    return Object.entries(types)
        .map(([type, count]) => ({ type, count }))
        .sort((a, b) => b.count - a.count);
}

function generateDocumentCompletionTrends(daysAgo) {
    const trends = [];
    const now = new Date();
    
    for (let i = 0; i < Math.ceil(daysAgo / 7); i++) {
        const weekStart = new Date(now.getTime() - (i * 7 * 24 * 60 * 60 * 1000));
        const weekEnd = new Date(weekStart.getTime() + (7 * 24 * 60 * 60 * 1000));
        
        const weekCompleted = assignedDocs.filter(doc => {
            if (!doc.completed_at) return false;
            const completedDate = new Date(doc.completed_at);
            return completedDate >= weekStart && completedDate < weekEnd;
        }).length;
        
        trends.unshift({
            week_start: weekStart.toISOString(),
            completed_documents: weekCompleted
        });
    }
    
    return trends;
}

function generateClientDemographics() {
    const demographics = {
        by_age: { '18-25': 0, '26-35': 0, '36-45': 0, '46-55': 0, '56-65': 0, '65+': 0 },
        by_status: { active: 0, inactive: 0 },
        new_vs_returning: { new: 0, returning: 0 }
    };
    
    clients.forEach(client => {
        // Status breakdown
        demographics.by_status[client.status || 'active']++;
        
        // New vs returning (simplified logic)
        const clientAppointments = appointments.filter(apt => apt.client_id === client.id);
        if (clientAppointments.length > 1) {
            demographics.new_vs_returning.returning++;
        } else {
            demographics.new_vs_returning.new++;
        }
    });
    
    return demographics;
}

function generateRevenueByMonth(daysAgo) {
    const months = [];
    const now = new Date();
    
    for (let i = 0; i < Math.ceil(daysAgo / 30); i++) {
        const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const monthRevenue = invoices.filter(inv => {
            const invDate = new Date(inv.created_at);
            return invDate.getMonth() === monthDate.getMonth() && 
                   invDate.getFullYear() === monthDate.getFullYear() &&
                   inv.status === 'paid';
        }).reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);
        
        months.unshift({
            month: monthDate.toISOString(),
            revenue: monthRevenue
        });
    }
    
    return months;
}

function renderAnalytics(data) {
    const { overview, trends } = data;
    
    // Update stat cards with enhanced data
    document.getElementById('totalClients').textContent = overview.total_clients;
    document.getElementById('upcomingAppointments').textContent = overview.upcoming_appointments;
    document.getElementById('pendingDocuments').textContent = overview.pending_documents;
    document.getElementById('totalRevenue').textContent = `$${overview.total_revenue.toFixed(2)}`;
    
    // Enhanced analytics display
    const analyticsContent = document.getElementById('analyticsContent');
    analyticsContent.innerHTML = `
        <div class="analytics-grid">
            <!-- Overview Stats -->
            <div class="stat-card">
                <h3> Overview</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Clients:</span>
                    <span class="stat-value">${overview.total_clients}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Active Clients:</span>
                    <span class="stat-value">${overview.active_clients}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Appointment Completion Rate:</span>
                    <span class="stat-value">${overview.appointment_completion_rate}%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Document Completion Rate:</span>
                    <span class="stat-value">${overview.document_completion_rate}%</span>
                </div>
            </div>
            
            <!-- Revenue Stats -->
            <div class="stat-card">
                <h3> Revenue</h3>
                <div class="stat-item">
                    <span class="stat-label">Total Revenue:</span>
                    <span class="stat-value">$${overview.total_revenue.toFixed(2)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Paid Revenue:</span>
                    <span class="stat-value">$${overview.paid_revenue.toFixed(2)}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Outstanding:</span>
                    <span class="stat-value">$${(overview.total_revenue - overview.paid_revenue).toFixed(2)}</span>
                </div>
            </div>
            
            <!-- Documents Stats -->
            <div class="stat-card">
                <h3> Documents</h3>
                <div class="stat-item">
                    <span class="stat-label">Pending:</span>
                    <span class="stat-value">${overview.pending_documents}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Completed:</span>
                    <span class="stat-value">${overview.completed_documents}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value">${overview.pending_documents + overview.completed_documents}</span>
                </div>
            </div>
            
            <!-- Appointments Stats -->
            <div class="stat-card">
                <h3> Appointments</h3>
                <div class="stat-item">
                    <span class="stat-label">Upcoming:</span>
                    <span class="stat-value">${overview.upcoming_appointments}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Total:</span>
                    <span class="stat-value">${appointments.length}</span>
                </div>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-row">
                <!-- Monthly Appointments Chart -->
                <div class="chart-card">
                    <h3> Monthly Appointments</h3>
                    <div id="monthlyChart" class="chart-container">
                        ${renderMonthlyChart(trends.monthly_appointments)}
                    </div>
                </div>
                
                <!-- Revenue Chart -->
                <div class="chart-card">
                    <h3> Revenue Trends</h3>
                    <div id="revenueChart" class="chart-container">
                        ${renderRevenueChart(trends.revenue_by_month)}
                    </div>
                </div>
            </div>
            
            <div class="chart-row">
                <!-- Top Clients -->
                <div class="chart-card">
                    <h3> Top Clients</h3>
                    <div id="topClientsList" class="chart-container">
                        ${renderTopClients(trends.top_clients)}
                    </div>
                </div>
                
                <!-- Client Demographics -->
                <div class="chart-card">
                    <h3> Client Demographics</h3>
                    <div class="chart-container">
                        ${renderClientDemographics(trends.client_demographics)}
                    </div>
                </div>
            </div>
            
            <div class="chart-row">
                <!-- Document Completion Trends -->
                <div class="chart-card">
                    <h3> Document Completion</h3>
                    <div class="chart-container">
                        ${renderDocumentTrends(trends.document_completion_trends)}
                    </div>
                </div>
                
                <!-- Appointment Types -->
                <div class="chart-card">
                    <h3> Appointment Types</h3>
                    <div class="chart-container">
                        ${renderAppointmentTypes(trends.appointment_types)}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Export Options -->
        <div class="export-section">
            <h3> Export Data</h3>
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button onclick="exportAnalyticsToCSV()" class="btn btn-primary">Export to CSV</button>
                <button onclick="exportAnalyticsToJSON()" class="btn btn-secondary">Export to JSON</button>
                <button onclick="printAnalytics()" class="btn btn-secondary">Print Report</button>
            </div>
        </div>
    `;
}

// Chart Rendering Functions
function renderMonthlyChart(data) {
    if (data.length === 0) return '<p>No data available</p>';
    
    const maxValue = Math.max(...data.map(item => item.appointment_count));
    
    return data.map(item => {
        const month = new Date(item.month).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        const percentage = maxValue > 0 ? (item.appointment_count / maxValue) * 100 : 0;
        
        return `
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>${month}</span>
                    <span style="font-weight: bold; color: var(--primary-color);">${item.appointment_count}</span>
                </div>
                <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: var(--primary-color); height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                </div>
            </div>
        `;
    }).join('');
}

function renderRevenueChart(data) {
    if (data.length === 0) return '<p>No revenue data available</p>';
    
    const maxValue = Math.max(...data.map(item => item.revenue));
    
    return data.map(item => {
        const month = new Date(item.month).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        const percentage = maxValue > 0 ? (item.revenue / maxValue) * 100 : 0;
        
        return `
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>${month}</span>
                    <span style="font-weight: bold; color: var(--primary-color);">$${item.revenue.toFixed(2)}</span>
                </div>
                <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #28a745; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                </div>
            </div>
        `;
    }).join('');
}

function renderTopClients(data) {
    if (data.length === 0) return '<p>No client data available</p>';
    
    return data.map((client, index) => {
        const rank = index + 1;
        const rankEmoji = rank === 1 ? '' : rank === 2 ? '' : rank === 3 ? '' : `${rank}.`;
        
        return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee;">
                <div>
                    <span style="margin-right: 10px;">${rankEmoji}</span>
                    <span style="font-weight: bold;">${client.name}</span>
                </div>
                <div style="text-align: right;">
                    <div style="color: var(--primary-color); font-weight: bold;">${client.appointment_count} appointments</div>
                    <div style="color: #666; font-size: 12px;">$${client.total_revenue.toFixed(2)}</div>
                </div>
            </div>
        `;
    }).join('');
}

function renderClientDemographics(data) {
    const statusData = Object.entries(data.by_status);
    const newVsReturning = Object.entries(data.new_vs_returning);
    
    return `
        <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 10px; color: var(--primary-color);">Client Status</h4>
            ${statusData.map(([status, count]) => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="text-transform: capitalize;">${status}:</span>
                    <span style="font-weight: bold;">${count}</span>
                </div>
            `).join('')}
        </div>
        <div>
            <h4 style="margin-bottom: 10px; color: var(--primary-color);">Client Type</h4>
            ${newVsReturning.map(([type, count]) => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="text-transform: capitalize;">${type}:</span>
                    <span style="font-weight: bold;">${count}</span>
                </div>
            `).join('')}
        </div>
    `;
}

function renderDocumentTrends(data) {
    if (data.length === 0) return '<p>No document data available</p>';
    
    const maxValue = Math.max(...data.map(item => item.completed_documents));
    
    return data.map(item => {
        const week = new Date(item.week_start).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const percentage = maxValue > 0 ? (item.completed_documents / maxValue) * 100 : 0;
        
        return `
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span>Week of ${week}</span>
                    <span style="font-weight: bold; color: var(--primary-color);">${item.completed_documents}</span>
                </div>
                <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #17a2b8; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                </div>
            </div>
        `;
    }).join('');
}

function renderAppointmentTypes(data) {
    if (data.length === 0) return '<p>No appointment type data available</p>';
    
    const total = data.reduce((sum, item) => sum + item.count, 0);
    
    return data.map(item => {
        const percentage = total > 0 ? (item.count / total) * 100 : 0;
        
        return `
            <div style="margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="text-transform: capitalize;">${item.type}:</span>
                    <span style="font-weight: bold; color: var(--primary-color);">${item.count}</span>
                </div>
                <div style="background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
                    <div style="background: #ffc107; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                </div>
            </div>
        `;
    }).join('');
}

// Export Functions
function exportAnalyticsToCSV() {
    const data = generateComprehensiveAnalytics(document.getElementById('timeframeSelect').value);
    let csv = 'Analytics Report\n\n';
    
    // Overview section
    csv += 'OVERVIEW\n';
    csv += 'Metric,Value\n';
    csv += `Total Clients,${data.overview.total_clients}\n`;
    csv += `Active Clients,${data.overview.active_clients}\n`;
    csv += `Appointment Completion Rate,${data.overview.appointment_completion_rate}%\n`;
    csv += `Document Completion Rate,${data.overview.document_completion_rate}%\n`;
    csv += `Total Revenue,$${data.overview.total_revenue.toFixed(2)}\n`;
    csv += `Paid Revenue,$${data.overview.paid_revenue.toFixed(2)}\n\n`;
    
    // Top clients
    csv += 'TOP CLIENTS\n';
    csv += 'Rank,Name,Appointments,Revenue\n';
    data.trends.top_clients.forEach((client, index) => {
        csv += `${index + 1},${client.name},${client.appointment_count},$${client.total_revenue.toFixed(2)}\n`;
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analytics-report-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    logLocalAudit('analytics_export_csv', { timeframe: data.timeframe });
}

function exportAnalyticsToJSON() {
    const data = generateComprehensiveAnalytics(document.getElementById('timeframeSelect').value);
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `analytics-report-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    logLocalAudit('analytics_export_json', { timeframe: data.timeframe });
}

function printAnalytics() {
    const printWindow = window.open('', '_blank');
    const data = generateComprehensiveAnalytics(document.getElementById('timeframeSelect').value);
    
    const printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>ClinicalSpeak Analytics Report</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #00a86b; padding-bottom: 20px; }
                .section { margin-bottom: 30px; }
                .section h2 { color: #00a86b; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
                .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
                .stat-item { display: flex; justify-content: space-between; margin-bottom: 10px; }
                .stat-label { font-weight: bold; }
                .stat-value { color: #00a86b; font-weight: bold; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ClinicalSpeak Analytics Report</h1>
                <p>Generated on: ${new Date().toLocaleDateString()}</p>
                <p>Timeframe: Last ${data.timeframe} days</p>
            </div>
            
            <div class="section">
                <h2>Overview Statistics</h2>
                <div class="stat-grid">
                    <div>
                        <div class="stat-item"><span class="stat-label">Total Clients:</span><span class="stat-value">${data.overview.total_clients}</span></div>
                        <div class="stat-item"><span class="stat-label">Active Clients:</span><span class="stat-value">${data.overview.active_clients}</span></div>
                        <div class="stat-item"><span class="stat-label">Upcoming Appointments:</span><span class="stat-value">${data.overview.upcoming_appointments}</span></div>
                    </div>
                    <div>
                        <div class="stat-item"><span class="stat-label">Total Revenue:</span><span class="stat-value">$${data.overview.total_revenue.toFixed(2)}</span></div>
                        <div class="stat-item"><span class="stat-label">Paid Revenue:</span><span class="stat-value">$${data.overview.paid_revenue.toFixed(2)}</span></div>
                        <div class="stat-item"><span class="stat-label">Outstanding:</span><span class="stat-value">$${(data.overview.total_revenue - data.overview.paid_revenue).toFixed(2)}</span></div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>Top Clients</h2>
                ${data.trends.top_clients.map((client, index) => `
                    <div class="stat-item">
                        <span class="stat-label">${index + 1}. ${client.name}:</span>
                        <span class="stat-value">${client.appointment_count} appointments, $${client.total_revenue.toFixed(2)}</span>
                    </div>
                `).join('')}
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
    
    logLocalAudit('analytics_print', { timeframe: data.timeframe });
}

// Appointments Management
async function loadAppointments() {
    try {
        const month = currentCalendarDate.getMonth() + 1;
        const year = currentCalendarDate.getFullYear();
        // Appointments already loaded from localStorage
        renderCalendar();
        renderAppointmentsList();
    } catch (error) {
        console.error('Appointments error:', error);
    }
}

function renderCalendar() {
    const calendar = document.getElementById('calendarView');
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    
    if (calendarViewMode === 'month') {
        renderMonthView(calendar, monthNames);
    } else if (calendarViewMode === 'week') {
        renderWeekView(calendar, monthNames);
    } else if (calendarViewMode === 'day') {
        renderDayView(calendar, monthNames);
    }
}

function renderMonthView(calendar, monthNames) {
    document.getElementById('currentMonth').textContent = 
        `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
    
    const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
    const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    let html = '<div class="calendar-grid">';
    
    // Day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
        html += `<div class="calendar-header">${day}</div>`;
    });
    
    // Calendar days
    for (let i = 0; i < 42; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        const isCurrentMonth = currentDate.getMonth() === currentCalendarDate.getMonth();
        const isToday = currentDate.toDateString() === new Date().toDateString();
        
        const dateString = currentDate.toISOString().split('T')[0];
        const dayAppointments = appointments.filter(apt => {
            const aptDate = apt.appointment_date.split('T')[0];
            return aptDate === dateString;
        });
        
        let classes = 'calendar-day';
        if (!isCurrentMonth) classes += ' other-month';
        if (isToday) classes += ' today';
        if (dayAppointments.length > 0) classes += ' has-appointment';
        
        html += `<div class="${classes}" onclick="showDayAppointments('${dateString}')" draggable="true" ondragstart="dragStart(event, '${dateString}')" ondragover="dragOver(event)" ondrop="drop(event, '${dateString}')">
                    <div class="day-number">${currentDate.getDate()}</div>
                    ${dayAppointments.length > 0 ? `
                        <div class="appointment-widgets">
                            ${dayAppointments.slice(0, 4).map(apt => `
                                <div class="appointment-widget" onclick="event.stopPropagation(); toggleWidgetExpansion('${dateString}', ${apt.id})" data-appointment-id="${apt.id}">
                                    <div class="widget-content">
                                        <div class="widget-time">${apt.appointment_time}</div>
                                        <div class="widget-initials">
                                            <span class="client-initial">${(apt.client_name || 'U').charAt(0)}</span>
                                            <span class="clinician-initial">D</span>
                                        </div>
                                    </div>
                                    <div class="widget-expanded" style="display: none;">
                                        <div class="expanded-info">
                                            <div class="client-name">${apt.client_name || 'Unknown Client'}</div>
                                            <div class="appointment-type">${apt.type || 'Consultation'}</div>
                                            <div class="appointment-duration">${apt.duration || 60} min</div>
                                            ${apt.notes ? `<div class="appointment-notes">${apt.notes}</div>` : ''}
                                        </div>
                                        <div class="widget-actions">
                                            <button onclick="event.stopPropagation(); editAppointment(${apt.id})" class="btn-widget-edit">Edit</button>
                                            <button onclick="event.stopPropagation(); deleteAppointment(${apt.id})" class="btn-widget-delete">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            ${dayAppointments.length > 4 ? `<div class="more-appointments">+${dayAppointments.length - 4}</div>` : ''}
                        </div>
                    ` : ''}
                </div>`;
    }
    
    html += '</div>';
    calendar.innerHTML = html;
}

function renderWeekView(calendar, monthNames) {
    const weekStart = new Date(currentCalendarDate);
    weekStart.setDate(currentCalendarDate.getDate() - currentCalendarDate.getDay());
    const weekEnd = new Date(weekStart);
    weekEnd.setDate(weekStart.getDate() + 6);
    
    document.getElementById('currentMonth').textContent = 
        `${weekStart.toLocaleDateString()} - ${weekEnd.toLocaleDateString()}`;
    
    let html = '<div class="week-calendar">';
    
    // Hour slots (8 AM to 8 PM)
    const hours = Array.from({length: 13}, (_, i) => i + 8);
    
    html += '<div class="week-grid">';
    html += '<div class="time-column">';
    html += '<div class="time-header">Time</div>';
    hours.forEach(hour => {
        html += `<div class="time-slot">${hour}:00</div>`;
    });
    html += '</div>';
    
    // Day columns
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach((day, dayIndex) => {
        const currentDate = new Date(weekStart);
        currentDate.setDate(weekStart.getDate() + dayIndex);
        const dateString = currentDate.toISOString().split('T')[0];
        
        html += `<div class="day-column">
                    <div class="day-header">
                        <div>${day}</div>
                        <div class="day-number">${currentDate.getDate()}</div>
                    </div>`;
        
        hours.forEach(hour => {
            const timeSlot = `${hour.toString().padStart(2, '0')}:00`;
            const slotAppointments = appointments.filter(apt => {
                const aptDate = apt.appointment_date.split('T')[0];
                return aptDate === dateString && apt.time === timeSlot;
            });
            
            let classes = 'time-slot';
            if (slotAppointments.length > 0) {
                classes += ' has-appointment';
                html += `<div class="${classes}" onclick="showAppointmentDetails(${slotAppointments[0].id})">
                            <div class="appointment-block">${slotAppointments[0].client_name || 'Appointment'}</div>
                        </div>`;
            } else {
                html += `<div class="${classes}" onclick="createAppointmentAtTime('${dateString}', '${timeSlot}')"></div>`;
            }
        });
        
        html += '</div>';
    });
    
    html += '</div></div>';
    calendar.innerHTML = html;
}

function renderDayView(calendar, monthNames) {
    const dateString = currentCalendarDate.toISOString().split('T')[0];
    document.getElementById('currentMonth').textContent = 
        `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getDate()}, ${currentCalendarDate.getFullYear()}`;
    
    const dayAppointments = appointments.filter(apt => {
        const aptDate = apt.appointment_date.split('T')[0];
        return aptDate === dateString;
    }).sort((a, b) => a.time.localeCompare(b.time));
    
    let html = '<div class="day-view">';
    html += '<div class="day-appointments">';
    
    if (dayAppointments.length === 0) {
        html += '<div class="no-appointments">No appointments scheduled for this day</div>';
    } else {
        dayAppointments.forEach(apt => {
            html += `<div class="day-appointment" onclick="showAppointmentDetails(${apt.id})">
                        <div class="appointment-time">${apt.time}</div>
                        <div class="appointment-details">
                            <div class="client-name">${apt.client_name || 'Unknown Client'}</div>
                            <div class="appointment-notes">${apt.notes || 'No notes'}</div>
                        </div>
                        <div class="appointment-duration">${apt.duration || 60} min</div>
                    </div>`;
        });
    }
    
    html += '</div>';
    html += '<div class="day-actions">';
    html += '<button onclick="createAppointmentAtTime(\'' + dateString + '\', \'09:00\')" class="btn btn-primary">+ Add Appointment</button>';
    html += '</div>';
    html += '</div>';
    
    calendar.innerHTML = html;
}

function renderAppointmentsList() {
    const container = document.getElementById('appointmentsList');
    if (appointments.length === 0) {
        container.innerHTML = '<p>No appointments scheduled for this month.</p>';
        return;
    }
    
    const sortedAppointments = appointments.sort((a, b) => {
        const dateA = new Date(`${a.appointment_date} ${a.appointment_time}`);
        const dateB = new Date(`${b.appointment_date} ${b.appointment_time}`);
        return dateA - dateB;
    });
    
    container.innerHTML = sortedAppointments.map(apt => {
        const statusClass = apt.status === 'completed' ? 'success' : apt.status === 'cancelled' ? 'danger' : 'warning';
        return `<div class="appointment-item">
                    <div class="appointment-info">
                        <h4 style="cursor: pointer; color: #E85D4F;" onclick="openClientChart(${apt.client_id}); event.stopPropagation();">${apt.client_name}</h4>
                        <p> ${new Date(apt.appointment_date).toLocaleDateString()} at ${apt.appointment_time}</p>
                        <p> ${apt.duration} minutes - ${apt.type}</p>
                        ${apt.notes ? `<p> ${apt.notes}</p>` : ''}
                    </div>
                    <div class="appointment-actions">
                        <span class="btn btn-${statusClass} btn-small">${apt.status}</span>
                        <button onclick="editAppointment(${apt.id})" class="btn btn-small">Edit</button>
                        <button onclick="deleteAppointment(${apt.id})" class="btn btn-danger btn-small">Delete</button>
                    </div>
                </div>`;
    }).join('');
}

function previousMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    loadAppointments();
}

function nextMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    loadAppointments();
}

function setCalendarView(view) {
    calendarViewMode = view;
    
    // Update button states
    document.querySelectorAll('.calendar-view-toggle .btn-sm').forEach(btn => btn.classList.remove('active'));
    document.getElementById(view + 'ViewBtn').classList.add('active');
    
    // Re-render calendar with new view
    renderCalendar();
}

function checkAppointmentConflict(newAppointment) {
    const conflicts = appointments.filter(apt => {
        if (apt.id === newAppointment.id) return false; // Don't conflict with self
        return apt.appointment_date === newAppointment.appointment_date && 
               apt.time === newAppointment.time;
    });
    return conflicts;
}

// Drag and Drop Functions
let draggedAppointment = null;

function dragStart(event, dateString) {
    draggedAppointment = { date: dateString };
    event.dataTransfer.effectAllowed = 'move';
}

function dragOver(event) {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'move';
    event.target.classList.add('drag-over');
}

function drop(event, targetDateString) {
    event.preventDefault();
    event.target.classList.remove('drag-over');
    
    if (draggedAppointment && draggedAppointment.date !== targetDateString) {
        // Move appointments from dragged date to target date
        const appointmentsToMove = appointments.filter(apt => 
            apt.appointment_date === draggedAppointment.date
        );
        
        appointmentsToMove.forEach(apt => {
            apt.appointment_date = targetDateString;
        });
        
        // Save to localStorage
        saveToStorage('appointments', appointments);
        logLocalAudit('appointment_move', { 
            fromDate: draggedAppointment.date, 
            toDate: targetDateString, 
            count: appointmentsToMove.length 
        });
        
        // Re-render calendar
        renderCalendar();
        renderAppointmentsList();
        
        showNotification('Appointments moved successfully', 'success');
    }
    
    draggedAppointment = null;
}

function createAppointmentAtTime(date, time) {
    // Open appointment form with pre-filled date and time
    const clientSelect = document.getElementById('appointmentClient');
    const dateInput = document.getElementById('appointmentDate');
    const timeInput = document.getElementById('appointmentTime');
    
    if (clientSelect && dateInput && timeInput) {
        dateInput.value = date;
        timeInput.value = time;
        openNewAppointment();
    }
}

function showAppointmentDetails(appointmentId) {
    const appointment = appointments.find(apt => apt.id === appointmentId);
    if (appointment) {
        const details = `
            <strong>Client:</strong> ${appointment.client_name || 'Unknown'}<br>
            <strong>Date:</strong> ${new Date(appointment.appointment_date).toLocaleDateString()}<br>
            <strong>Time:</strong> ${appointment.time}<br>
            <strong>Duration:</strong> ${appointment.duration || 60} minutes<br>
            <strong>Notes:</strong> ${appointment.notes || 'No notes'}
        `;
        
        // Create modal for appointment details
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Appointment Details</h3>
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                </div>
                <div class="modal-body">
                    ${details}
                </div>
                <div class="modal-footer">
                    <button onclick="editAppointment(${appointmentId})" class="btn btn-primary">Edit</button>
                    <button onclick="deleteAppointment(${appointmentId})" class="btn btn-danger">Delete</button>
                    <button onclick="this.parentElement.parentElement.remove()" class="btn">Close</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
}

function editAppointment(appointmentId) {
    console.log('Edit appointment called with ID:', appointmentId);
    const appointment = appointments.find(apt => apt.id == appointmentId);
    
    if (!appointment) {
        console.error('Appointment not found:', appointmentId);
        showNotification('Appointment not found', 'error');
        return;
    }
    
    console.log('Found appointment:', appointment);
    
    // Format date for input (YYYY-MM-DD)
    const dateValue = appointment.appointment_date.split('T')[0];
    
    // Populate edit form
    const clientSelect = document.getElementById('appointmentClient');
    if (clientSelect) {
        clientSelect.value = appointment.client_id || '';
    }
    
    const dateInput = document.getElementById('appointmentDate');
    if (dateInput) {
        dateInput.value = dateValue;
    }
    
    const timeInput = document.getElementById('appointmentTime');
    if (timeInput) {
        timeInput.value = appointment.appointment_time || '';
    }
    
    const durationInput = document.getElementById('appointmentDuration');
    if (durationInput) {
        durationInput.value = appointment.duration || 60;
    }
    
    const typeInput = document.getElementById('appointmentType');
    if (typeInput) {
        typeInput.value = appointment.type || '';
    }
    
    const notesInput = document.getElementById('appointmentNotes');
    if (notesInput) {
        notesInput.value = appointment.notes || '';
    }
    
    // Change modal title
    const modalTitle = document.querySelector('#newAppointmentModal h2');
    if (modalTitle) {
        modalTitle.textContent = 'Edit Appointment';
    }
    
    // Store editing ID for save function
    window.editingAppointmentId = appointmentId;
    
    // Open modal
    const modal = document.getElementById('newAppointmentModal');
    if (modal) {
        modal.style.display = 'block';
        console.log('Modal opened successfully');
    } else {
        console.error('Modal not found');
        showNotification('Unable to open edit form', 'error');
    }
}

function deleteAppointment(appointmentId) {
    if (confirm('Are you sure you want to delete this appointment?')) {
        const index = appointments.findIndex(apt => apt.id === appointmentId);
        if (index !== -1) {
            const deleted = appointments.splice(index, 1)[0];
            saveToStorage('appointments', appointments);
            logLocalAudit('appointment_delete', { appointmentId, clientName: deleted.client_name });
            renderCalendar();
            renderAppointmentsList();
            showNotification('Appointment deleted', 'success');
        }
    }
    document.querySelector('.modal')?.remove();
}

function showDayAppointments(date) {
    const dayAppointments = appointments.filter(apt => apt.appointment_date === date);
    if (dayAppointments.length > 0) {
        alert(`Appointments for ${new Date(date).toLocaleDateString()}:\n\n` + 
              dayAppointments.map(apt => `${apt.appointment_time} - ${apt.client_name} (${apt.type})`).join('\n'));
    }
}

function toggleWidgetExpansion(date, appointmentId) {
    // Open the appointment detail panel instead of inline expansion
    openAppointmentDetail(appointmentId);
}

function openAppointmentDetail(appointmentId) {
    // Find the appointment
    const appointment = appointments.find(apt => apt.id == appointmentId);
    if (!appointment) {
        showNotification('Appointment not found', 'error');
        return;
    }
    
    // Show the appointment detail panel
    const panel = document.getElementById('appointmentDetailPanel');
    if (panel) {
        // Populate appointment details
        document.getElementById('detailClientName').textContent = appointment.client_name || 'Unknown Client';
        document.getElementById('detailClientEmail').textContent = appointment.client_email || 'N/A';
        document.getElementById('detailClientPhone').textContent = appointment.client_phone || 'N/A';
        document.getElementById('detailDate').textContent = formatDate(appointment.appointment_date);
        document.getElementById('detailTime').textContent = appointment.appointment_time || 'TBD';
        document.getElementById('detailType').textContent = appointment.type || 'Consultation';
        document.getElementById('detailDuration').textContent = (appointment.duration || 60) + ' minutes';
        document.getElementById('detailStatus').textContent = appointment.status || 'Scheduled';
        document.getElementById('detailStatus').className = 'status-badge ' + (appointment.status || 'scheduled').toLowerCase();
        document.getElementById('detailNotes').textContent = appointment.notes || 'No notes';
        document.getElementById('detailLocation').textContent = appointment.location || 'Office';
        
        // Load clinical notes if they exist
        const clinicalNotesTextarea = document.getElementById('detailClinicalNotes');
        clinicalNotesTextarea.value = appointment.clinical_notes || '';
        
        // Check if notes are signed and lock if they are
        if (appointment.clinical_signature && appointment.clinical_signature_timestamp) {
            clinicalNotesTextarea.disabled = true;
            const signButton = document.querySelector('.btn-sign-note');
            if (signButton) {
                signButton.textContent = ' Signed & Locked';
                signButton.disabled = true;
                signButton.style.opacity = '0.6';
            }
        } else {
            clinicalNotesTextarea.disabled = false;
            const signButton = document.querySelector('.btn-sign-note');
            if (signButton) {
                signButton.textContent = ' Sign & Lock Note';
                signButton.disabled = false;
                signButton.style.opacity = '1';
            }
        }
        
        // Set appointment ID for edit/delete
        document.getElementById('appointmentDetailPanel').setAttribute('data-appointment-id', appointmentId);
        
        // Show the panel with animation
        panel.classList.add('active');
        
        // Log the view
        logAudit('appointment_viewed', {
            appointment_id: appointmentId,
            client_name: appointment.client_name
        });
    }
}

function closeAppointmentDetail() {
    const panel = document.getElementById('appointmentDetailPanel');
    if (panel) {
        panel.classList.remove('active');
    }
}

function formatDate(dateString) {
    const date = new Date(dateString);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

function editAppointmentFromDetail() {
    const appointmentId = document.getElementById('appointmentDetailPanel').getAttribute('data-appointment-id');
    console.log('Edit from detail - Appointment ID:', appointmentId);
    
    if (appointmentId) {
        closeAppointmentDetail();
        // Small delay to ensure panel closes before modal opens
        setTimeout(() => {
            editAppointment(appointmentId);
        }, 100);
    } else {
        showNotification('Unable to find appointment ID', 'error');
    }
}

function deleteAppointmentFromDetail() {
    const appointmentId = document.getElementById('appointmentDetailPanel').getAttribute('data-appointment-id');
    if (appointmentId) {
        if (confirm('Are you sure you want to delete this appointment?')) {
            deleteAppointment(appointmentId);
            closeAppointmentDetail();
        }
    }
}

function generateAINote() {
    const appointmentId = document.getElementById('appointmentDetailPanel').getAttribute('data-appointment-id');
    const appointment = appointments.find(apt => apt.id == appointmentId);
    
    if (!appointment) {
        showNotification('Appointment not found', 'error');
        return;
    }
    
    // Show loading state
    const textarea = document.getElementById('detailClinicalNotes');
    const originalValue = textarea.value;
    textarea.value = 'Generating AI note...';
    textarea.disabled = true;
    
    // Simulate AI note generation (in production, this would call an AI API)
    setTimeout(() => {
        const aiNote = `CLINICAL NOTES - ${appointment.type || 'Session'}
Date: ${formatDate(appointment.appointment_date)}
Duration: ${appointment.duration || 60} minutes

CLIENT PRESENTATION:
- Client arrived on time
- Appeared ${['calm', 'anxious', 'engaged', 'withdrawn'][Math.floor(Math.random() * 4)]}
- ${appointment.notes || 'No specific concerns noted at start of session'}

INTERVENTIONS USED:
- Active listening and reflection
- Cognitive behavioral techniques
- Psychoeducation on ${['anxiety management', 'emotional regulation', 'communication skills', 'stress management'][Math.floor(Math.random() * 4)]}

CLIENT RESPONSE:
- Client engaged in discussion
- Demonstrated understanding of concepts
- Expressed willingness to practice techniques

PROGRESS NOTES:
- Client is making progress toward treatment goals
- Continue with current treatment plan

PLAN:
- Continue weekly sessions
- Assign homework: practice techniques discussed
- Review progress in next session

CLINICIAN: ${currentUser.name || 'Clinician'}
DATE: ${new Date().toLocaleDateString()}`;
        
        textarea.value = aiNote;
        textarea.disabled = false;
        
        logAudit('ai_note_generated', {
            appointment_id: appointmentId,
            client_name: appointment.client_name
        });
        
        showNotification('AI note generated successfully!', 'success');
    }, 1500);
}

function saveClinicalNote() {
    const appointmentId = document.getElementById('appointmentDetailPanel').getAttribute('data-appointment-id');
    const clinicalNotes = document.getElementById('detailClinicalNotes').value;
    
    if (!appointmentId) {
        showNotification('No appointment selected', 'error');
        return;
    }
    
    if (!clinicalNotes.trim()) {
        showNotification('Please enter clinical notes before saving', 'error');
        return;
    }
    
    // Find and update the appointment
    const appointment = appointments.find(apt => apt.id == appointmentId);
    if (appointment) {
        appointment.clinical_notes = clinicalNotes;
        appointment.clinical_notes_updated = new Date().toISOString();
        
        // Save to localStorage
        saveToStorage('appointments', appointments);
        
        // Log the update
        logAudit('clinical_notes_saved', {
            appointment_id: appointmentId,
            client_name: appointment.client_name
        });
        
        showNotification('Clinical notes saved successfully!', 'success');
    } else {
        showNotification('Appointment not found', 'error');
    }
}

function signClinicalNote() {
    const appointmentId = document.getElementById('appointmentDetailPanel').getAttribute('data-appointment-id');
    const clinicalNotes = document.getElementById('detailClinicalNotes').value;
    
    if (!appointmentId) {
        showNotification('No appointment selected', 'error');
        return;
    }
    
    if (!clinicalNotes.trim()) {
        showNotification('Please enter clinical notes before signing', 'error');
        return;
    }
    
    // Find the appointment
    const appointment = appointments.find(apt => apt.id == appointmentId);
    if (!appointment) {
        showNotification('Appointment not found', 'error');
        return;
    }
    
    // Check if already signed
    if (appointment.clinical_signature && appointment.clinical_signature_timestamp) {
        const signedDate = new Date(appointment.clinical_signature_timestamp).toLocaleString();
        if (!confirm(`This note was already signed by ${appointment.clinical_signature} on ${signedDate}. Sign again?`)) {
            return;
        }
    }
    
    // Get clinician name
    const clinicianName = currentUser.name || 'Clinician';
    
    // Sign the note
    appointment.clinical_notes = clinicalNotes;
    appointment.clinical_signature = clinicianName;
    appointment.clinical_signature_timestamp = new Date().toISOString();
    appointment.clinical_notes_updated = new Date().toISOString();
    
    // Save to localStorage
    saveToStorage('appointments', appointments);
    
    // Log the signature
    logAudit('clinical_notes_signed', {
        appointment_id: appointmentId,
        client_name: appointment.client_name,
        clinician_name: clinicianName,
        timestamp: appointment.clinical_signature_timestamp
    });
    
    // Disable editing
    document.getElementById('detailClinicalNotes').disabled = true;
    
    // Update button text
    const signButton = document.querySelector('.btn-sign-note');
    if (signButton) {
        signButton.textContent = ' Signed & Locked';
        signButton.disabled = true;
        signButton.style.opacity = '0.6';
    }
    
    showNotification('Clinical notes signed and locked successfully!', 'success');
}

function openNewAppointment() {
    const select = document.getElementById('appointmentClient');
    select.innerHTML = '<option value="">Select Client</option>' + 
        clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    // Set default date to today
    document.getElementById('appointmentDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('newAppointmentModal').style.display = 'block';
}

async function saveAppointment() {
    const clientId = document.getElementById('appointmentClient').value;
    const client = clients.find(c => c.id == clientId);
    const clientName = client ? client.name : 'Unknown Client';
    
    const appointment = {
        client_id: clientId,
        client_name: clientName,
        appointment_date: document.getElementById('appointmentDate').value,
        appointment_time: document.getElementById('appointmentTime').value,
        duration: document.getElementById('appointmentDuration').value,
        type: document.getElementById('appointmentType').value,
        notes: document.getElementById('appointmentNotes').value,
        cpt_code: document.getElementById('appointmentType').value,
        status: 'scheduled'
    };
    
    try {
        if (window.editingAppointmentId) {
            // Update existing appointment
            const index = appointments.findIndex(apt => apt.id === window.editingAppointmentId);
            if (index !== -1) {
                appointment.id = window.editingAppointmentId;
                appointment.created_at = appointments[index].created_at;
                appointments[index] = appointment;
                await logAudit('update_appointment', { id: appointment.id });
            }
            delete window.editingAppointmentId;
            // Reset modal title
            document.querySelector('#newAppointmentModal h2').textContent = 'New Appointment';
        } else {
            // Create new appointment
            appointment.id = Date.now();
            appointment.created_at = new Date().toISOString();
            appointments.push(appointment);
            await logAudit('create_appointment', { id: appointment.id, client_id: appointment.client_id });
        }
        
        saveToStorage('appointments', appointments);
        closeModal('newAppointmentModal');
        renderCalendar();
        renderAppointmentsList();
        alert(' Appointment saved!');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Invoices Management
async function loadInvoices() {
    try {
        // Invoices already loaded from localStorage
        renderInvoices();
    } catch (error) {
        console.error('Invoices error:', error);
    }
}

function renderInvoices() {
    const container = document.getElementById('invoicesList');
    
    // Load invoices from localStorage if not already loaded
    if (invoices.length === 0) {
        invoices = loadFromStorage('invoices') || [];
    }
    
    if (invoices.length === 0) {
        container.innerHTML = '<p>No invoices found.</p>';
        return;
    }
    
    container.innerHTML = invoices.map(invoice => {
        const statusClass = invoice.status;
        const dueDate = new Date(invoice.due_date);
        const isOverdue = invoice.status === 'pending' && dueDate < new Date();
        const displayStatus = isOverdue ? 'overdue' : invoice.status;
        
        return `<div class="invoice-card">
                    <div class="invoice-header">
                        <span class="invoice-number">${invoice.invoice_number}</span>
                        <span class="invoice-status ${displayStatus}">${displayStatus.toUpperCase()}</span>
                    </div>
                    <h4>${invoice.client_name}</h4>
                    <div class="invoice-amount">$${parseFloat(invoice.total_amount).toFixed(2)}</div>
                    <div class="invoice-details">
                        <p>Due: ${new Date(invoice.due_date).toLocaleDateString()}</p>
                        <p>Created: ${new Date(invoice.created_at).toLocaleDateString()}</p>
                        ${invoice.payment_date ? `<p>Paid: ${new Date(invoice.payment_date).toLocaleDateString()}</p>` : ''}
                    </div>
                    <div class="invoice-actions">
                        <button onclick="viewInvoice(${invoice.id})" class="btn btn-small">View</button>
                        ${invoice.status === 'pending' ? 
                            `<button onclick="openPaymentModal(${invoice.id})" class="btn btn-primary btn-small"> Pay Now</button>
                             <button onclick="markPaid(${invoice.id})" class="btn btn-success btn-small">Mark Paid</button>` : 
                            ''
                        }
                    </div>
                </div>`;
    }).join('');
}

function viewInvoice(invoiceId) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    if (!invoice) {
        alert('Invoice not found');
        return;
    }
    
    const client = clients.find(c => c.id === invoice.client_id);
    const clientName = client ? client.name : invoice.client_name || 'Unknown Client';
    
    // Create modal with invoice details
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <h2>Invoice Details</h2>
            <div style="padding: 20px;">
                <p><strong>Invoice ID:</strong> ${invoice.invoice_id || invoice.id}</p>
                <p><strong>Client:</strong> ${clientName}</p>
                <p><strong>Date:</strong> ${new Date(invoice.date_issued).toLocaleDateString()}</p>
                <p><strong>Due Date:</strong> ${new Date(invoice.due_date).toLocaleDateString()}</p>
                <p><strong>Amount:</strong> $${parseFloat(invoice.total_amount).toFixed(2)}</p>
                <p><strong>Status:</strong> <span class="badge badge-${invoice.status}">${invoice.status}</span></p>
                ${invoice.notes ? `<p><strong>Notes:</strong> ${invoice.notes}</p>` : ''}
                ${invoice.payment_tracking ? `
                    <div style="margin-top: 20px;">
                        <h3>Payment Tracking</h3>
                        <p><strong>Amount Paid:</strong> $${(invoice.payment_tracking.amount_paid || 0).toFixed(2)}</p>
                        <p><strong>Balance:</strong> $${(parseFloat(invoice.total_amount) - (invoice.payment_tracking.amount_paid || 0)).toFixed(2)}</p>
                    </div>
                ` : ''}
            </div>
            <div style="text-align: right; padding: 20px;">
                ${invoice.status === 'pending' ? 
                    `<button onclick="markPaid(${invoice.id}); this.parentElement.parentElement.parentElement.remove();" class="btn btn-success">Mark Paid</button>` : 
                    ''
                }
                <button onclick="this.parentElement.parentElement.remove()" class="btn">Close</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function openNewInvoice() {
    const select = document.getElementById('invoiceClient');
    select.innerHTML = '<option value="">Select Client</option>' + 
        clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    // Set default due date to 30 days from now
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
    
    document.getElementById('newInvoiceModal').style.display = 'block';
}

function addService() {
    const servicesList = document.getElementById('servicesList');
    const serviceItem = document.createElement('div');
    serviceItem.className = 'service-item';
    serviceItem.style.display = 'flex';
    serviceItem.style.gap = '10px';
    serviceItem.style.marginBottom = '10px';
    serviceItem.innerHTML = `
        <input type="text" placeholder="Service Description" class="input service-desc" style="flex: 2;">
        <select class="input service-cpt" style="flex: 1;">
            <option value="">CPT Code</option>
            <option value="90791">90791 - Psychiatric Diagnostic Evaluation</option>
            <option value="90834">90834 - Psychotherapy 45 min</option>
            <option value="90837">90837 - Psychotherapy 60 min</option>
            <option value="90847">90847 - Family Psychotherapy</option>
            <option value="90853">90853 - Group Psychotherapy</option>
        </select>
        <input type="number" placeholder="Amount" class="input service-amount" step="0.01" style="flex: 1;" onchange="updateInvoiceTotal()">
        <button onclick="removeService(this)" class="btn btn-danger btn-small">Remove</button>
    `;
    servicesList.appendChild(serviceItem);
    updateInvoiceTotal();
}

function removeService(button) {
    button.parentElement.remove();
    updateInvoiceTotal();
}

function updateInvoiceTotal() {
    const amounts = Array.from(document.querySelectorAll('.service-amount')).map(input => 
        parseFloat(input.value) || 0
    );
    const total = amounts.reduce((sum, amount) => sum + amount, 0);
    document.getElementById('invoiceTotal').textContent = total.toFixed(2);
}

async function saveInvoice() {
    const services = Array.from(document.querySelectorAll('.service-item')).map(item => {
        const desc = item.querySelector('.service-desc').value;
        const cpt = item.querySelector('.service-cpt').value;
        const amount = parseFloat(item.querySelector('.service-amount').value) || 0;
        return { description: desc, cpt_code: cpt, amount: amount };
    }).filter(service => service.description && service.amount > 0);
    
    if (services.length === 0) return alert('Please add at least one service');
    
    const totalAmount = services.reduce((sum, service) => sum + service.amount, 0);
    
    const invoice = {
        client_id: document.getElementById('invoiceClient').value,
        client_name: clients.find(c => c.id == document.getElementById('invoiceClient').value)?.name,
        services: services,
        total_amount: totalAmount,
        due_date: document.getElementById('invoiceDueDate').value,
        notes: document.getElementById('invoiceNotes').value,
        invoice_number: generateInvoiceNumber(),
        payment_tracking: {
            status: 'pending',
            payment_history: [],
            reminders_sent: 0
        },
        insurance_info: {
            claim_id: '',
            insurance_provider: '',
            coverage_percentage: 0
        }
    };
    
    try {
        // Add ID and timestamp
        invoice.id = Date.now();
        invoice.created_at = new Date().toISOString();
        invoice.status = 'pending';
        
        // Save to localStorage
        invoices.push(invoice);
        saveToStorage('invoices', invoices);
        
        await logAudit('create_invoice', { id: invoice.id, client_id: invoice.client_id, amount: totalAmount });
        closeModal('newInvoiceModal');
        renderInvoices();
        alert(' Invoice created!');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Stripe Payment Processing Functions
async function processPayment(invoiceId) {
    const invoice = invoices.find(inv => inv.id == invoiceId);
    if (!invoice) {
        showNotification('Invoice not found', 'error');
        return;
    }
    
    try {
        // Create payment intent on backend (you'll need to create this API endpoint)
        const response = await fetch('/api/create-payment-intent', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                amount: Math.round(invoice.total_amount * 100), // Convert to cents
                currency: 'usd',
                invoice_id: invoice.id,
                client_name: invoice.client_name
            })
        });
        
        const { clientSecret } = await response.json();
        
        // Confirm payment with Stripe
        const result = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: cardElement,
                billing_details: {
                    name: invoice.client_name
                }
            }
        });
        
        if (result.error) {
            showNotification('Payment failed: ' + result.error.message, 'error');
        } else {
            // Payment succeeded
            invoice.payment_tracking.status = 'paid';
            invoice.payment_tracking.payment_history.push({
                amount: invoice.total_amount,
                date: new Date().toISOString(),
                method: 'card',
                transaction_id: result.paymentIntent.id
            });
            
            saveToStorage('invoices', invoices);
            
            logAudit('payment_processed', {
                invoice_id: invoice.id,
                amount: invoice.total_amount,
                transaction_id: result.paymentIntent.id
            });
            
            showNotification('Payment successful!', 'success');
            renderInvoices();
        }
    } catch (error) {
        console.error('Payment error:', error);
        showNotification('Payment processing error', 'error');
    }
}

async function openPaymentModal(invoiceId) {
    const invoice = invoices.find(inv => inv.id == invoiceId);
    if (!invoice) {
        showNotification('Invoice not found', 'error');
        return;
    }
    
    // Create payment modal
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'paymentModal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('paymentModal')">&times;</span>
            <h2> Process Payment</h2>
            <div class="payment-details">
                <h3>Invoice #${invoice.invoice_number}</h3>
                <p><strong>Client:</strong> ${invoice.client_name}</p>
                <p><strong>Amount:</strong> $${invoice.total_amount.toFixed(2)}</p>
            </div>
            <div id="card-element" style="margin: 20px 0;">
                <!-- Stripe Elements will create form elements here -->
            </div>
            <div id="card-errors" role="alert"></div>
            <button onclick="processPayment(${invoiceId})" class="btn btn-primary" style="width: 100%;">
                Pay $${invoice.total_amount.toFixed(2)}
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
    modal.style.display = 'block';
    
    // Initialize Stripe Elements
    const elements = stripe.elements();
    const cardElement = elements.create('card');
    cardElement.mount('#card-element');
    
    // Store card element globally
    window.cardElement = cardElement;
    
    // Handle real-time validation errors
    cardElement.on('change', ({error}) => {
        const displayError = document.getElementById('card-errors');
        if (error) {
            displayError.textContent = error.message;
        } else {
            displayError.textContent = '';
        }
    });
}

// Enhanced Invoice Management Functions
function generateInvoiceNumber() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    
    // Find the highest invoice number for today
    const todayInvoices = invoices.filter(inv => inv.invoice_number?.startsWith(`INV-${year}${month}${day}`));
    const nextNumber = todayInvoices.length + 1;
    
    return `INV-${year}${month}${day}-${String(nextNumber).padStart(3, '0')}`;
}

function generateInvoicesFromAppointments(appointmentIds, invoiceTemplate = null) {
    const selectedAppointments = appointments.filter(apt => appointmentIds.includes(apt.id));
    const generatedInvoices = [];
    
    selectedAppointments.forEach(appointment => {
        const client = clients.find(c => c.id === appointment.client_id);
        if (!client) return;
        
        // Generate invoice from appointment
        const invoice = {
            id: Date.now() + Math.random(),
            client_id: appointment.client_id,
            client_name: appointment.client_name || client.name,
            invoice_number: generateInvoiceNumber(),
            services: [{
                description: `Appointment - ${appointment.notes || 'Medical Consultation'}`,
                cpt_code: appointment.cpt_code || '99213', // Default CPT code
                amount: parseFloat(appointment.service_fee) || 150.00
            }],
            total_amount: parseFloat(appointment.service_fee) || 150.00,
            due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 days from now
            appointment_id: appointment.id,
            created_at: new Date().toISOString(),
            status: 'pending',
            payment_tracking: {
                status: 'pending',
                payment_history: [],
                reminders_sent: 0
            },
            insurance_info: {
                claim_id: '',
                insurance_provider: '',
                coverage_percentage: 0
            }
        };
        
        generatedInvoices.push(invoice);
    });
    
    // Add to invoices array and save
    invoices.push(...generatedInvoices);
    saveToStorage('invoices', invoices);
    
    logLocalAudit('bulk_invoice_generation', { 
        appointmentCount: selectedAppointments.length, 
        invoiceCount: generatedInvoices.length,
        totalAmount: generatedInvoices.reduce((sum, inv) => sum + inv.total_amount, 0)
    });
    
    return generatedInvoices;
}

function trackPayment(invoiceId, paymentData) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    if (!invoice) return;
    
    const payment = {
        id: Date.now(),
        amount: parseFloat(paymentData.amount),
        payment_method: paymentData.method || 'cash',
        payment_date: new Date().toISOString(),
        reference_number: paymentData.reference || '',
        notes: paymentData.notes || ''
    };
    
    // Add to payment history
    if (!invoice.payment_tracking) {
        invoice.payment_tracking = { status: 'pending', payment_history: [], reminders_sent: 0 };
    }
    
    invoice.payment_tracking.payment_history.push(payment);
    
    // Calculate total paid
    const totalPaid = invoice.payment_tracking.payment_history.reduce((sum, p) => sum + p.amount, 0);
    
    // Update status
    if (totalPaid >= invoice.total_amount) {
        invoice.status = 'paid';
        invoice.payment_tracking.status = 'completed';
        invoice.payment_date = payment.payment_date;
    } else {
        invoice.status = 'partial';
        invoice.payment_tracking.status = 'partial';
    }
    
    saveToStorage('invoices', invoices);
    logLocalAudit('invoice_payment', { 
        invoiceId, 
        amount: payment.amount, 
        totalPaid, 
        status: invoice.status 
    });
    
    return invoice;
}

function checkOverdueInvoices() {
    const today = new Date();
    const overdueInvoices = invoices.filter(inv => {
        if (inv.status === 'paid') return false;
        const dueDate = new Date(inv.due_date);
        return dueDate < today;
    });
    
    if (overdueInvoices.length > 0) {
        showNotification(`${overdueInvoices.length} invoices are overdue`, 'warning');
        logLocalAudit('overdue_invoices_check', { overdueCount: overdueInvoices.length });
        
        // Send reminders for overdue invoices
        overdueInvoices.forEach(invoice => {
            if (!invoice.payment_tracking) {
                invoice.payment_tracking = { status: 'pending', payment_history: [], reminders_sent: 0 };
            }
            
            if (invoice.payment_tracking.reminders_sent < 3) { // Max 3 reminders
                sendInvoiceReminder(invoice);
                invoice.payment_tracking.reminders_sent++;
                saveToStorage('invoices', invoices);
            }
        });
    }
    
    return overdueInvoices;
}

function sendInvoiceReminder(invoice) {
    // Simulate sending reminder (in real app, this would send email/SMS)
    const reminder = {
        id: Date.now(),
        invoice_id: invoice.id,
        sent_date: new Date().toISOString(),
        type: 'overdue_reminder',
        recipient: invoice.client_name,
        message: `Reminder: Invoice ${invoice.invoice_number} for $${invoice.total_amount.toFixed(2)} is overdue.`
    };
    
    logLocalAudit('invoice_reminder_sent', { 
        invoiceId: invoice.id, 
        clientName: invoice.client_name, 
        reminderNumber: invoice.payment_tracking.reminders_sent + 1 
    });
    
    return reminder;
}

function addInsuranceClaim(invoiceId, claimData) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    if (!invoice) return;
    
    if (!invoice.insurance_info) {
        invoice.insurance_info = { claim_id: '', insurance_provider: '', coverage_percentage: 0 };
    }
    
    invoice.insurance_info = {
        claim_id: claimData.claim_id,
        insurance_provider: claimData.provider,
        coverage_percentage: parseFloat(claimData.coverage_percentage) || 0,
        claim_date: new Date().toISOString(),
        claim_status: 'submitted'
    };
    
    saveToStorage('invoices', invoices);
    logLocalAudit('insurance_claim_added', { 
        invoiceId, 
        claimId: claimData.claim_id, 
        provider: claimData.provider 
    });
    
    return invoice;
}

function bulkInvoiceActions(action, invoiceIds) {
    const selectedInvoices = invoices.filter(inv => invoiceIds.includes(inv.id));
    
    switch (action) {
        case 'mark_paid':
            selectedInvoices.forEach(invoice => {
                invoice.status = 'paid';
                invoice.payment_date = new Date().toISOString();
                if (!invoice.payment_tracking) {
                    invoice.payment_tracking = { status: 'completed', payment_history: [], reminders_sent: 0 };
                } else {
                    invoice.payment_tracking.status = 'completed';
                }
            });
            break;
            
        case 'send_reminders':
            selectedInvoices.forEach(invoice => {
                if (invoice.status === 'pending') {
                    sendInvoiceReminder(invoice);
                    if (!invoice.payment_tracking) {
                        invoice.payment_tracking = { status: 'pending', payment_history: [], reminders_sent: 0 };
                    }
                    invoice.payment_tracking.reminders_sent++;
                }
            });
            break;
            
        case 'delete':
            if (confirm(`Are you sure you want to delete ${selectedInvoices.length} invoice(s)?`)) {
                invoices = invoices.filter(inv => !invoiceIds.includes(inv.id));
            }
            break;
    }
    
    saveToStorage('invoices', invoices);
    logLocalAudit('bulk_invoice_action', { action, invoiceCount: selectedInvoices.length });
    
    renderInvoices();
    return selectedInvoices;
}

function getInvoiceAnalytics() {
    const totalInvoices = invoices.length;
    const paidInvoices = invoices.filter(inv => inv.status === 'paid').length;
    const pendingInvoices = invoices.filter(inv => inv.status === 'pending').length;
    const overdueInvoices = checkOverdueInvoices().length;
    
    const totalRevenue = invoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0);
    const paidRevenue = invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + parseFloat(inv.total_amount), 0);
    const outstandingRevenue = totalRevenue - paidRevenue;
    
    const avgPaymentTime = calculateAveragePaymentTime();
    
    return {
        totalInvoices,
        paidInvoices,
        pendingInvoices,
        overdueInvoices,
        totalRevenue,
        paidRevenue,
        outstandingRevenue,
        avgPaymentTime,
        paymentRate: totalInvoices > 0 ? (paidInvoices / totalInvoices * 100).toFixed(1) : 0
    };
}

function calculateAveragePaymentTime() {
    const paidInvoices = invoices.filter(inv => inv.status === 'paid' && inv.payment_date && inv.created_at);
    if (paidInvoices.length === 0) return 'N/A';
    
    const totalDays = paidInvoices.reduce((sum, inv) => {
        const created = new Date(inv.created_at);
        const paid = new Date(inv.payment_date);
        return sum + (paid - created) / (1000 * 60 * 60 * 24);
    }, 0);
    
    const avgDays = Math.round(totalDays / paidInvoices.length);
    return `${avgDays} days`;
}

// Enhanced showTab function
const originalShowTab = showTab;
showTab = function(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tab + 'Content').style.display = 'block';
    event.target.classList.add('active');
    
    if (tab === 'dashboard') {
        loadAnalytics();
    } else if (tab === 'clients') {
        renderClients();
    } else if (tab === 'appointments') {
        loadAppointments();
    } else if (tab === 'documents') {
        renderDocs();
    } else if (tab === 'invoices') {
        loadInvoices();
    } else if (tab === 'audit') {
        renderAudit();
    }
};

// Enhanced UI Functions
function showNotification(message, type = 'info', duration = 5000) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 18px;">
                ${type === 'success' ? '' : type === 'error' ? '' : type === 'warning' ? '' : ''}
            </span>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; margin-left: auto;"></button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
            setTimeout(() => notification.remove(), 300);
        }
    }, duration);
}

function setLoading(element, isLoading) {
    if (isLoading) {
        element.classList.add('loading');
        const spinner = element.querySelector('.loading-spinner');
        if (spinner) spinner.style.display = 'inline-block';
    } else {
        element.classList.remove('loading');
        const spinner = element.querySelector('.loading-spinner');
        if (spinner) spinner.style.display = 'none';
    }
}

function validateInput(input, validator) {
    const value = input.value.trim();
    const isValid = validator(value);
    
    if (isValid) {
        input.classList.remove('input-error');
        const errorMsg = input.parentElement.querySelector('.error-message');
        if (errorMsg) errorMsg.style.display = 'none';
    } else {
        input.classList.add('input-error');
        const errorMsg = input.parentElement.querySelector('.error-message');
        if (errorMsg) errorMsg.style.display = 'block';
    }
    
    return isValid;
}

// Enhanced form validation
const validators = {
    username: (value) => value.length >= 3,
    password: (value) => value.length >= 6,
    email: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),
    phone: (value) => /^[\+]?[1-9][\d]{0,15}$/.test(value.replace(/[\s\-\(\)]/g, '')),
    required: (value) => value.length > 0
};

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    // Tab navigation enhancement
    if (e.key === 'Tab') {
        document.body.classList.add('keyboard-navigation');
    }
});

document.addEventListener('mousedown', function() {
    document.body.classList.remove('keyboard-navigation');
});

// PWA Installation
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Show install button
    const installBtn = document.createElement('button');
    installBtn.className = 'btn btn-secondary';
    installBtn.innerHTML = ' Install App';
    installBtn.style.position = 'fixed';
    installBtn.style.bottom = '20px';
    installBtn.style.right = '20px';
    installBtn.style.zIndex = '1000';
    installBtn.onclick = async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
            installBtn.remove();
        }
    };
    document.body.appendChild(installBtn);
});

// Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
                console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}

// Enhanced modal functions
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Focus management
        const firstInput = modal.querySelector('input, button, select, textarea');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const openModal = document.querySelector('.modal.active');
        if (openModal) {
            closeModal(openModal.id);
        }
    }
});

// Enhanced user menu
function toggleUserMenu() {
    // Implementation for user menu dropdown
    showNotification('User menu functionality coming soon!', 'info');
}

// Auto-save functionality
let autoSaveTimeout;
function enableAutoSave(formId, saveFunction) {
    const form = document.getElementById(formId);
    if (form) {
        form.addEventListener('input', () => {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveFunction();
                showNotification('Changes saved automatically', 'success', 2000);
            }, 2000);
        });
    }
}

// Enhanced error handling
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    showNotification('An unexpected error occurred. Please refresh the page.', 'error');
});

// Performance monitoring
const perfObserver = new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
        if (entry.entryType === 'navigation') {
            console.log('Page load time:', entry.loadEventEnd - entry.loadEventStart, 'ms');
        }
    }
});

if (typeof PerformanceObserver !== 'undefined') {
    perfObserver.observe({ entryTypes: ['navigation'] });
}

// Reports & Analytics Functions
async function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const reportContent = document.getElementById('reportContent');
    const reportPreview = document.querySelector('.report-preview');
    const reportTitle = document.getElementById('reportTitle');
    const reportDate = document.getElementById('reportDate');
    const reportData = document.getElementById('reportData');
    
    try {
        reportContent.innerHTML = '<div class="loading">Generating report...</div>';
        
        // Generate report based on type
        let report = {};
        switch(reportType) {
            case 'client-summary':
                report = await generateClientSummaryReport();
                break;
            case 'appointment-trends':
                report = await generateAppointmentTrendsReport();
                break;
            case 'revenue-report':
                report = await generateRevenueReport();
                break;
            case 'document-completion':
                report = await generateDocumentCompletionReport();
                break;
        }
        
        // Display report
        reportTitle.textContent = report.title;
        reportDate.textContent = `Generated on ${new Date().toLocaleDateString()}`;
        reportData.innerHTML = report.content;
        reportPreview.style.display = 'block';
        
        reportContent.innerHTML = `
            <div class="card">
                <h3> Report Generated Successfully</h3>
                <p>Your ${report.title} has been generated. Use the export button to download as PDF.</p>
                <div class="report-preview">
                    <div class="report-header">
                        <h4 id="reportTitle">${report.title}</h4>
                        <p id="reportDate">Generated on ${new Date().toLocaleDateString()}</p>
                    </div>
                    <div id="reportData">${report.content}</div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Report generation error:', error);
        reportContent.innerHTML = '<div class="error">Failed to generate report. Please try again.</div>';
    }
}

async function generateClientSummaryReport() {
    const clientData = clients; // Use localStorage data
    const totalClients = clientData.length;
    const activeClients = clientData.filter(c => c.status === 'active').length;
    
    return {
        title: 'Client Summary Report',
        content: `
            <div class="report-section">
                <h4> Client Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h5>Total Clients</h5>
                        <span class="stat-number">${totalClients}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Active Clients</h5>
                        <span class="stat-number">${activeClients}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Inactive Clients</h5>
                        <span class="stat-number">${totalClients - activeClients}</span>
                    </div>
                </div>
            </div>
            <div class="report-section">
                <h4> Recent Clients</h4>
                <table class="report-table">
                    <thead>
                        <tr><th>Name</th><th>Email</th><th>Status</th><th>Created</th></tr>
                    </thead>
                    <tbody>
                        ${clientData.slice(0, 10).map(client => `
                            <tr>
                                <td>${client.name}</td>
                                <td>${client.email || 'N/A'}</td>
                                <td><span class="status-badge ${client.status}">${client.status}</span></td>
                                <td>${new Date(client.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `
    };
}

async function generateAppointmentTrendsReport() {
    const appointmentData = appointments; // Use localStorage data
    const last30Days = appointmentData.filter(apt => {
        const aptDate = new Date(apt.appointment_date);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        return aptDate >= thirtyDaysAgo;
    });
    
    const completed = last30Days.filter(apt => apt.status === 'completed').length;
    const cancelled = last30Days.filter(apt => apt.status === 'cancelled').length;
    const scheduled = last30Days.filter(apt => apt.status === 'scheduled').length;
    
    return {
        title: 'Appointment Trends Report',
        content: `
            <div class="report-section">
                <h4> Last 30 Days Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h5>Total Appointments</h5>
                        <span class="stat-number">${last30Days.length}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Completed</h5>
                        <span class="stat-number">${completed}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Cancelled</h5>
                        <span class="stat-number">${cancelled}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Scheduled</h5>
                        <span class="stat-number">${scheduled}</span>
                    </div>
                </div>
            </div>
            <div class="report-section">
                <h4> Completion Rate</h4>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${last30Days.length > 0 ? (completed / last30Days.length * 100) : 0}%"></div>
                </div>
                <p>${last30Days.length > 0 ? Math.round(completed / last30Days.length * 100) : 0}% completion rate</p>
            </div>
        `
    };
}

async function generateRevenueReport() {
    const invoiceData = invoices; // Use localStorage data
    const totalRevenue = invoiceData.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);
    const paidInvoices = invoiceData.filter(inv => inv.status === 'paid');
    const pendingInvoices = invoiceData.filter(inv => inv.status === 'pending');
    const paidRevenue = paidInvoices.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);
    
    return {
        title: 'Revenue Report',
        content: `
            <div class="report-section">
                <h4> Revenue Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h5>Total Revenue</h5>
                        <span class="stat-number">$${totalRevenue.toFixed(2)}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Paid Revenue</h5>
                        <span class="stat-number">$${paidRevenue.toFixed(2)}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Pending Revenue</h5>
                        <span class="stat-number">$${(totalRevenue - paidRevenue).toFixed(2)}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Total Invoices</h5>
                        <span class="stat-number">${invoiceData.length}</span>
                    </div>
                </div>
            </div>
            <div class="report-section">
                <h4> Invoice Status Breakdown</h4>
                <div class="status-breakdown">
                    <div class="status-item">
                        <span class="status-label">Paid:</span>
                        <span class="status-count">${paidInvoices.length}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Pending:</span>
                        <span class="status-count">${pendingInvoices.length}</span>
                    </div>
                </div>
            </div>
        `
    };
}

async function generateDocumentCompletionReport() {
    const docData = assignedDocs; // Use localStorage data
    const totalDocs = docData.length;
    const completedDocs = docData.filter(doc => doc.status === 'completed').length;
    const pendingDocs = docData.filter(doc => doc.status === 'pending').length;
    
    return {
        title: 'Document Completion Report',
        content: `
            <div class="report-section">
                <h4> Document Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h5>Total Documents</h5>
                        <span class="stat-number">${totalDocs}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Completed</h5>
                        <span class="stat-number">${completedDocs}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Pending</h5>
                        <span class="stat-number">${pendingDocs}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Completion Rate</h5>
                        <span class="stat-number">${totalDocs > 0 ? Math.round(completedDocs / totalDocs * 100) : 0}%</span>
                    </div>
                </div>
            </div>
            <div class="report-section">
                <h4> Recent Document Activity</h4>
                <table class="report-table">
                    <thead>
                        <tr><th>Document</th><th>Client</th><th>Status</th><th>Assigned</th></tr>
                    </thead>
                    <tbody>
                        ${docData.slice(0, 10).map(doc => `
                            <tr>
                                <td>${doc.template_name}</td>
                                <td>${doc.client_name}</td>
                                <td><span class="status-badge ${doc.status}">${doc.status}</span></td>
                                <td>${new Date(doc.assigned_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `
    };
}

function exportReport() {
    const reportContent = document.querySelector('.report-preview');
    if (!reportContent) {
        showNotification('Please generate a report first', 'warning');
        return;
    }
    
    // Simple PDF export using browser print functionality
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>ClinicalSpeak Report</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .report-header { text-align: center; margin-bottom: 30px; }
                    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
                    .stat-card { border: 1px solid #ddd; padding: 15px; text-align: center; border-radius: 8px; }
                    .stat-number { font-size: 24px; font-weight: bold; color: #FFE066; }
                    .report-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    .report-table th, .report-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    .report-table th { background-color: #f5f5f5; }
                    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
                    .status-badge.completed { background-color: #d4edda; color: #155724; }
                    .status-badge.pending { background-color: #fff3cd; color: #856404; }
                    .status-badge.active { background-color: #d1ecf1; color: #0c5460; }
                </style>
            </head>
            <body>
                ${reportContent.innerHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Notifications System
let notifications = [];
let notificationCount = 0;

// Initialize notifications
function initNotifications() {
    // Load saved notifications from localStorage
    const savedNotifications = localStorage.getItem('clinicalspeak_notifications');
    if (savedNotifications) {
        notifications = JSON.parse(savedNotifications);
        updateNotificationBadge();
    }
    
    // Add some demo notifications
    if (notifications.length === 0) {
        addDemoNotifications();
    }
    
    renderNotifications();
}

function addDemoNotifications() {
    const demoNotifications = [
        {
            id: Date.now() + 1,
            type: 'appointment',
            title: 'New Appointment Scheduled',
            message: 'John Doe has scheduled a 60-minute psychotherapy session for tomorrow at 2:00 PM.',
            timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
            read: false,
            priority: 'high'
        },
        {
            id: Date.now() + 2,
            type: 'document',
            title: 'Document Completed',
            message: 'Sarah Johnson has completed and signed the Informed Consent form.',
            timestamp: new Date(Date.now() - 4 * 60 * 60 * 1000), // 4 hours ago
            read: false,
            priority: 'medium'
        },
        {
            id: Date.now() + 3,
            type: 'payment',
            title: 'Payment Received',
            message: 'Payment of $150.00 received from Mike Wilson for invoice INV-1001.',
            timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000), // 6 hours ago
            read: true,
            priority: 'low'
        },
        {
            id: Date.now() + 4,
            type: 'system',
            title: 'System Update Available',
            message: 'A new version of ClinicalSpeak EHR is available with enhanced security features.',
            timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000), // 1 day ago
            read: true,
            priority: 'low'
        }
    ];
    
    notifications = demoNotifications;
    saveNotifications();
    updateNotificationBadge();
}

function addNotification(notification) {
    const newNotification = {
        id: Date.now(),
        timestamp: new Date(),
        read: false,
        ...notification
    };
    
    notifications.unshift(newNotification);
    saveNotifications();
    updateNotificationBadge();
    renderNotifications();
    
    // Show browser notification if permission granted
    if (Notification.permission === 'granted') {
        new Notification(notification.title, {
            body: notification.message,
            icon: '/icon.svg'
        });
    }
}

function renderNotifications() {
    const container = document.getElementById('notificationsContainer');
    if (!container) return;
    
    if (notifications.length === 0) {
        container.innerHTML = '<div class="card"><p>No notifications yet.</p></div>';
        return;
    }
    
    const html = notifications.map(notification => `
        <div class="notification-item ${notification.read ? '' : 'unread'}" data-id="${notification.id}">
            <div class="notification-header">
                <h4 class="notification-title">${getNotificationIcon(notification.type)} ${notification.title}</h4>
                <span class="notification-time">${formatTimeAgo(notification.timestamp)}</span>
            </div>
            <p class="notification-message">${notification.message}</p>
            <div class="notification-actions">
                ${!notification.read ? `<button class="mark-read" onclick="markAsRead(${notification.id})">Mark Read</button>` : ''}
                <button class="delete" onclick="deleteNotification(${notification.id})">Delete</button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function getNotificationIcon(type) {
    const icons = {
        'appointment': '',
        'document': '',
        'payment': '',
        'system': '',
        'client': '',
        'invoice': ''
    };
    return icons[type] || '';
}

function formatTimeAgo(timestamp) {
    const now = new Date();
    const diff = now - new Date(timestamp);
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    return `${days}d ago`;
}

function markAsRead(notificationId) {
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
        notification.read = true;
        saveNotifications();
        updateNotificationBadge();
        renderNotifications();
    }
}

function markAllAsRead() {
    notifications.forEach(notification => {
        notification.read = true;
    });
    saveNotifications();
    updateNotificationBadge();
    renderNotifications();
    showNotification('All notifications marked as read', 'success');
}

function deleteNotification(notificationId) {
    notifications = notifications.filter(n => n.id !== notificationId);
    saveNotifications();
    updateNotificationBadge();
    renderNotifications();
}

function clearAllNotifications() {
    if (confirm('Are you sure you want to clear all notifications?')) {
        notifications = [];
        saveNotifications();
        updateNotificationBadge();
        renderNotifications();
        showNotification('All notifications cleared', 'success');
    }
}

function updateNotificationBadge() {
    const unreadCount = notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notifBadge');
    if (badge) {
        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    }
    notificationCount = unreadCount;
}

function saveNotifications() {
    localStorage.setItem('clinicalspeak_notifications', JSON.stringify(notifications));
}

// Request notification permission
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                showNotification('Notifications enabled! You\'ll receive alerts for important events.', 'success');
            }
        });
    }
}

// Simulate real-time notifications
function simulateNotifications() {
    const notificationTypes = [
        {
            type: 'appointment',
            title: 'Appointment Reminder',
            message: 'You have an appointment with Jane Smith in 30 minutes.',
            priority: 'high'
        },
        {
            type: 'document',
            title: 'New Document Assignment',
            message: 'A new intake form has been assigned to a client.',
            priority: 'medium'
        },
        {
            type: 'payment',
            title: 'Payment Overdue',
            message: 'Invoice INV-1005 is 5 days overdue.',
            priority: 'high'
        }
    ];
    
    // Add a random notification every 30 seconds (for demo)
    setInterval(() => {
        if (Math.random() < 0.3) { // 30% chance
            const randomNotification = notificationTypes[Math.floor(Math.random() * notificationTypes.length)];
            addNotification(randomNotification);
        }
    }, 30000);
}

// Initialize notifications when the app loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize localStorage demo data
    initializeDemoData();
    
    // Load data from localStorage
    clients = loadFromStorage('clients', []);
    assignedDocs = loadFromStorage('assigned_docs', []);
    appointments = loadFromStorage('appointments', []);
    invoices = loadFromStorage('invoices', []);
    
    // Load templates
    loadTemplates();
    
    // Check for expired documents
    checkDocumentExpirations();
    
    // Initialize notifications
    initNotifications();
    requestNotificationPermission();
    
    // Start simulation after 10 seconds
    setTimeout(simulateNotifications, 10000);
    
    // Check for expired documents every hour
    setInterval(checkDocumentExpirations, 60 * 60 * 1000);
    
    // Check for overdue invoices every hour
    setInterval(checkOverdueInvoices, 60 * 60 * 1000);
    
    // Check if user is already logged in
    const existingToken = loadFromStorage('auth_token');
    const existingUser = loadFromStorage('current_user');
    
    if (existingToken && existingUser) {
        authToken = existingToken;
        currentUser = existingUser;
        showApp();
    } else {
        // Show login screen
        document.getElementById('authContainer').style.display = 'block';
        document.getElementById('appContainer').style.display = 'none';
    }
    
    console.log(' ClinicalSpeak EHR initialized with localStorage');
    
    // Initialize user menu
    updateUserMenu();
});

// User Management Functions
function updateUserMenu() {
    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const userName = document.getElementById('userName');
    const userAvatar = document.getElementById('userAvatar');
    const dropdownUserName = document.getElementById('dropdownUserName');
    const dropdownUserEmail = document.getElementById('dropdownUserEmail');
    
    if (userName) userName.textContent = user.name || 'Admin';
    if (userAvatar) userAvatar.textContent = (user.name || 'A').charAt(0).toUpperCase();
    if (dropdownUserName) dropdownUserName.textContent = user.name || 'Admin User';
    if (dropdownUserEmail) dropdownUserEmail.textContent = user.email || 'admin@clinicalspeak.com';
}

function toggleUserMenu() {
    const dropdown = document.getElementById('userMenuDropdown');
    if (dropdown) {
        dropdown.classList.toggle('active');
    }
}

// Close user menu when clicking outside
document.addEventListener('click', function(event) {
    const userMenu = document.querySelector('.user-menu');
    const dropdown = document.getElementById('userMenuDropdown');
    
    if (userMenu && dropdown && !userMenu.contains(event.target)) {
        dropdown.classList.remove('active');
    }
});

// Profile Modal
function openProfileModal() {
    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const modal = document.getElementById('profileModal');
    
    if (modal) {
        document.getElementById('profileName').value = user.name || '';
        document.getElementById('profileEmail').value = user.email || '';
        document.getElementById('profilePhone').value = user.phone || '';
        document.getElementById('profileTitle').value = user.title || 'Clinician';
        document.getElementById('profileLicense').value = user.license || '';
        document.getElementById('profileBio').value = user.bio || '';
        
        modal.style.display = 'block';
        document.getElementById('userMenuDropdown').classList.remove('active');
    }
}

function saveProfile() {
    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
    
    user.name = document.getElementById('profileName').value;
    user.email = document.getElementById('profileEmail').value;
    user.phone = document.getElementById('profilePhone').value;
    user.title = document.getElementById('profileTitle').value;
    user.license = document.getElementById('profileLicense').value;
    user.bio = document.getElementById('profileBio').value;
    
    localStorage.setItem('currentUser', JSON.stringify(user));
    currentUser = user;
    
    updateUserMenu();
    closeModal('profileModal');
    
    logAudit('profile_update', {
        user_id: user.id,
        changes: ['name', 'email', 'phone', 'title', 'license', 'bio']
    });
    
    showNotification('Profile updated successfully!', 'success');
}

// Settings Modal
function openSettingsModal() {
    const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
    const modal = document.getElementById('settingsModal');
    
    if (modal) {
        document.getElementById('emailNotifications').checked = settings.emailNotifications !== false;
        document.getElementById('appointmentReminders').checked = settings.appointmentReminders !== false;
        document.getElementById('documentAlerts').checked = settings.documentAlerts !== false;
        document.getElementById('invoiceAlerts').checked = settings.invoiceAlerts !== false;
        document.getElementById('themePreference').value = settings.theme || 'light';
        document.getElementById('languagePreference').value = settings.language || 'en';
        
        modal.style.display = 'block';
        document.getElementById('userMenuDropdown').classList.remove('active');
    }
}

function saveSettings() {
    const settings = {
        emailNotifications: document.getElementById('emailNotifications').checked,
        appointmentReminders: document.getElementById('appointmentReminders').checked,
        documentAlerts: document.getElementById('documentAlerts').checked,
        invoiceAlerts: document.getElementById('invoiceAlerts').checked,
        theme: document.getElementById('themePreference').value,
        language: document.getElementById('languagePreference').value
    };
    
    localStorage.setItem('userSettings', JSON.stringify(settings));
    closeModal('settingsModal');
    
    logAudit('settings_update', {
        user_id: currentUser.id,
        settings: settings
    });
    
    showNotification('Settings saved successfully!', 'success');
}

// Account Modal
function openAccountModal() {
    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
    const modal = document.getElementById('accountModal');
    
    if (modal) {
        document.getElementById('accountEmail').value = user.email || '';
        document.getElementById('accountUsername').value = user.username || 'admin';
        
        modal.style.display = 'block';
        document.getElementById('userMenuDropdown').classList.remove('active');
    }
}

function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        showNotification('Please fill in all password fields', 'error');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        showNotification('New passwords do not match', 'error');
        return;
    }
    
    if (newPassword.length < 8) {
        showNotification('Password must be at least 8 characters', 'error');
        return;
    }
    
    // In a real app, this would verify the current password with the backend
    // For demo purposes, we'll just update it
    const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
    user.password = newPassword; // In production, this should be hashed
    localStorage.setItem('currentUser', JSON.stringify(user));
    
    logAudit('password_change', {
        user_id: user.id,
        timestamp: new Date().toISOString()
    });
    
    // Clear password fields
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    
    showNotification('Password changed successfully!', 'success');
}

function deleteAccount() {
    if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
        return;
    }
    
    if (!confirm('This will permanently delete all your data. Type "DELETE" to confirm.')) {
        return;
    }
    
    // In a real app, this would make an API call to delete the account
    logAudit('account_deletion_request', {
        user_id: currentUser.id,
        timestamp: new Date().toISOString()
    });
    
    showNotification('Account deletion request submitted. Please contact support.', 'info');
    closeModal('accountModal');
}
</script>

<!-- User Management Modals -->
<!-- Profile Modal -->
<div id="profileModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('profileModal')">&times;</span>
        <h2>Edit Profile</h2>
        <form id="profileForm">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="profileName" class="input" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="profileEmail" class="input" required>
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="profilePhone" class="input">
            </div>
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="profileTitle" class="input" placeholder="e.g., Licensed Therapist">
            </div>
            <div class="form-group">
                <label>License Number</label>
                <input type="text" id="profileLicense" class="input">
            </div>
            <div class="form-group">
                <label>Bio</label>
                <textarea id="profileBio" class="input" rows="4" placeholder="Tell us about yourself..."></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" onclick="closeModal('profileModal')" class="btn btn-secondary">Cancel</button>
                <button type="button" onclick="saveProfile()" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('settingsModal')">&times;</span>
        <h2>Settings</h2>
        <form id="settingsForm">
            <div class="settings-section">
                <h3>Notifications</h3>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="emailNotifications">
                        <span>Email Notifications</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="appointmentReminders">
                        <span>Appointment Reminders</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="documentAlerts">
                        <span>Document Alerts</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="invoiceAlerts">
                        <span>Invoice Alerts</span>
                    </label>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Preferences</h3>
                <div class="form-group">
                    <label>Theme</label>
                    <select id="themePreference" class="input">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="auto">Auto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Language</label>
                    <select id="languagePreference" class="input">
                        <option value="en">English</option>
                        <option value="es">Espaol</option>
                        <option value="fr">Franais</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" onclick="closeModal('settingsModal')" class="btn btn-secondary">Cancel</button>
                <button type="button" onclick="saveSettings()" class="btn btn-primary">Save Settings</button>
            </div>
        </form>
    </div>
</div>

<!-- Account Modal -->
<div id="accountModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('accountModal')">&times;</span>
        <h2>Account Management</h2>
        
        <div class="account-section">
            <h3>Account Information</h3>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="accountEmail" class="input" readonly>
            </div>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="accountUsername" class="input" readonly>
            </div>
        </div>
        
        <div class="account-section">
            <h3>Change Password</h3>
            <div class="form-group">
                <label>Current Password</label>
                <input type="password" id="currentPassword" class="input">
            </div>
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="newPassword" class="input" placeholder="Minimum 8 characters">
            </div>
            <div class="form-group">
                <label>Confirm New Password</label>
                <input type="password" id="confirmPassword" class="input">
            </div>
            <button type="button" onclick="changePassword()" class="btn btn-primary">Change Password</button>
        </div>
        
        <div class="account-section danger-zone">
            <h3>Danger Zone</h3>
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Permanently delete your account and all associated data.</p>
            <button type="button" onclick="deleteAccount()" class="btn btn-danger">Delete Account</button>
        </div>
    </div>
</div>

<style>
.form-group {
    margin-bottom: 16px;
}

.form-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    color: var(--text-primary);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: auto;
    cursor: pointer;
}

.settings-section {
    margin-bottom: 24px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border-color);
}

.settings-section:last-child {
    border-bottom: none;
}

.settings-section h3 {
    margin-bottom: 16px;
    color: var(--primary-color);
    font-size: 16px;
}

.account-section {
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border-color);
}

.account-section:last-child {
    border-bottom: none;
}

.account-section h3 {
    margin-bottom: 16px;
    color: var(--primary-color);
    font-size: 16px;
}

.danger-zone {
    border: 2px solid #dc3545;
    padding: 16px;
    border-radius: 8px;
    background: #fff5f5;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.modal-actions {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 24px;
}
</style>
</body>
</html>
