<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClinicalSpeak EHR - Enhanced</title>
    <meta name="description" content="HIPAA-compliant clinical documentation platform with modern UI and advanced features">
    <meta name="theme-color" content="#FFE066">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary-color: #00a86b;
            --primary-hover: #008f5a;
            --secondary-color: #6c757d;
            --accent-color: #00a86b;
            --background-gradient: #f8f9fa;
            --surface-color: #ffffff;
            --surface-elevated: #ffffff;
            --text-primary: #333333;
            --text-secondary: #6c757d;
            --border-color: #e9ecef;
            --shadow-light: 0 2px 8px rgba(0, 168, 107, 0.1);
            --shadow-medium: 0 4px 15px rgba(0, 168, 107, 0.15);
            --shadow-heavy: 0 10px 40px rgba(0, 168, 107, 0.2);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }

        *:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background-gradient);
            min-height: 100vh;
            line-height: 1.6;
            color: var(--text-primary);
            scroll-behavior: smooth;
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        .auth-container {
            max-width: 450px; 
            margin: 100px auto; 
            background: var(--surface-color); 
            padding: 48px 40px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-heavy);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { 
                opacity: 0; 
                transform: translateY(30px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        .auth-container h2 { 
            margin-bottom: 16px; 
            color: var(--primary-color); 
            text-align: center; 
            font-size: 28px;
            font-weight: 600;
        }

        .auth-container .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 32px;
            font-size: 14px;
        }

        .auth-tabs { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 32px; 
            background: #f8f9fa;
            padding: 4px;
            border-radius: 8px;
        }

        .auth-tab {
            flex: 1; 
            padding: 12px 16px; 
            border: none; 
            border-radius: 6px;
            background: transparent; 
            cursor: pointer; 
            text-align: center; 
            transition: var(--transition);
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .auth-tab.active { 
            background: var(--surface-color); 
            color: var(--primary-color); 
            box-shadow: var(--shadow-light);
        }

        .auth-tab:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .app-container { display: none; min-height: 100vh; }
        .client-portal { display: none; min-height: 100vh; background: var(--surface-color); }
        
        .header {
            background: var(--surface-color); 
            padding: 24px 40px; 
            box-shadow: var(--shadow-light);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 { 
            color: var(--primary-color); 
            font-size: 28px; 
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header .logo {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-menu:hover {
            background: #f8f9fa;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .tabs { 
            background: var(--surface-color); 
            display: flex; 
            padding: 0 40px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .tab-btn {
            padding: 16px 24px; 
            border: none; 
            background: none; 
            cursor: pointer;
            font-size: 14px; 
            font-weight: 500; 
            color: var(--text-secondary); 
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            white-space: nowrap;
            position: relative;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background: rgba(232, 93, 79, 0.05);
        }

        .tab-btn.active { 
            color: var(--primary-color); 
            border-bottom-color: var(--primary-color);
            background: rgba(232, 93, 79, 0.05);
        }

        .tab-btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: -2px;
        }
        .content { 
            padding: 40px; 
            max-width: 1400px; 
            margin: 0 auto; 
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content { 
            display: none; 
            animation: slideIn 0.4s ease-out; 
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateX(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }

        .content-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .content-header h2 { 
            color: white; 
            font-size: 32px; 
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn {
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer;
            font-size: 14px; 
            font-weight: 600; 
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .btn-primary { 
            background: var(--primary-color); 
            color: white; 
            box-shadow: var(--shadow-light);
        }

        .btn-primary:hover { 
            background: var(--primary-hover); 
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .btn-secondary:hover {
            background: var(--primary-color);
            color: white;
        }

        .btn-icon {
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
        }
        .input {
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid var(--border-color); 
            border-radius: 8px;
            font-size: 14px; 
            margin-bottom: 16px; 
            transition: var(--transition);
            background: var(--surface-color);
            color: var(--text-primary);
        }

        .input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(232, 93, 79, 0.1);
        }

        .input::placeholder {
            color: var(--text-secondary);
        }

        .input-group {
            position: relative;
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .input-error {
            border-color: #FF6B6B;
        }

        .error-message {
            color: #FF6B6B;
            font-size: 12px;
            margin-top: 4px;
        }

        .card { 
            background: var(--surface-color); 
            padding: 24px; 
            border-radius: var(--border-radius); 
            box-shadow: var(--shadow-light); 
            margin-bottom: 24px;
            border: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 24px; 
        }

        .client-card {
            background: var(--surface-color); 
            padding: 24px; 
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light); 
            cursor: pointer; 
            transition: var(--transition);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .client-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .client-card:hover { 
            transform: translateY(-4px); 
            box-shadow: var(--shadow-medium);
        }

        .client-card:hover::before {
            transform: scaleY(1);
        }

        .client-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .client-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .client-info {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.4;
        }
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.6); 
            z-index: 1000; 
            overflow-y: auto;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content { 
            background: var(--surface-color); 
            margin: 0; 
            padding: 32px; 
            border-radius: var(--border-radius); 
            max-width: 600px; 
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            border: 1px solid var(--border-color);
            animation: slideUp 0.3s ease-out;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close { 
            background: none;
            border: none;
            font-size: 24px; 
            cursor: pointer; 
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 50%;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close:hover { 
            color: var(--primary-color);
            background: rgba(232, 93, 79, 0.1);
        }

        .close:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .notification-badge { 
            background: #FF6B6B; 
            color: white; 
            border-radius: 50%; 
            padding: 4px 8px; 
            font-size: 12px; 
            font-weight: 600;
            margin-left: 8px; 
            min-width: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--surface-color);
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: var(--shadow-medium);
            border-left: 4px solid var(--primary-color);
            z-index: 1001;
            animation: slideInRight 0.3s ease-out;
            max-width: 400px;
        }

        .notification.success {
            border-left-color: #27ae60;
        }

        .notification.error {
            border-left-color: #e74c3c;
        }

        .notification.warning {
            border-left-color: #f39c12;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .header {
                padding: 16px 20px;
                flex-direction: column;
                gap: 16px;
            }

            .header h1 {
                font-size: 24px;
            }

            .tabs {
                padding: 0 20px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab-btn {
                padding: 12px 16px;
                font-size: 13px;
            }

            .content {
                padding: 20px;
            }

            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .content-header h2 {
                font-size: 24px;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .auth-container {
                margin: 20px;
                padding: 32px 24px;
                max-width: none;
            }

            .modal-content {
                margin: 20px;
                padding: 24px;
                max-height: calc(100vh - 40px);
            }

            .btn {
                padding: 14px 20px;
                font-size: 16px;
            }

            .client-card {
                padding: 20px;
            }

            .notification {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 12px 16px;
            }

            .content {
                padding: 16px;
            }

            .auth-container {
                margin: 16px;
                padding: 24px 20px;
            }

            .modal-content {
                margin: 16px;
                padding: 20px;
            }

            .grid {
                gap: 12px;
            }

            .client-card {
                padding: 16px;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --surface-color: #1a1a1a;
                --surface-elevated: #2d2d2d;
                --text-primary: #ffffff;
                --text-secondary: #b0b0b0;
                --border-color: #404040;
            }

            body {
                background: #1a1a1a;
            }
        }

        /* High contrast mode */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #000000;
                --text-secondary: #000000;
            }

            .btn {
                border: 2px solid var(--text-primary);
            }

            .card {
                border: 2px solid var(--border-color);
            }
        }

        /* Print styles */
        @media print {
            .header,
            .tabs,
            .btn,
            .modal {
                display: none !important;
            }

            .content {
                padding: 0;
            }

            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                break-inside: avoid;
            }
        }
        .client-portal-content { max-width: 800px; margin: 0 auto; padding: 40px 20px; }
        .document-header {
            background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
            padding: 30px; border-radius: 12px; margin-bottom: 30px; text-align: center; border: 1px solid #FFE066;
        }
        .document-header h1 { color: #FFE066; margin-bottom: 10px; }
        .form-section { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px rgba(232, 93, 79, 0.1); margin-bottom: 20px; }
        .form-field { margin-bottom: 20px; }
        .form-field label { display: block; font-weight: 500; margin-bottom: 8px; color: #FFE066; }
        .form-field input, .form-field textarea, .form-field select {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;
        }
        .form-field textarea { min-height: 100px; resize: vertical; }
        .signature-pad {
            border: 2px dashed #FFE066; border-radius: 8px; padding: 20px; text-align: center; margin: 20px 0; background: #FFF8E1;
        }
        .signature-input {
            width: 100%; padding: 15px; border: 2px solid #FFE066; border-radius: 6px;
            font-family: 'Brush Script MT', cursive; font-size: 24px; text-align: center;
        }
        .submit-section { background: #FFF8E1; padding: 30px; border-radius: 8px; text-align: center; margin-top: 30px; }
        .search-input {
            flex: 1; padding: 12px; border: 2px solid white; border-radius: 6px; font-size: 14px; background: white; margin-bottom: 20px;
        }
        .doc-nav { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding: 10px 0; }
        .doc-nav-item {
            padding: 10px 20px; background: white; border: 2px solid #FFE066; border-radius: 6px;
            cursor: pointer; white-space: nowrap; transition: all 0.3s;
        }
        .doc-nav-item.active { background: #FFE066; color: white; }
        .doc-nav-item.completed { background: #27ae60; border-color: #27ae60; color: white; }
        
        /* New Features Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(232, 93, 79, 0.1);
            text-align: center;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-card h3 {
            color: #FFE066;
            margin-bottom: 15px;
            font-size: 16px;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
        }
        .charts-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(232, 93, 79, 0.1);
        }
        .chart-card h3 {
            color: #FFE066;
            margin-bottom: 20px;
        }
        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .calendar-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(232, 93, 79, 0.1);
            margin-bottom: 20px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .calendar-day {
            background: white;
            padding: 15px 10px;
            min-height: 80px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .calendar-day:hover {
            background: #FFF8E1;
        }
        .calendar-day.other-month {
            color: #ccc;
        }
        .calendar-day.today {
            background: #FFF8E1;
            font-weight: bold;
        }
        .calendar-day.has-appointment {
            background: #E8F5E8;
            border-left: 4px solid #27ae60;
        }
        .appointment-dot {
            width: 8px;
            height: 8px;
            background: #FFE066;
            border-radius: 50%;
            margin: 2px auto;
        }
        .appointments-list {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(232, 93, 79, 0.1);
        }
        .appointment-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        .appointment-item:hover {
            background: #FFF8E1;
            transform: translateX(5px);
        }
        .appointment-info h4 {
            color: #FFE066;
            margin-bottom: 5px;
        }
        .appointment-info p {
            color: #666;
            font-size: 14px;
        }
        .appointment-actions {
            display: flex;
            gap: 10px;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        /* Client Chart Styles */
        .client-chart-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            overflow-x: auto;
        }
        .chart-tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .chart-tab-btn:hover {
            color: var(--primary-color);
        }
        .chart-tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .chart-tab-content {
            display: none;
        }
        .chart-tab-content.active {
            display: block;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        .btn-danger {
            background: #FF6B6B;
            color: white;
        }
        .invoices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        .invoice-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(232, 93, 79, 0.1);
            transition: transform 0.3s;
        }
        .invoice-card:hover {
            transform: translateY(-5px);
        }
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .invoice-number {
            font-weight: bold;
            color: #FFE066;
        }
        .invoice-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .invoice-status.pending {
            background: #FFF3CD;
            color: #856404;
        }
        .invoice-status.paid {
            background: #D4EDDA;
            color: #155724;
        }
        .invoice-status.overdue {
            background: #F8D7DA;
            color: #721C24;
        }
        .invoice-amount {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        .invoice-details {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .invoice-actions {
            display: flex;
            gap: 10px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Report Styles */
        .report-section {
            margin-bottom: 30px;
        }

        .report-section h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 18px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .stat-card h5 {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            display: block;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: var(--surface-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-light);
        }

        .report-table th,
        .report-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .report-table th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }

        .report-table tr:hover {
            background: rgba(255, 224, 102, 0.05);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.completed {
            background: #d4edda;
            color: #155724;
        }

        .status-badge.pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-badge.active {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-badge.cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .status-breakdown {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .status-count {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 18px;
        }

        /* Notification Styles */
        .notification-settings {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 224, 102, 0.05);
            border-radius: var(--border-radius);
        }

        .notification-settings h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .setting-item {
            margin-bottom: 12px;
        }

        .setting-item label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }

        .setting-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-color);
        }

        .notification-item {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            position: relative;
        }

        .notification-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .notification-item.unread {
            border-left: 4px solid var(--primary-color);
            background: rgba(255, 224, 102, 0.05);
        }

        .notification-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .notification-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .notification-message {
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.4;
        }

        .notification-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        .notification-actions button {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-actions .mark-read {
            background: var(--primary-color);
            color: white;
        }

        .notification-actions .delete {
            background: #FF6B6B;
            color: white;
        }

        .notification-actions button:hover {
            opacity: 0.8;
        }

        .notification-badge {
            background: #FF6B6B;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }
        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #E85D4F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .services-container {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            background: #f8f9fa;
        }
        .service-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .invoice-total {
            text-align: center;
            padding: 20px;
            background: #FFF8E1;
            border-radius: 8px;
            margin: 20px 0;
        }
        .invoice-total h3 {
            color: #FFE066;
            font-size: 28px;
        }
        .invoice-filters {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="auth-container" id="authContainer">
        <h2>üè• ClinicalSpeak EHR</h2>
        <p class="subtitle">HIPAA-compliant clinical documentation platform</p>
        
        <div class="auth-tabs">
            <div class="auth-tab active" onclick="switchAuthTab('clinician')" role="tab" aria-selected="true">üë®‚Äç‚öïÔ∏è Clinician</div>
            <div class="auth-tab" onclick="switchAuthTab('client')" role="tab" aria-selected="false">üìÑ Client</div>
        </div>

        <div id="clinicianAuth" class="auth-form active" role="tabpanel">
            <div class="input-group">
                <label for="username" class="input-label">Username</label>
                <input type="text" id="username" placeholder="Enter your username" class="input" aria-describedby="username-help">
                <div id="username-help" class="error-message" style="display: none;"></div>
            </div>
            
            <div class="input-group">
                <label for="password" class="input-label">Password</label>
                <input type="password" id="password" placeholder="Enter your password" class="input" aria-describedby="password-help">
                <div id="password-help" class="error-message" style="display: none;"></div>
            </div>
            
            <button onclick="clinicianLogin()" class="btn btn-primary" style="width: 100%;">
                <span>Sign In</span>
                <div class="loading-spinner" style="display: none;"></div>
            </button>
            
            <p style="margin-top: 20px; font-size: 12px; color: var(--text-secondary); text-align: center;">
                Demo: admin / admin123
            </p>
        </div>

        <div id="clientAuth" class="auth-form" role="tabpanel">
            <div class="input-group">
                <label for="authCode" class="input-label">Authentication Code</label>
                <input type="text" id="authCode" placeholder="Enter your access code" class="input" style="text-transform: uppercase;" aria-describedby="authcode-help">
                <div id="authcode-help" class="error-message" style="display: none;"></div>
            </div>
            
            <button onclick="accessDocument()" class="btn btn-primary" style="width: 100%;">
                <span>Access Document</span>
                <div class="loading-spinner" style="display: none;"></div>
            </button>
            
            <p style="margin-top: 20px; font-size: 12px; color: var(--text-secondary); text-align: center;">
                Enter the code provided by your clinician
            </p>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="header">
            <h1>
                <div class="logo">CS</div>
                ClinicalSpeak EHR
            </h1>
            <div class="header-actions">
                <div class="user-menu" onclick="toggleUserMenu()" tabindex="0" role="button" aria-label="User menu">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span id="userName">Admin</span>
                    <span style="font-size: 12px; color: var(--text-secondary);">‚ñº</span>
                </div>
                <button onclick="logout()" class="btn btn-secondary btn-icon" aria-label="Logout">
                    <span>üö™</span>
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab-btn" onclick="showTab('clients')">üë• Clients</button>
            <button class="tab-btn" onclick="showTab('appointments')">üìÖ Appointments</button>
            <button class="tab-btn" onclick="showTab('documents')">üìÑ Documents <span class="notification-badge" id="docBadge" style="display: none;">0</span></button>
            <button class="tab-btn" onclick="showTab('invoices')">üí∞ Invoices</button>
            <button class="tab-btn" onclick="showTab('audit')">üìã Audit Log</button>
            <button class="tab-btn" onclick="showTab('reports')">üìä Reports</button>
            <button class="tab-btn" onclick="showTab('notifications')">üîî Notifications <span class="notification-badge" id="notifBadge" style="display: none;">0</span></button>
        </div>

        <div class="content">
            <div id="dashboardContent" class="tab-content" style="display: block;">
                <div class="content-header">
                    <h2>üìä Analytics Dashboard</h2>
                    <div>
                        <select id="timeframeSelect" class="input" style="width: auto; margin-right: 10px;" onchange="loadAnalytics()">
                            <option value="7">Last 7 days</option>
                            <option value="30" selected>Last 30 days</option>
                            <option value="90">Last 90 days</option>
                            <option value="365">Last year</option>
                        </select>
                        <button onclick="loadAnalytics()" class="btn btn-primary">Refresh</button>
                    </div>
                </div>
                <div id="analyticsContent">
                    <div class="analytics-grid">
                        <div class="stat-card">
                            <h3>üìà Total Clients</h3>
                            <div class="stat-number" id="totalClients">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>üìÖ Upcoming Appointments</h3>
                            <div class="stat-number" id="upcomingAppointments">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>üìÑ Pending Documents</h3>
                            <div class="stat-number" id="pendingDocuments">-</div>
                        </div>
                        <div class="stat-card">
                            <h3>üí∞ Total Revenue</h3>
                            <div class="stat-number" id="totalRevenue">$-</div>
                        </div>
                    </div>
                    <div class="charts-container">
                        <div class="chart-card">
                            <h3>üìä Monthly Trends</h3>
                            <div id="monthlyChart"></div>
                        </div>
                        <div class="chart-card">
                            <h3>üèÜ Top Clients</h3>
                            <div id="topClientsList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="clientsContent" class="tab-content">
                <div class="content-header">
                    <h2>üë• Clients</h2>
                    <button onclick="openNewClient()" class="btn btn-primary">+ New Client</button>
                </div>
                <input type="text" id="clientSearchInput" class="search-input" placeholder="üîç Search clients..." oninput="filterClients()">
                <div id="clientsList" class="grid"></div>
            </div>

            <div id="appointmentsContent" class="tab-content">
                <div class="content-header">
                    <h2>üìÖ Appointments</h2>
                    <button onclick="openNewAppointment()" class="btn btn-primary">+ New Appointment</button>
                </div>
                <div class="calendar-controls">
                    <button onclick="previousMonth()" class="btn">‚Üê Previous</button>
                    <h3 id="currentMonth">Current Month</h3>
                    <button onclick="nextMonth()" class="btn">Next ‚Üí</button>
                </div>
                <div id="calendarView" class="calendar-container"></div>
                <div id="appointmentsList" class="appointments-list"></div>
            </div>

            <div id="documentsContent" class="tab-content">
                <div class="content-header">
                    <h2>üìÑ Documents</h2>
                    <button onclick="openAssignDoc()" class="btn btn-primary">+ Assign Document</button>
                </div>
                <div id="docsList"></div>
            </div>

            <div id="invoicesContent" class="tab-content">
                <div class="content-header">
                    <h2>üí∞ Invoices</h2>
                    <button onclick="openNewInvoice()" class="btn btn-primary">+ New Invoice</button>
                </div>
                <div class="invoice-filters">
                    <select id="invoiceStatusFilter" class="input" style="width: auto;" onchange="filterInvoices()">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
                <div id="invoicesList" class="invoices-grid"></div>
            </div>

            <div id="auditContent" class="tab-content">
                <div class="content-header">
                    <h2>üìã Audit Log</h2>
                </div>
                <div id="auditList"></div>
            </div>

            <div id="reportsContent" class="tab-content">
                <div class="content-header">
                    <h2>üìä Reports & Analytics</h2>
                    <div>
                        <select id="reportType" class="input" style="width: auto; margin-right: 10px;" onchange="generateReport()">
                            <option value="client-summary">Client Summary</option>
                            <option value="appointment-trends">Appointment Trends</option>
                            <option value="revenue-report">Revenue Report</option>
                            <option value="document-completion">Document Completion</option>
                        </select>
                        <button class="btn" onclick="exportReport()">üì• Export PDF</button>
                    </div>
                </div>
                <div id="reportContent">
                    <div class="card">
                        <h3>üìà Report Generator</h3>
                        <p>Select a report type above to generate detailed analytics and insights for your practice.</p>
                        <div class="report-preview" style="display: none;">
                            <div class="report-header">
                                <h4 id="reportTitle"></h4>
                                <p id="reportDate"></p>
                            </div>
                            <div id="reportData"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="notificationsContent" class="tab-content">
                <div class="content-header">
                    <h2>üîî Notifications Center</h2>
                    <div>
                        <button class="btn" onclick="markAllAsRead()">‚úÖ Mark All Read</button>
                        <button class="btn" onclick="clearAllNotifications()">üóëÔ∏è Clear All</button>
                    </div>
                </div>
                <div id="notificationsList">
                    <div class="card">
                        <h3>üì± Real-time Notifications</h3>
                        <p>Stay updated with important events in your practice.</p>
                        <div class="notification-settings">
                            <h4>üîß Notification Settings</h4>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="emailNotifications" checked>
                                    Email notifications for new appointments
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="docNotifications" checked>
                                    Notifications for completed documents
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="paymentNotifications" checked>
                                    Payment reminders and updates
                                </label>
                            </div>
                            <div class="setting-item">
                                <label>
                                    <input type="checkbox" id="systemNotifications" checked>
                                    System updates and maintenance alerts
                                </label>
                            </div>
                        </div>
                    </div>
                    <div id="notificationsContainer">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="client-portal" id="clientPortal">
        <div class="header">
            <h1>üè• ClinicalSpeak</h1>
            <button onclick="clientLogout()" class="btn">Exit</button>
        </div>
        <div class="client-portal-content" id="clientPortalContent"></div>
    </div>

    <!-- Modals -->
    <div id="newClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newClientModal')">&times;</span>
            <h2>New Client</h2>
            <input type="text" id="clientName" placeholder="Full Name" class="input">
            <input type="email" id="clientEmail" placeholder="Email" class="input">
            <input type="tel" id="clientPhone" placeholder="Phone" class="input">
            <input type="date" id="clientDOB" class="input">
            <textarea id="clientNotes" placeholder="Notes" class="input"></textarea>
            <button onclick="saveClient()" class="btn btn-primary">Save Client</button>
        </div>
    </div>

    <div id="editClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editClientModal')">&times;</span>
            <h2>Edit Client</h2>
            <input type="hidden" id="editClientId">
            <input type="text" id="editClientName" placeholder="Full Name" class="input">
            <input type="email" id="editClientEmail" placeholder="Email" class="input">
            <input type="tel" id="editClientPhone" placeholder="Phone" class="input">
            <input type="date" id="editClientDOB" class="input">
            <textarea id="editClientNotes" placeholder="Notes" class="input"></textarea>
            <button onclick="updateClient()" class="btn btn-primary">Update Client</button>
        </div>
    </div>

    <div id="assignDocModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('assignDocModal')">&times;</span>
            <h2>Assign Documents</h2>
            <select id="assignClient" class="input"><option value="">Select Client</option></select>
            <div style="margin: 20px 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <p style="font-weight: 500;">Select Documents (check multiple):</p>
                    <div>
                        <button onclick="selectAllDocs()" class="btn" style="font-size: 12px; padding: 5px 10px; margin-right: 5px;">Select All</button>
                        <button onclick="deselectAllDocs()" class="btn" style="font-size: 12px; padding: 5px 10px;">Clear All</button>
                    </div>
                </div>
                <div id="templateCheckboxContainer" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 6px; background: #f8f9fa;"></div>
                <p id="selectedCount" style="margin-top: 10px; font-size: 14px; color: #E85D4F; font-weight: 500;"></p>
            </div>
            <button onclick="saveAssignDoc()" class="btn btn-primary">Assign Documents</button>
        </div>
    </div>

    <div id="successModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('successModal')">&times;</span>
            <h2>‚úÖ Documents Assigned!</h2>
            <div style="background: #FFE5E0; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3 style="color: #E85D4F;">Authentication Code:</h3>
                <div id="generatedCode" style="font-family: monospace; font-size: 24px; font-weight: bold; text-align: center; padding: 15px; background: white; border-radius: 6px; margin: 10px 0;"></div>
                <p style="font-size: 14px; color: #666; margin-top: 15px;">Share this code with your client.</p>
                <div id="assignedDocsList" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #F4A261;"></div>
            </div>
            <button onclick="closeModal('successModal')" class="btn btn-primary">Done</button>
        </div>
    </div>

    <!-- New Appointment Modal -->
    <div id="newAppointmentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('newAppointmentModal')">&times;</span>
            <h2>üìÖ New Appointment</h2>
            <select id="appointmentClient" class="input">
                <option value="">Select Client</option>
            </select>
            <input type="date" id="appointmentDate" class="input">
            <input type="time" id="appointmentTime" class="input">
            <select id="appointmentType" class="input">
                <option value="">Select Type</option>
                <option value="90791">Psychiatric Diagnostic Evaluation (90791) - $200</option>
                <option value="90834">Psychotherapy 45 min (90834) - $150</option>
                <option value="90837">Psychotherapy 60 min (90837) - $180</option>
                <option value="90847">Family Psychotherapy (90847) - $200</option>
                <option value="90853">Group Psychotherapy (90853) - $75</option>
            </select>
            <input type="number" id="appointmentDuration" placeholder="Duration (minutes)" class="input" value="60">
            <textarea id="appointmentNotes" placeholder="Notes" class="input"></textarea>
            <button onclick="saveAppointment()" class="btn btn-primary">Save Appointment</button>
        </div>
    </div>

    <!-- New Invoice Modal -->
    <div id="newInvoiceModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="closeModal('newInvoiceModal')">&times;</span>
            <h2>üí∞ New Invoice</h2>
            <select id="invoiceClient" class="input">
                <option value="">Select Client</option>
            </select>
            <input type="date" id="invoiceDueDate" class="input">
            <textarea id="invoiceNotes" placeholder="Additional Notes" class="input"></textarea>
            
            <h3>Services</h3>
            <div id="servicesList" class="services-container">
                <div class="service-item">
                    <input type="text" placeholder="Service Description" class="input service-desc">
                    <select class="input service-cpt">
                        <option value="">CPT Code</option>
                        <option value="90791">90791 - Psychiatric Diagnostic Evaluation</option>
                        <option value="90834">90834 - Psychotherapy 45 min</option>
                        <option value="90837">90837 - Psychotherapy 60 min</option>
                        <option value="90847">90847 - Family Psychotherapy</option>
                        <option value="90853">90853 - Group Psychotherapy</option>
                    </select>
                    <input type="number" placeholder="Amount" class="input service-amount" step="0.01">
                    <button onclick="removeService(this)" class="btn btn-danger btn-small">Remove</button>
                </div>
            </div>
            <button onclick="addService()" class="btn">+ Add Service</button>
            
            <div class="invoice-total">
                <h3>Total: $<span id="invoiceTotal">0.00</span></h3>
            </div>
            
            <button onclick="saveInvoice()" class="btn btn-primary">Create Invoice</button>
        </div>
    </div>

    <!-- Client Chart Modal -->
    <div id="clientChartModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeModal('clientChartModal')">&times;</span>
            <div class="client-chart-header">
                <div>
                    <h2 id="chartClientName">Client Chart</h2>
                    <p id="chartClientInfo" style="color: #666; font-size: 14px;"></p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="scheduleFromChart()" class="btn btn-primary btn-small">üìÖ Schedule</button>
                    <button onclick="assignDocFromChart()" class="btn btn-primary btn-small">üìÑ Assign Doc</button>
                    <button onclick="createInvoiceFromChart()" class="btn btn-primary btn-small">üí∞ Invoice</button>
                    <button onclick="openEditClientFromChart()" class="btn btn-small">‚úèÔ∏è Edit</button>
                </div>
            </div>
            
            <div class="chart-tabs">
                <button class="chart-tab-btn active" onclick="showChartTab('overview')">üìä Overview</button>
                <button class="chart-tab-btn" onclick="showChartTab('appointments')">üìÖ Appointments</button>
                <button class="chart-tab-btn" onclick="showChartTab('documents')">üìÑ Documents</button>
                <button class="chart-tab-btn" onclick="showChartTab('invoices')">üí∞ Invoices</button>
                <button class="chart-tab-btn" onclick="showChartTab('notes')">üìù Notes</button>
            </div>
            
            <div id="chartOverviewTab" class="chart-tab-content active">
                <div class="analytics-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <h3>Total Appointments</h3>
                        <div class="stat-number" id="chartTotalAppts">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Completed Sessions</h3>
                        <div class="stat-number" id="chartCompletedAppts">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Pending Documents</h3>
                        <div class="stat-number" id="chartPendingDocs">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Billed</h3>
                        <div class="stat-number" id="chartTotalBilled">$0</div>
                    </div>
                </div>
                <div id="chartOverviewContent"></div>
            </div>
            
            <div id="chartAppointmentsTab" class="chart-tab-content">
                <div class="calendar-controls" style="margin-top: 20px;">
                    <button onclick="previousClientMonth()" class="btn">‚Üê Previous</button>
                    <h3 id="clientCalendarMonth">Current Month</h3>
                    <button onclick="nextClientMonth()" class="btn">Next ‚Üí</button>
                </div>
                <div id="clientCalendarView" class="calendar-container"></div>
                <div id="clientAppointmentsList" class="appointments-list"></div>
            </div>
            
            <div id="chartDocumentsTab" class="chart-tab-content">
                <div id="chartDocumentsContent" style="margin-top: 20px;"></div>
            </div>
            
            <div id="chartInvoicesTab" class="chart-tab-content">
                <div id="chartInvoicesContent" style="margin-top: 20px;"></div>
            </div>
            
            <div id="chartNotesTab" class="chart-tab-content">
                <div id="chartNotesContent" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

<script>
// Client-side localStorage implementation - no API calls needed
let authToken = null;
let currentUser = null;
let clients = [];
let assignedDocs = [];
let currentDocuments = [];
let currentDocIndex = 0;
let documentTemplates = {};
let templateNames = {};
let currentChartClient = null;
let clientCalendarDate = new Date();
let clientAppointments = [];
let clientInvoices = [];
let clientDocs = [];

// localStorage management functions
function getStorageKey(key) {
    return `clinicalspeak_${key}`;
}

function saveToStorage(key, data) {
    try {
        localStorage.setItem(getStorageKey(key), JSON.stringify(data));
        // Log audit event for HIPAA compliance
        logLocalAudit('data_save', { key, dataCount: Array.isArray(data) ? data.length : 1 });
    } catch (error) {
        console.error('Failed to save to localStorage:', error);
    }
}

function loadFromStorage(key, defaultValue = null) {
    try {
        const data = localStorage.getItem(getStorageKey(key));
        return data ? JSON.parse(data) : defaultValue;
    } catch (error) {
        console.error('Failed to load from localStorage:', error);
        return defaultValue;
    }
}

function logLocalAudit(action, details = {}) {
    const auditLogs = loadFromStorage('audit_logs', []);
    const logEntry = {
        id: Date.now() + Math.random(),
        timestamp: new Date().toISOString(),
        action,
        details,
        user_name: currentUser?.name || 'System'
    };
    auditLogs.unshift(logEntry);
    // Keep only last 1000 audit logs
    if (auditLogs.length > 1000) {
        auditLogs.splice(1000);
    }
    saveToStorage('audit_logs', auditLogs);
}

// Initialize demo data if localStorage is empty
function initializeDemoData() {
    const hasData = localStorage.getItem(getStorageKey('clients'));
    if (!hasData) {
        // Initialize with demo data
        const demoClients = [
            { id: 1, name: 'John Doe', email: 'john@example.com', phone: '555-0123', status: 'active', created_at: new Date().toISOString() },
            { id: 2, name: 'Jane Smith', email: 'jane@example.com', phone: '555-0124', status: 'active', created_at: new Date().toISOString() }
        ];
        const demoTemplates = {
            '1': { id: 1, name: 'Consent Form', content: 'Default consent form content...' },
            '2': { id: 2, name: 'Medical History', content: 'Default medical history form...' }
        };
        const demoAppointments = [
            { id: 1, client_id: 1, client_name: 'John Doe', appointment_date: new Date().toISOString().split('T')[0], time: '09:00', duration: 60, notes: 'Initial consultation' },
            { id: 2, client_id: 2, client_name: 'Jane Smith', appointment_date: new Date(Date.now() + 86400000).toISOString().split('T')[0], time: '14:00', duration: 45, notes: 'Follow-up appointment' }
        ];
        
        saveToStorage('clients', demoClients);
        saveToStorage('templates', demoTemplates);
        saveToStorage('appointments', demoAppointments);
        saveToStorage('assigned_docs', []);
        saveToStorage('invoices', []);
        
        logLocalAudit('system_init', { message: 'Demo data initialized' });
    }
}

async function loadTemplates() {
    try {
        const templates = loadFromStorage('templates', {});
        documentTemplates = templates;
        Object.keys(templates).forEach(id => {
            templateNames[id] = templates[id].name;
        });
        
        console.log('‚úÖ Loaded', Object.keys(documentTemplates).length, 'templates');
    } catch (error) {
        console.error('Error loading templates:', error);
        alert('Failed to load templates');
    }
}

// localStorage-based API replacement functions
async function apiCall(endpoint, options = {}) {
    // Simulate async behavior for consistency
    return new Promise((resolve, reject) => {
        setTimeout(() => {
            try {
                let result;
                
                if (endpoint.startsWith('/login')) {
                    // Simulate login
                    const { username, password } = JSON.parse(options.body);
                    if (username === 'admin' && password === 'password') {
                        authToken = 'demo-token';
                        currentUser = { name: 'Demo User', role: 'admin' };
                        saveToStorage('auth_token', authToken);
                        saveToStorage('current_user', currentUser);
                        result = { token: authToken, user: currentUser };
                        logLocalAudit('login', { username });
                    } else {
                        throw new Error('Invalid credentials');
                    }
                } else if (endpoint.startsWith('/clients')) {
                    if (options.method === 'GET') {
                        result = loadFromStorage('clients', []);
                    } else if (options.method === 'POST') {
                        const newClient = JSON.parse(options.body);
                        newClient.id = Date.now();
                        newClient.created_at = new Date().toISOString();
                        const clients = loadFromStorage('clients', []);
                        clients.push(newClient);
                        saveToStorage('clients', clients);
                        result = newClient;
                        logLocalAudit('client_create', { clientId: newClient.id, clientName: newClient.name });
                    } else if (options.method === 'PUT') {
                        const updatedClient = JSON.parse(options.body);
                        const clients = loadFromStorage('clients', []);
                        const index = clients.findIndex(c => c.id === updatedClient.id);
                        if (index !== -1) {
                            clients[index] = { ...clients[index], ...updatedClient };
                            saveToStorage('clients', clients);
                            result = updatedClient;
                            logLocalAudit('client_update', { clientId: updatedClient.id, clientName: updatedClient.name });
                        }
                    }
                } else if (endpoint.startsWith('/assigned-docs')) {
                    if (options.method === 'GET') {
                        const urlParams = new URLSearchParams(endpoint.split('?')[1] || '');
                        const authCode = urlParams.get('auth_code');
                        if (authCode) {
                            const docs = loadFromStorage('assigned_docs', []);
                            result = docs.filter(doc => doc.auth_code === authCode);
                        } else {
                            result = loadFromStorage('assigned_docs', []);
                        }
                    } else if (options.method === 'POST') {
                        const newDoc = JSON.parse(options.body);
                        newDoc.id = Date.now();
                        newDoc.status = 'pending';
                        newDoc.created_at = new Date().toISOString();
                        const docs = loadFromStorage('assigned_docs', []);
                        docs.push(newDoc);
                        saveToStorage('assigned_docs', docs);
                        result = newDoc;
                        logLocalAudit('document_assign', { docId: newDoc.id, clientId: newDoc.client_id });
                    } else if (options.method === 'PUT') {
                        const updatedDoc = JSON.parse(options.body);
                        const docs = loadFromStorage('assigned_docs', []);
                        const index = docs.findIndex(d => d.id === updatedDoc.id);
                        if (index !== -1) {
                            docs[index] = { ...docs[index], ...updatedDoc };
                            saveToStorage('assigned_docs', docs);
                            result = updatedDoc;
                            logLocalAudit('document_update', { docId: updatedDoc.id, status: updatedDoc.status });
                        }
                    }
                } else if (endpoint.startsWith('/appointments')) {
                    if (options.method === 'GET') {
                        const urlParams = new URLSearchParams(endpoint.split('?')[1] || '');
                        const month = urlParams.get('month');
                        const year = urlParams.get('year');
                        let appointments = loadFromStorage('appointments', []);
                        if (month && year) {
                            appointments = appointments.filter(apt => {
                                const aptDate = new Date(apt.appointment_date);
                                return aptDate.getMonth() + 1 == month && aptDate.getFullYear() == year;
                            });
                        }
                        result = appointments;
                    } else if (options.method === 'POST') {
                        const newAppointment = JSON.parse(options.body);
                        newAppointment.id = Date.now();
                        newAppointment.created_at = new Date().toISOString();
                        const appointments = loadFromStorage('appointments', []);
                        appointments.push(newAppointment);
                        saveToStorage('appointments', appointments);
                        result = newAppointment;
                        logLocalAudit('appointment_create', { appointmentId: newAppointment.id, clientId: newAppointment.client_id });
                    }
                } else if (endpoint.startsWith('/invoices')) {
                    if (options.method === 'GET') {
                        result = loadFromStorage('invoices', []);
                    } else if (options.method === 'POST') {
                        const newInvoice = JSON.parse(options.body);
                        newInvoice.id = Date.now();
                        newInvoice.created_at = new Date().toISOString();
                        const invoices = loadFromStorage('invoices', []);
                        invoices.push(newInvoice);
                        saveToStorage('invoices', invoices);
                        result = newInvoice;
                        logLocalAudit('invoice_create', { invoiceId: newInvoice.id, clientId: newInvoice.client_id });
                    }
                } else if (endpoint.startsWith('/audit')) {
                    if (options.method === 'GET') {
                        result = loadFromStorage('audit_logs', []);
                    } else if (options.method === 'POST') {
                        const auditData = JSON.parse(options.body);
                        logLocalAudit(auditData.action, auditData.details);
                        result = { success: true };
                    }
                } else if (endpoint.startsWith('/analytics')) {
                    const urlParams = new URLSearchParams(endpoint.split('?')[1] || '');
                    const timeframe = urlParams.get('timeframe') || '30days';
                    const clients = loadFromStorage('clients', []);
                    const appointments = loadFromStorage('appointments', []);
                    const invoices = loadFromStorage('invoices', []);
                    
                    result = {
                        totalClients: clients.length,
                        totalAppointments: appointments.length,
                        totalRevenue: invoices.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0),
                        paidInvoices: invoices.filter(inv => inv.status === 'paid').length,
                        timeframe
                    };
                } else if (endpoint.startsWith('/templates')) {
                    result = Object.values(loadFromStorage('templates', {}));
                } else {
                    result = { error: 'Endpoint not found' };
                }
                
                resolve(result);
            } catch (error) {
                reject(error);
            }
        }, 100); // Simulate network delay
    });
}

function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById(tab + 'Auth').classList.add('active');
}

async function clinicianLogin() {
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    
    try {
        const data = await apiCall('/login', {
            method: 'POST',
            body: JSON.stringify({ username, password }),
            skipAuth: true
        });
        
        authToken = data.token;
        currentUser = data.user;
        
        await logAudit('clinician_login', { username });
        showApp();
    } catch (error) {
        alert('Login failed: ' + error.message);
    }
}

async function accessDocument() {
    const code = document.getElementById('authCode').value.toUpperCase().trim();
    if (!code) return alert('Please enter code');
    
    try {
        if (Object.keys(documentTemplates).length === 0) await loadTemplates();
        
        const docs = await apiCall(`/assigned-docs?auth_code=${code}`, { skipAuth: true });
        const pendingDocs = docs.filter(d => d.status === 'pending');
        
        if (pendingDocs.length > 0) {
            currentDocuments = pendingDocs;
            currentDocIndex = 0;
            await logAudit('client_access', { code }, 'Client');
            showClientPortal();
        } else {
            alert('Invalid or expired code');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function logout() {
    authToken = null;
    currentUser = null;
    document.getElementById('authContainer').style.display = 'block';
    document.getElementById('appContainer').style.display = 'none';
}

function clientLogout() {
    currentDocuments = [];
    document.getElementById('authContainer').style.display = 'block';
    document.getElementById('clientPortal').style.display = 'none';
    document.getElementById('authCode').value = '';
}

async function showApp() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
    document.getElementById('userName').textContent = currentUser.name;
    await loadData();
}

function showClientPortal() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('clientPortal').style.display = 'block';
    renderClientDocuments();
}

function renderClientDocuments() {
    const container = document.getElementById('clientPortalContent');
    if (currentDocuments.length === 0) {
        container.innerHTML = '<div>No documents found</div>';
        return;
    }
    
    let navHTML = '';
    if (currentDocuments.length > 1) {
        navHTML = '<div class="doc-nav">';
        currentDocuments.forEach((doc, i) => {
            navHTML += `<div class="doc-nav-item ${i === currentDocIndex ? 'active' : ''} ${doc.status === 'completed' ? 'completed' : ''}" onclick="switchDocument(${i})">
                ${i + 1}. ${templateNames[doc.template_id]}
            </div>`;
        });
        navHTML += '</div>';
    }
    
    const doc = currentDocuments[currentDocIndex];
    const template = documentTemplates[doc.template_id];
    
    let html = navHTML + `
        <div class="document-header">
            <h1>${template.name}</h1>
            <p style="color: #666;">Client: ${doc.client_name}</p>
            ${currentDocuments.length > 1 ? `<p style="font-size: 14px; margin-top: 5px;">Document ${currentDocIndex + 1} of ${currentDocuments.length}</p>` : ''}
        </div>
        <div class="form-section">
            <h2 style="margin-bottom: 20px;">Please complete:</h2>
            <form id="clientDocumentForm">
    `;
    
    template.fields.forEach(field => {
        html += `<div class="form-field"><label>${field.label}</label>`;
        if (field.type === 'checkbox') {
            html += `<input type="checkbox" id="${field.id}" style="width: auto;">`;
        } else if (field.type === 'select') {
            html += `<select id="${field.id}">`;
            field.options.forEach(opt => html += `<option>${opt}</option>`);
            html += `</select>`;
        } else if (field.type === 'textarea') {
            html += `<textarea id="${field.id}"></textarea>`;
        } else {
            html += `<input type="${field.type}" id="${field.id}">`;
        }
        html += `</div>`;
    });
    
    html += `</form></div>
        <div class="form-section">
            <h3 style="margin-bottom: 20px;">Signature</h3>
            <div class="signature-pad">
                <p style="margin-bottom: 10px;">Type your full name:</p>
                <input type="text" id="clientSignature" class="signature-input" placeholder="Your Full Name">
            </div>
        </div>
        <div class="submit-section">
            <button onclick="submitClientDocument()" class="btn btn-primary" style="font-size: 16px; padding: 15px 40px;">Submit Document</button>
        </div>
    `;
    
    container.innerHTML = html;
}

function switchDocument(index) {
    currentDocIndex = index;
    renderClientDocuments();
}

async function submitClientDocument() {
    const signature = document.getElementById('clientSignature').value.trim();
    if (!signature) return alert('Please sign');
    
    const responses = {};
    const template = documentTemplates[currentDocuments[currentDocIndex].template_id];
    
    template.fields.forEach(field => {
        const el = document.getElementById(field.id);
        if (el) responses[field.id] = el.type === 'checkbox' ? el.checked : el.value;
    });
    
    try {
        await apiCall(`/assigned-docs`, {
            method: 'PUT',
            body: JSON.stringify({
                id: currentDocuments[currentDocIndex].id,
                responses, signature, status: 'completed'
            }),
            skipAuth: true
        });
        
        currentDocuments[currentDocIndex].status = 'completed';
        const remaining = currentDocuments.filter(d => d.status === 'pending');
        
        if (remaining.length > 0) {
            alert(`‚úÖ Submitted! ${remaining.length} more to complete.`);
            currentDocIndex = currentDocuments.findIndex(d => d.status === 'pending');
            renderClientDocuments();
        } else {
            alert('‚úÖ All documents submitted!');
            clientLogout();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function loadData() {
    try {
        await loadTemplates();
        [clients, assignedDocs] = await Promise.all([
            apiCall('/clients'),
            apiCall('/assigned-docs')
        ]);
        renderClients();
        updateDocBadge();
    } catch (error) {
        console.error('Load error:', error);
    }
}

function updateDocBadge() {
    const needsReview = assignedDocs.filter(d => d.status === 'completed' && !d.clinician_signature).length;
    const badge = document.getElementById('docBadge');
    badge.style.display = needsReview > 0 ? 'inline-block' : 'none';
    badge.textContent = needsReview;
}

function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tab + 'Content').style.display = 'block';
    event.target.classList.add('active');
    
    if (tab === 'clients') renderClients();
    else if (tab === 'documents') renderDocs();
    else if (tab === 'audit') renderAudit();
}

function renderClients() {
    const container = document.getElementById('clientsList');
    if (clients.length === 0) {
        container.innerHTML = '<p style="color: white;">No clients yet</p>';
        return;
    }
    
    container.innerHTML = clients.map(c => `
        <div class="client-card" onclick="openClientChart(${c.id})">
            <h3>${c.name}</h3>
            <p>üìß ${c.email || 'N/A'}</p>
            <p>üìû ${c.phone || 'N/A'}</p>
            <p>üéÇ ${c.dob ? new Date(c.dob).toLocaleDateString() : 'N/A'}</p>
        </div>
    `).join('');
}

function filterClients() {
    const term = document.getElementById('clientSearchInput').value.toLowerCase();
    const filtered = clients.filter(c => 
        c.name.toLowerCase().includes(term) ||
        (c.email && c.email.toLowerCase().includes(term)) ||
        (c.phone && c.phone.includes(term))
    );
    
    const container = document.getElementById('clientsList');
    container.innerHTML = filtered.map(c => `
        <div class="client-card" onclick="openClientChart(${c.id})">
            <h3>${c.name}</h3>
            <p>üìß ${c.email || 'N/A'}</p>
            <p>üìû ${c.phone || 'N/A'}</p>
            <p>üéÇ ${c.dob ? new Date(c.dob).toLocaleDateString() : 'N/A'}</p>
        </div>
    `).join('');
}

function openNewClient() {
    document.getElementById('newClientModal').style.display = 'block';
}

async function saveClient() {
    const client = {
        name: document.getElementById('clientName').value,
        email: document.getElementById('clientEmail').value,
        phone: document.getElementById('clientPhone').value,
        dob: document.getElementById('clientDOB').value,
        notes: document.getElementById('clientNotes').value
    };
    
    try {
        const created = await apiCall('/clients', {
            method: 'POST',
            body: JSON.stringify(client)
        });
        clients.push(created);
        await logAudit('create_client', { id: created.id, name: created.name });
        closeModal('newClientModal');
        renderClients();
        ['clientName','clientEmail','clientPhone','clientDOB','clientNotes'].forEach(id => document.getElementById(id).value = '');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function openEditClient(id) {
    const c = clients.find(c => c.id === id);
    if (!c) return;
    document.getElementById('editClientId').value = c.id;
    document.getElementById('editClientName').value = c.name;
    document.getElementById('editClientEmail').value = c.email || '';
    document.getElementById('editClientPhone').value = c.phone || '';
    document.getElementById('editClientDOB').value = c.dob || '';
    document.getElementById('editClientNotes').value = c.notes || '';
    document.getElementById('editClientModal').style.display = 'block';
}

async function updateClient() {
    const id = document.getElementById('editClientId').value;
    const client = {
        id: parseInt(id),
        name: document.getElementById('editClientName').value,
        email: document.getElementById('editClientEmail').value,
        phone: document.getElementById('editClientPhone').value,
        dob: document.getElementById('editClientDOB').value,
        notes: document.getElementById('editClientNotes').value
    };
    
    try {
        const updated = await apiCall('/clients', {
            method: 'PUT',
            body: JSON.stringify(client)
        });
        
        const index = clients.findIndex(c => c.id == id);
        if (index !== -1) clients[index] = updated;
        
        await logAudit('update_client', { id, name: client.name });
        closeModal('editClientModal');
        renderClients();
        alert('‚úÖ Updated!');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Client Chart Functions
async function openClientChart(clientId) {
    const client = clients.find(c => c.id === clientId);
    if (!client) return;
    
    currentChartClient = client;
    clientCalendarDate = new Date();
    
    // Set header info
    document.getElementById('chartClientName').textContent = client.name;
    document.getElementById('chartClientInfo').textContent = 
        `üìß ${client.email || 'N/A'} | üìû ${client.phone || 'N/A'} | üéÇ ${client.dob ? new Date(client.dob).toLocaleDateString() : 'N/A'}`;
    
    // Load client data
    await loadClientChartData();
    
    // Show overview tab by default
    showChartTab('overview');
    
    // Open modal
    document.getElementById('clientChartModal').style.display = 'block';
}

function showChartTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.chart-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.chart-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`chart${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).classList.add('active');
    event.target.classList.add('active');
    
    // Load tab-specific data
    if (tabName === 'appointments') {
        renderClientCalendar();
        renderClientAppointmentsList();
    } else if (tabName === 'documents') {
        renderClientDocuments();
    } else if (tabName === 'invoices') {
        renderClientInvoices();
    } else if (tabName === 'notes') {
        renderClientNotes();
    }
}

async function loadClientChartData() {
    if (!currentChartClient) return;
    
    // Filter client's appointments
    clientAppointments = appointments.filter(apt => apt.client_id === currentChartClient.id);
    
    // Filter client's documents
    clientDocs = assignedDocs.filter(doc => doc.client_id === currentChartClient.id);
    
    // Filter client's invoices
    clientInvoices = invoices.filter(inv => inv.client_id === currentChartClient.id);
    
    // Update overview stats
    const completedAppts = clientAppointments.filter(apt => apt.status === 'completed').length;
    const pendingDocs = clientDocs.filter(doc => doc.status === 'pending').length;
    const totalBilled = clientInvoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
    
    document.getElementById('chartTotalAppts').textContent = clientAppointments.length;
    document.getElementById('chartCompletedAppts').textContent = completedAppts;
    document.getElementById('chartPendingDocs').textContent = pendingDocs;
    document.getElementById('chartTotalBilled').textContent = '$' + totalBilled.toFixed(2);
    
    // Render overview content
    renderClientOverview();
}

function renderClientOverview() {
    const container = document.getElementById('chartOverviewContent');
    
    // Show recent activity
    let html = '<div class="card"><h3>üìã Recent Activity</h3>';
    
    // Get recent appointments
    const recentAppts = clientAppointments
        .sort((a, b) => new Date(b.appointment_date) - new Date(a.appointment_date))
        .slice(0, 5);
    
    if (recentAppts.length > 0) {
        html += '<h4 style="margin-top: 20px; color: #E85D4F;">Recent Appointments</h4>';
        recentAppts.forEach(apt => {
            html += `<div style="padding: 10px; border-bottom: 1px solid #eee;">
                ${new Date(apt.appointment_date).toLocaleDateString()} at ${apt.appointment_time} - ${apt.type}
                <span style="float: right; color: #27ae60;">${apt.status}</span>
            </div>`;
        });
    }
    
    // Get recent documents
    const recentDocs = clientDocs
        .sort((a, b) => new Date(b.assigned_at) - new Date(a.assigned_at))
        .slice(0, 5);
    
    if (recentDocs.length > 0) {
        html += '<h4 style="margin-top: 20px; color: #E85D4F;">Recent Documents</h4>';
        recentDocs.forEach(doc => {
            const statusColor = doc.status === 'completed' ? '#27ae60' : '#e67e22';
            html += `<div style="padding: 10px; border-bottom: 1px solid #eee;">
                ${doc.template_name}
                <span style="float: right; color: ${statusColor};">${doc.status}</span>
            </div>`;
        });
    }
    
    html += '</div>';
    container.innerHTML = html;
}

function renderClientCalendar() {
    const calendar = document.getElementById('clientCalendarView');
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    
    document.getElementById('clientCalendarMonth').textContent = 
        `${monthNames[clientCalendarDate.getMonth()]} ${clientCalendarDate.getFullYear()}`;
    
    const firstDay = new Date(clientCalendarDate.getFullYear(), clientCalendarDate.getMonth(), 1);
    const lastDay = new Date(clientCalendarDate.getFullYear(), clientCalendarDate.getMonth() + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    let html = '<div class="calendar-grid">';
    
    // Day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
        html += `<div style="background: #f8f9fa; padding: 10px; text-align: center; font-weight: bold; color: #666;">${day}</div>`;
    });
    
    // Calendar days
    for (let i = 0; i < 42; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        const isCurrentMonth = currentDate.getMonth() === clientCalendarDate.getMonth();
        const isToday = currentDate.toDateString() === new Date().toDateString();
        const dayAppointments = clientAppointments.filter(apt => 
            new Date(apt.appointment_date).toDateString() === currentDate.toDateString()
        );
        
        let classes = 'calendar-day';
        if (!isCurrentMonth) classes += ' other-month';
        if (isToday) classes += ' today';
        if (dayAppointments.length > 0) classes += ' has-appointment';
        
        html += `<div class="${classes}">
                    <div>${currentDate.getDate()}</div>
                    ${dayAppointments.length > 0 ? '<div class="appointment-dot"></div>' : ''}
                </div>`;
    }
    
    html += '</div>';
    calendar.innerHTML = html;
}

function renderClientAppointmentsList() {
    const container = document.getElementById('clientAppointmentsList');
    
    if (clientAppointments.length === 0) {
        container.innerHTML = '<p>No appointments scheduled.</p>';
        return;
    }
    
    const sortedAppointments = clientAppointments.sort((a, b) => {
        const dateA = new Date(`${a.appointment_date} ${a.appointment_time}`);
        const dateB = new Date(`${b.appointment_date} ${b.appointment_time}`);
        return dateB - dateA;
    });
    
    container.innerHTML = '<h3>All Appointments</h3>' + sortedAppointments.map(apt => {
        const statusClass = apt.status === 'completed' ? 'success' : apt.status === 'cancelled' ? 'danger' : 'warning';
        return `<div class="appointment-item">
                    <div class="appointment-info">
                        <h4>${new Date(apt.appointment_date).toLocaleDateString()} at ${apt.appointment_time}</h4>
                        <p>‚è±Ô∏è ${apt.duration} minutes - ${apt.type}</p>
                        ${apt.notes ? `<p>üìù ${apt.notes}</p>` : ''}
                    </div>
                    <div class="appointment-actions">
                        <span class="btn btn-${statusClass} btn-small">${apt.status}</span>
                    </div>
                </div>`;
    }).join('');
}

function renderClientDocuments() {
    const container = document.getElementById('chartDocumentsContent');
    
    if (clientDocs.length === 0) {
        container.innerHTML = '<div class="card"><p>No documents assigned to this client.</p></div>';
        return;
    }
    
    const pending = clientDocs.filter(d => d.status === 'pending');
    const completed = clientDocs.filter(d => d.status === 'completed');
    
    let html = '';
    
    if (pending.length > 0) {
        html += '<div class="card"><h3 style="color: #e67e22;">‚è≥ Pending Documents</h3>';
        pending.forEach(d => {
            html += `<div style="padding: 15px; border-bottom: 1px solid #eee;">
                <h4>${d.template_name}</h4>
                <p>Assigned: ${new Date(d.assigned_at).toLocaleDateString()}</p>
                <p>Auth Code: <code>${d.auth_code}</code></p>
            </div>`;
        });
        html += '</div>';
    }
    
    if (completed.length > 0) {
        html += '<div class="card" style="margin-top: 20px;"><h3 style="color: #27ae60;">‚úÖ Completed Documents</h3>';
        completed.forEach(d => {
            html += `<div style="padding: 15px; border-bottom: 1px solid #eee;">
                <h4>${d.template_name}</h4>
                <p>Completed: ${new Date(d.completed_at).toLocaleDateString()}</p>
            </div>`;
        });
        html += '</div>';
    }
    
    container.innerHTML = html;
}

function renderClientInvoices() {
    const container = document.getElementById('chartInvoicesContent');
    
    if (clientInvoices.length === 0) {
        container.innerHTML = '<div class="card"><p>No invoices for this client.</p></div>';
        return;
    }
    
    const html = '<div class="invoices-grid">' + clientInvoices.map(invoice => {
        const statusClass = invoice.status;
        const dueDate = new Date(invoice.due_date);
        const isOverdue = invoice.status === 'pending' && dueDate < new Date();
        const displayStatus = isOverdue ? 'overdue' : invoice.status;
        
        return `<div class="invoice-card">
                    <div class="invoice-header">
                        <span class="invoice-number">${invoice.invoice_number}</span>
                        <span class="invoice-status ${displayStatus}">${displayStatus.toUpperCase()}</span>
                    </div>
                    <div class="invoice-amount">$${parseFloat(invoice.total_amount).toFixed(2)}</div>
                    <div class="invoice-details">
                        <p>Due: ${new Date(invoice.due_date).toLocaleDateString()}</p>
                        <p>Created: ${new Date(invoice.created_at).toLocaleDateString()}</p>
                        ${invoice.payment_date ? `<p>Paid: ${new Date(invoice.payment_date).toLocaleDateString()}</p>` : ''}
                    </div>
                    <div class="invoice-actions">
                        <button onclick="viewInvoice(${invoice.id})" class="btn btn-small">View</button>
                        ${invoice.status === 'pending' ? 
                            `<button onclick="markPaid(${invoice.id})" class="btn btn-success btn-small">Mark Paid</button>` : 
                            ''
                        }
                    </div>
                </div>`;
    }).join('') + '</div>';
    
    container.innerHTML = html;
}

function renderClientNotes() {
    const container = document.getElementById('chartNotesContent');
    container.innerHTML = '<div class="card"><p>Clinical notes feature coming soon...</p></div>';
}

function previousClientMonth() {
    clientCalendarDate.setMonth(clientCalendarDate.getMonth() - 1);
    renderClientCalendar();
}

function nextClientMonth() {
    clientCalendarDate.setMonth(clientCalendarDate.getMonth() + 1);
    renderClientCalendar();
}

// Quick actions from chart
function scheduleFromChart() {
    if (!currentChartClient) return;
    closeModal('clientChartModal');
    openNewAppointment();
    document.getElementById('appointmentClient').value = currentChartClient.id;
}

function assignDocFromChart() {
    if (!currentChartClient) return;
    closeModal('clientChartModal');
    openAssignDoc();
    document.getElementById('assignClient').value = currentChartClient.id;
}

function createInvoiceFromChart() {
    if (!currentChartClient) return;
    closeModal('clientChartModal');
    openNewInvoice();
    document.getElementById('invoiceClient').value = currentChartClient.id;
}

function openEditClientFromChart() {
    if (!currentChartClient) return;
    closeModal('clientChartModal');
    openEditClient(currentChartClient.id);
}

function renderDocs() {
    const container = document.getElementById('docsList');
    if (assignedDocs.length === 0) {
        container.innerHTML = '<div class="card"><p>No documents assigned</p></div>';
        return;
    }
    
    const pending = assignedDocs.filter(d => d.status === 'pending');
    const completed = assignedDocs.filter(d => d.status === 'completed');
    
    let html = '';
    if (pending.length > 0) {
        html += '<div class="card"><h3 style="color: #e67e22;">‚è≥ Pending (' + pending.length + ')</h3><table style="width: 100%;"><thead><tr><th>Document</th><th>Client</th><th>Code</th></tr></thead><tbody>';
        pending.forEach(d => html += `<tr><td>${d.template_name}</td><td>${d.client_name}</td><td><code>${d.auth_code}</code></td></tr>`);
        html += '</tbody></table></div>';
    }
    
    if (completed.length > 0) {
        html += '<div class="card" style="margin-top: 20px;"><h3 style="color: #27ae60;">‚úÖ Completed (' + completed.length + ')</h3><table style="width: 100%;"><thead><tr><th>Document</th><th>Client</th><th>Completed</th></tr></thead><tbody>';
        completed.forEach(d => html += `<tr><td>${d.template_name}</td><td>${d.client_name}</td><td>${new Date(d.completed_at).toLocaleDateString()}</td></tr>`);
        html += '</tbody></table></div>';
    }
    
    container.innerHTML = html;
}

function openAssignDoc() {
    const select = document.getElementById('assignClient');
    select.innerHTML = '<option value="">Select Client</option>' + 
        clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    const container = document.getElementById('templateCheckboxContainer');
    container.innerHTML = Object.keys(documentTemplates).map(id => {
        const t = documentTemplates[id];
        return `<label style="display: block; margin-bottom: 10px; cursor: pointer; padding: 8px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='#e8f4f8'" onmouseout="this.style.background='transparent'">
            <input type="checkbox" value="${id}" class="doc-checkbox" style="margin-right: 8px;" onchange="updateSelectedCount()">
            <span style="font-weight: 500;">${t.name}</span>
        </label>`;
    }).join('');
    
    updateSelectedCount();
    document.getElementById('assignDocModal').style.display = 'block';
}

function selectAllDocs() {
    document.querySelectorAll('.doc-checkbox').forEach(cb => cb.checked = true);
    updateSelectedCount();
}

function deselectAllDocs() {
    document.querySelectorAll('.doc-checkbox').forEach(cb => cb.checked = false);
    updateSelectedCount();
}

function updateSelectedCount() {
    const count = document.querySelectorAll('.doc-checkbox:checked').length;
    const countEl = document.getElementById('selectedCount');
    if (count === 0) {
        countEl.textContent = 'No documents selected';
        countEl.style.color = '#999';
    } else {
        countEl.textContent = `‚úì ${count} document${count > 1 ? 's' : ''} selected`;
        countEl.style.color = '#E85D4F';
    }
}

async function saveAssignDoc() {
    const clientId = document.getElementById('assignClient').value;
    const selected = Array.from(document.querySelectorAll('.doc-checkbox:checked')).map(cb => cb.value);
    
    if (!clientId || selected.length === 0) {
        return alert('Please select client and documents');
    }
    
    const code = generateAuthCode();
    const client = clients.find(c => c.id == clientId);
    const clientName = client ? client.name : 'Unknown Client';
    
    try {
        const created = [];
        for (const templateId of selected) {
            const doc = await apiCall('/assigned-docs', {
                method: 'POST',
                body: JSON.stringify({
                    client_id: clientId,
                    client_name: clientName,
                    template_id: templateId,
                    template_name: templateNames[templateId],
                    auth_code: code
                })
            });
            assignedDocs.push(doc);
            created.push(templateNames[templateId]);
            await logAudit('assign_document', { id: doc.id, code });
        }
        
        closeModal('assignDocModal');
        document.getElementById('generatedCode').textContent = code;
        document.getElementById('assignedDocsList').innerHTML = '<p><strong>Assigned:</strong></p><ul>' +
            created.map(name => `<li>${name}</li>`).join('') + '</ul>';
        document.getElementById('successModal').style.display = 'block';
        renderDocs();
        updateDocBadge();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function generateAuthCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 3; i++) code += chars[Math.floor(Math.random() * chars.length)];
    code += '-';
    for (let i = 0; i < 6; i++) code += chars[Math.floor(Math.random() * chars.length)];
    return code;
}

async function renderAudit() {
    try {
        const logs = await apiCall('/audit');
        const container = document.getElementById('auditList');
        
        if (logs.length === 0) {
            container.innerHTML = '<div class="card"><p>No logs</p></div>';
            return;
        }
        
        container.innerHTML = '<div class="card"><table style="width: 100%;"><thead><tr><th>Time</th><th>User</th><th>Action</th></tr></thead><tbody>' +
            logs.map(l => `<tr><td>${new Date(l.timestamp).toLocaleString()}</td><td>${l.user_name}</td><td>${l.action}</td></tr>`).join('') +
            '</tbody></table></div>';
    } catch (error) {
        console.error('Audit error:', error);
    }
}

async function logAudit(action, details = {}, userName = null) {
    try {
        await apiCall('/audit', {
            method: 'POST',
            body: JSON.stringify({ action, details, user_name: userName || currentUser?.name }),
            skipAuth: !authToken
        });
    } catch (error) {
        console.error('Log error:', error);
    }
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

// New Features JavaScript
let appointments = [];
let invoices = [];
let analyticsData = {};
let currentCalendarDate = new Date();

// Analytics Dashboard
async function loadAnalytics() {
    const timeframe = document.getElementById('timeframeSelect').value;
    try {
        document.getElementById('analyticsContent').innerHTML = '<div class="loading">Loading analytics...</div>';
        const data = await apiCall(`/analytics?timeframe=${timeframe}`);
        analyticsData = data;
        renderAnalytics(data);
    } catch (error) {
        console.error('Analytics error:', error);
        document.getElementById('analyticsContent').innerHTML = '<div class="card"><p>Error loading analytics</p></div>';
    }
}

function renderAnalytics(data) {
    const { overview, trends } = data;
    
    // Update stat cards
    document.getElementById('totalClients').textContent = overview.total_clients;
    document.getElementById('upcomingAppointments').textContent = overview.upcoming_appointments;
    document.getElementById('pendingDocuments').textContent = overview.pending_documents;
    document.getElementById('totalRevenue').textContent = `$${overview.total_revenue.toFixed(2)}`;
    
    // Render monthly chart
    const monthlyChart = document.getElementById('monthlyChart');
    monthlyChart.innerHTML = trends.monthly_appointments.map(item => {
        const month = new Date(item.month).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        return `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span>${month}</span>
                    <span style="font-weight: bold; color: #E85D4F;">${item.appointment_count}</span>
                </div>`;
    }).join('');
    
    // Render top clients
    const topClientsList = document.getElementById('topClientsList');
    topClientsList.innerHTML = trends.top_clients.map(client => {
        return `<div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
                    <span>${client.name}</span>
                    <span style="font-weight: bold; color: #E85D4F;">${client.appointment_count} appointments</span>
                </div>`;
    }).join('');
}

// Appointments Management
async function loadAppointments() {
    try {
        const month = currentCalendarDate.getMonth() + 1;
        const year = currentCalendarDate.getFullYear();
        appointments = await apiCall(`/appointments?month=${month}&year=${year}`);
        renderCalendar();
        renderAppointmentsList();
    } catch (error) {
        console.error('Appointments error:', error);
    }
}

function renderCalendar() {
    const calendar = document.getElementById('calendarView');
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];
    
    document.getElementById('currentMonth').textContent = 
        `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
    
    const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
    const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    let html = '<div class="calendar-grid">';
    
    // Day headers
    const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayHeaders.forEach(day => {
        html += `<div style="background: #f8f9fa; padding: 10px; text-align: center; font-weight: bold; color: #666;">${day}</div>`;
    });
    
    // Calendar days
    for (let i = 0; i < 42; i++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + i);
        
        const isCurrentMonth = currentDate.getMonth() === currentCalendarDate.getMonth();
        const isToday = currentDate.toDateString() === new Date().toDateString();
        
        // Compare dates as YYYY-MM-DD strings to avoid timezone issues
        const dateString = currentDate.toISOString().split('T')[0];
        const dayAppointments = appointments.filter(apt => {
            const aptDate = apt.appointment_date.split('T')[0]; // Handle both 'YYYY-MM-DD' and ISO formats
            return aptDate === dateString;
        });
        
        let classes = 'calendar-day';
        if (!isCurrentMonth) classes += ' other-month';
        if (isToday) classes += ' today';
        if (dayAppointments.length > 0) classes += ' has-appointment';
        
        html += `<div class="${classes}" onclick="showDayAppointments('${dateString}')">
                    <div>${currentDate.getDate()}</div>
                    ${dayAppointments.length > 0 ? '<div class="appointment-dot"></div>' : ''}
                </div>`;
    }
    
    html += '</div>';
    calendar.innerHTML = html;
}

function renderAppointmentsList() {
    const container = document.getElementById('appointmentsList');
    if (appointments.length === 0) {
        container.innerHTML = '<p>No appointments scheduled for this month.</p>';
        return;
    }
    
    const sortedAppointments = appointments.sort((a, b) => {
        const dateA = new Date(`${a.appointment_date} ${a.appointment_time}`);
        const dateB = new Date(`${b.appointment_date} ${b.appointment_time}`);
        return dateA - dateB;
    });
    
    container.innerHTML = sortedAppointments.map(apt => {
        const statusClass = apt.status === 'completed' ? 'success' : apt.status === 'cancelled' ? 'danger' : 'warning';
        return `<div class="appointment-item">
                    <div class="appointment-info">
                        <h4 style="cursor: pointer; color: #E85D4F;" onclick="openClientChart(${apt.client_id}); event.stopPropagation();">${apt.client_name}</h4>
                        <p>üìÖ ${new Date(apt.appointment_date).toLocaleDateString()} at ${apt.appointment_time}</p>
                        <p>‚è±Ô∏è ${apt.duration} minutes - ${apt.type}</p>
                        ${apt.notes ? `<p>üìù ${apt.notes}</p>` : ''}
                    </div>
                    <div class="appointment-actions">
                        <span class="btn btn-${statusClass} btn-small">${apt.status}</span>
                        <button onclick="editAppointment(${apt.id})" class="btn btn-small">Edit</button>
                        <button onclick="deleteAppointment(${apt.id})" class="btn btn-danger btn-small">Delete</button>
                    </div>
                </div>`;
    }).join('');
}

function previousMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
    loadAppointments();
}

function nextMonth() {
    currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
    loadAppointments();
}

function showDayAppointments(date) {
    const dayAppointments = appointments.filter(apt => apt.appointment_date === date);
    if (dayAppointments.length > 0) {
        alert(`Appointments for ${new Date(date).toLocaleDateString()}:\n\n` + 
              dayAppointments.map(apt => `${apt.appointment_time} - ${apt.client_name} (${apt.type})`).join('\n'));
    }
}

function openNewAppointment() {
    const select = document.getElementById('appointmentClient');
    select.innerHTML = '<option value="">Select Client</option>' + 
        clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    // Set default date to today
    document.getElementById('appointmentDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('newAppointmentModal').style.display = 'block';
}

async function saveAppointment() {
    const clientId = document.getElementById('appointmentClient').value;
    const client = clients.find(c => c.id == clientId);
    const clientName = client ? client.name : 'Unknown Client';
    
    const appointment = {
        client_id: clientId,
        client_name: clientName,
        appointment_date: document.getElementById('appointmentDate').value,
        appointment_time: document.getElementById('appointmentTime').value,
        duration: document.getElementById('appointmentDuration').value,
        type: document.getElementById('appointmentType').value,
        notes: document.getElementById('appointmentNotes').value,
        cpt_code: document.getElementById('appointmentType').value
    };
    
    try {
        const created = await apiCall('/appointments', {
            method: 'POST',
            body: JSON.stringify(appointment)
        });
        appointments.push(created);
        await logAudit('create_appointment', { id: created.id, client_id: appointment.client_id });
        closeModal('newAppointmentModal');
        renderCalendar();
        renderAppointmentsList();
        alert('‚úÖ Appointment created!');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Invoices Management
async function loadInvoices() {
    try {
        invoices = await apiCall('/invoices');
        renderInvoices();
    } catch (error) {
        console.error('Invoices error:', error);
    }
}

function renderInvoices() {
    const container = document.getElementById('invoicesList');
    if (invoices.length === 0) {
        container.innerHTML = '<p>No invoices found.</p>';
        return;
    }
    
    container.innerHTML = invoices.map(invoice => {
        const statusClass = invoice.status;
        const dueDate = new Date(invoice.due_date);
        const isOverdue = invoice.status === 'pending' && dueDate < new Date();
        const displayStatus = isOverdue ? 'overdue' : invoice.status;
        
        return `<div class="invoice-card">
                    <div class="invoice-header">
                        <span class="invoice-number">${invoice.invoice_number}</span>
                        <span class="invoice-status ${displayStatus}">${displayStatus.toUpperCase()}</span>
                    </div>
                    <h4>${invoice.client_name}</h4>
                    <div class="invoice-amount">$${parseFloat(invoice.total_amount).toFixed(2)}</div>
                    <div class="invoice-details">
                        <p>Due: ${new Date(invoice.due_date).toLocaleDateString()}</p>
                        <p>Created: ${new Date(invoice.created_at).toLocaleDateString()}</p>
                        ${invoice.payment_date ? `<p>Paid: ${new Date(invoice.payment_date).toLocaleDateString()}</p>` : ''}
                    </div>
                    <div class="invoice-actions">
                        <button onclick="viewInvoice(${invoice.id})" class="btn btn-small">View</button>
                        ${invoice.status === 'pending' ? 
                            `<button onclick="markPaid(${invoice.id})" class="btn btn-success btn-small">Mark Paid</button>` : 
                            ''
                        }
                    </div>
                </div>`;
    }).join('');
}

function openNewInvoice() {
    const select = document.getElementById('invoiceClient');
    select.innerHTML = '<option value="">Select Client</option>' + 
        clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    // Set default due date to 30 days from now
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + 30);
    document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
    
    document.getElementById('newInvoiceModal').style.display = 'block';
}

function addService() {
    const servicesList = document.getElementById('servicesList');
    const serviceItem = document.createElement('div');
    serviceItem.className = 'service-item';
    serviceItem.style.display = 'flex';
    serviceItem.style.gap = '10px';
    serviceItem.style.marginBottom = '10px';
    serviceItem.innerHTML = `
        <input type="text" placeholder="Service Description" class="input service-desc" style="flex: 2;">
        <select class="input service-cpt" style="flex: 1;">
            <option value="">CPT Code</option>
            <option value="90791">90791 - Psychiatric Diagnostic Evaluation</option>
            <option value="90834">90834 - Psychotherapy 45 min</option>
            <option value="90837">90837 - Psychotherapy 60 min</option>
            <option value="90847">90847 - Family Psychotherapy</option>
            <option value="90853">90853 - Group Psychotherapy</option>
        </select>
        <input type="number" placeholder="Amount" class="input service-amount" step="0.01" style="flex: 1;" onchange="updateInvoiceTotal()">
        <button onclick="removeService(this)" class="btn btn-danger btn-small">Remove</button>
    `;
    servicesList.appendChild(serviceItem);
    updateInvoiceTotal();
}

function removeService(button) {
    button.parentElement.remove();
    updateInvoiceTotal();
}

function updateInvoiceTotal() {
    const amounts = Array.from(document.querySelectorAll('.service-amount')).map(input => 
        parseFloat(input.value) || 0
    );
    const total = amounts.reduce((sum, amount) => sum + amount, 0);
    document.getElementById('invoiceTotal').textContent = total.toFixed(2);
}

async function saveInvoice() {
    const services = Array.from(document.querySelectorAll('.service-item')).map(item => {
        const desc = item.querySelector('.service-desc').value;
        const cpt = item.querySelector('.service-cpt').value;
        const amount = parseFloat(item.querySelector('.service-amount').value) || 0;
        return { description: desc, cpt_code: cpt, amount: amount };
    }).filter(service => service.description && service.amount > 0);
    
    if (services.length === 0) return alert('Please add at least one service');
    
    const totalAmount = services.reduce((sum, service) => sum + service.amount, 0);
    
    const invoice = {
        client_id: document.getElementById('invoiceClient').value,
        services: services,
        total_amount: totalAmount,
        due_date: document.getElementById('invoiceDueDate').value,
        notes: document.getElementById('invoiceNotes').value
    };
    
    try {
        const created = await apiCall('/invoices', {
            method: 'POST',
            body: JSON.stringify(invoice)
        });
        invoices.push(created);
        await logAudit('create_invoice', { id: created.id, client_id: invoice.client_id, amount: totalAmount });
        closeModal('newInvoiceModal');
        renderInvoices();
        alert('‚úÖ Invoice created!');
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Enhanced showTab function
const originalShowTab = showTab;
showTab = function(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tab + 'Content').style.display = 'block';
    event.target.classList.add('active');
    
    if (tab === 'dashboard') {
        loadAnalytics();
    } else if (tab === 'clients') {
        renderClients();
    } else if (tab === 'appointments') {
        loadAppointments();
    } else if (tab === 'documents') {
        renderDocs();
    } else if (tab === 'invoices') {
        loadInvoices();
    } else if (tab === 'audit') {
        renderAudit();
    }
};

// Enhanced UI Functions
function showNotification(message, type = 'info', duration = 5000) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 18px;">
                ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
            </span>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; margin-left: auto;">√ó</button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.animation = 'slideOutRight 0.3s ease-out forwards';
            setTimeout(() => notification.remove(), 300);
        }
    }, duration);
}

function setLoading(element, isLoading) {
    if (isLoading) {
        element.classList.add('loading');
        const spinner = element.querySelector('.loading-spinner');
        if (spinner) spinner.style.display = 'inline-block';
    } else {
        element.classList.remove('loading');
        const spinner = element.querySelector('.loading-spinner');
        if (spinner) spinner.style.display = 'none';
    }
}

function validateInput(input, validator) {
    const value = input.value.trim();
    const isValid = validator(value);
    
    if (isValid) {
        input.classList.remove('input-error');
        const errorMsg = input.parentElement.querySelector('.error-message');
        if (errorMsg) errorMsg.style.display = 'none';
    } else {
        input.classList.add('input-error');
        const errorMsg = input.parentElement.querySelector('.error-message');
        if (errorMsg) errorMsg.style.display = 'block';
    }
    
    return isValid;
}

// Enhanced form validation
const validators = {
    username: (value) => value.length >= 3,
    password: (value) => value.length >= 6,
    email: (value) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),
    phone: (value) => /^[\+]?[1-9][\d]{0,15}$/.test(value.replace(/[\s\-\(\)]/g, '')),
    required: (value) => value.length > 0
};

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    // Tab navigation enhancement
    if (e.key === 'Tab') {
        document.body.classList.add('keyboard-navigation');
    }
});

document.addEventListener('mousedown', function() {
    document.body.classList.remove('keyboard-navigation');
});

// PWA Installation
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Show install button
    const installBtn = document.createElement('button');
    installBtn.className = 'btn btn-secondary';
    installBtn.innerHTML = 'üì± Install App';
    installBtn.style.position = 'fixed';
    installBtn.style.bottom = '20px';
    installBtn.style.right = '20px';
    installBtn.style.zIndex = '1000';
    installBtn.onclick = async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
            installBtn.remove();
        }
    };
    document.body.appendChild(installBtn);
});

// Service Worker Registration
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
                console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}

// Enhanced modal functions
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'flex';
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Focus management
        const firstInput = modal.querySelector('input, button, select, textarea');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        modal.classList.remove('active');
        document.body.style.overflow = '';
    }
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const openModal = document.querySelector('.modal.active');
        if (openModal) {
            closeModal(openModal.id);
        }
    }
});

// Enhanced user menu
function toggleUserMenu() {
    // Implementation for user menu dropdown
    showNotification('User menu functionality coming soon!', 'info');
}

// Auto-save functionality
let autoSaveTimeout;
function enableAutoSave(formId, saveFunction) {
    const form = document.getElementById(formId);
    if (form) {
        form.addEventListener('input', () => {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveFunction();
                showNotification('Changes saved automatically', 'success', 2000);
            }, 2000);
        });
    }
}

// Enhanced error handling
window.addEventListener('error', function(e) {
    console.error('Global error:', e.error);
    showNotification('An unexpected error occurred. Please refresh the page.', 'error');
});

// Performance monitoring
const perfObserver = new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
        if (entry.entryType === 'navigation') {
            console.log('Page load time:', entry.loadEventEnd - entry.loadEventStart, 'ms');
        }
    }
});

if (typeof PerformanceObserver !== 'undefined') {
    perfObserver.observe({ entryTypes: ['navigation'] });
}

// Reports & Analytics Functions
async function generateReport() {
    const reportType = document.getElementById('reportType').value;
    const reportContent = document.getElementById('reportContent');
    const reportPreview = document.querySelector('.report-preview');
    const reportTitle = document.getElementById('reportTitle');
    const reportDate = document.getElementById('reportDate');
    const reportData = document.getElementById('reportData');
    
    try {
        reportContent.innerHTML = '<div class="loading">Generating report...</div>';
        
        // Generate report based on type
        let report = {};
        switch(reportType) {
            case 'client-summary':
                report = await generateClientSummaryReport();
                break;
            case 'appointment-trends':
                report = await generateAppointmentTrendsReport();
                break;
            case 'revenue-report':
                report = await generateRevenueReport();
                break;
            case 'document-completion':
                report = await generateDocumentCompletionReport();
                break;
        }
        
        // Display report
        reportTitle.textContent = report.title;
        reportDate.textContent = `Generated on ${new Date().toLocaleDateString()}`;
        reportData.innerHTML = report.content;
        reportPreview.style.display = 'block';
        
        reportContent.innerHTML = `
            <div class="card">
                <h3>üìà Report Generated Successfully</h3>
                <p>Your ${report.title} has been generated. Use the export button to download as PDF.</p>
                <div class="report-preview">
                    <div class="report-header">
                        <h4 id="reportTitle">${report.title}</h4>
                        <p id="reportDate">Generated on ${new Date().toLocaleDateString()}</p>
                    </div>
                    <div id="reportData">${report.content}</div>
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Report generation error:', error);
        reportContent.innerHTML = '<div class="error">Failed to generate report. Please try again.</div>';
    }
}

async function generateClientSummaryReport() {
    const clientData = await apiCall('/clients');
    const totalClients = clientData.length;
    const activeClients = clientData.filter(c => c.status === 'active').length;
    
    return {
        title: 'Client Summary Report',
        content: `
            <div class="report-section">
                <h4>üìä Client Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h5>Total Clients</h5>
                        <span class="stat-number">${totalClients}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Active Clients</h5>
                        <span class="stat-number">${activeClients}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Inactive Clients</h5>
                        <span class="stat-number">${totalClients - activeClients}</span>
                    </div>
                </div>
            </div>
            <div class="report-section">
                <h4>üë• Recent Clients</h4>
                <table class="report-table">
                    <thead>
                        <tr><th>Name</th><th>Email</th><th>Status</th><th>Created</th></tr>
                    </thead>
                    <tbody>
                        ${clientData.slice(0, 10).map(client => `
                            <tr>
                                <td>${client.name}</td>
                                <td>${client.email || 'N/A'}</td>
                                <td><span class="status-badge ${client.status}">${client.status}</span></td>
                                <td>${new Date(client.created_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `
    };
}

async function generateAppointmentTrendsReport() {
    const appointmentData = await apiCall('/appointments');
    const last30Days = appointmentData.filter(apt => {
        const aptDate = new Date(apt.appointment_date);
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        return aptDate >= thirtyDaysAgo;
    });
    
    const completed = last30Days.filter(apt => apt.status === 'completed').length;
    const cancelled = last30Days.filter(apt => apt.status === 'cancelled').length;
    const scheduled = last30Days.filter(apt => apt.status === 'scheduled').length;
    
    return {
        title: 'Appointment Trends Report',
        content: `
            <div class="report-section">
                <h4>üìÖ Last 30 Days Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h5>Total Appointments</h5>
                        <span class="stat-number">${last30Days.length}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Completed</h5>
                        <span class="stat-number">${completed}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Cancelled</h5>
                        <span class="stat-number">${cancelled}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Scheduled</h5>
                        <span class="stat-number">${scheduled}</span>
                    </div>
                </div>
            </div>
            <div class="report-section">
                <h4>üìà Completion Rate</h4>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${last30Days.length > 0 ? (completed / last30Days.length * 100) : 0}%"></div>
                </div>
                <p>${last30Days.length > 0 ? Math.round(completed / last30Days.length * 100) : 0}% completion rate</p>
            </div>
        `
    };
}

async function generateRevenueReport() {
    const invoiceData = await apiCall('/invoices');
    const totalRevenue = invoiceData.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);
    const paidInvoices = invoiceData.filter(inv => inv.status === 'paid');
    const pendingInvoices = invoiceData.filter(inv => inv.status === 'pending');
    const paidRevenue = paidInvoices.reduce((sum, inv) => sum + (parseFloat(inv.total_amount) || 0), 0);
    
    return {
        title: 'Revenue Report',
        content: `
            <div class="report-section">
                <h4>üí∞ Revenue Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h5>Total Revenue</h5>
                        <span class="stat-number">$${totalRevenue.toFixed(2)}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Paid Revenue</h5>
                        <span class="stat-number">$${paidRevenue.toFixed(2)}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Pending Revenue</h5>
                        <span class="stat-number">$${(totalRevenue - paidRevenue).toFixed(2)}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Total Invoices</h5>
                        <span class="stat-number">${invoiceData.length}</span>
                    </div>
                </div>
            </div>
            <div class="report-section">
                <h4>üìä Invoice Status Breakdown</h4>
                <div class="status-breakdown">
                    <div class="status-item">
                        <span class="status-label">Paid:</span>
                        <span class="status-count">${paidInvoices.length}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Pending:</span>
                        <span class="status-count">${pendingInvoices.length}</span>
                    </div>
                </div>
            </div>
        `
    };
}

async function generateDocumentCompletionReport() {
    const docData = await apiCall('/assigned-docs');
    const totalDocs = docData.length;
    const completedDocs = docData.filter(doc => doc.status === 'completed').length;
    const pendingDocs = docData.filter(doc => doc.status === 'pending').length;
    
    return {
        title: 'Document Completion Report',
        content: `
            <div class="report-section">
                <h4>üìÑ Document Statistics</h4>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h5>Total Documents</h5>
                        <span class="stat-number">${totalDocs}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Completed</h5>
                        <span class="stat-number">${completedDocs}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Pending</h5>
                        <span class="stat-number">${pendingDocs}</span>
                    </div>
                    <div class="stat-card">
                        <h5>Completion Rate</h5>
                        <span class="stat-number">${totalDocs > 0 ? Math.round(completedDocs / totalDocs * 100) : 0}%</span>
                    </div>
                </div>
            </div>
            <div class="report-section">
                <h4>üìà Recent Document Activity</h4>
                <table class="report-table">
                    <thead>
                        <tr><th>Document</th><th>Client</th><th>Status</th><th>Assigned</th></tr>
                    </thead>
                    <tbody>
                        ${docData.slice(0, 10).map(doc => `
                            <tr>
                                <td>${doc.template_name}</td>
                                <td>${doc.client_name}</td>
                                <td><span class="status-badge ${doc.status}">${doc.status}</span></td>
                                <td>${new Date(doc.assigned_at).toLocaleDateString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `
    };
}

function exportReport() {
    const reportContent = document.querySelector('.report-preview');
    if (!reportContent) {
        showNotification('Please generate a report first', 'warning');
        return;
    }
    
    // Simple PDF export using browser print functionality
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>ClinicalSpeak Report</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .report-header { text-align: center; margin-bottom: 30px; }
                    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
                    .stat-card { border: 1px solid #ddd; padding: 15px; text-align: center; border-radius: 8px; }
                    .stat-number { font-size: 24px; font-weight: bold; color: #FFE066; }
                    .report-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                    .report-table th, .report-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    .report-table th { background-color: #f5f5f5; }
                    .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
                    .status-badge.completed { background-color: #d4edda; color: #155724; }
                    .status-badge.pending { background-color: #fff3cd; color: #856404; }
                    .status-badge.active { background-color: #d1ecf1; color: #0c5460; }
                </style>
            </head>
            <body>
                ${reportContent.innerHTML}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Notifications System
let notifications = [];
let notificationCount = 0;

// Initialize notifications
function initNotifications() {
    // Load saved notifications from localStorage
    const savedNotifications = localStorage.getItem('clinicalspeak_notifications');
    if (savedNotifications) {
        notifications = JSON.parse(savedNotifications);
        updateNotificationBadge();
    }
    
    // Add some demo notifications
    if (notifications.length === 0) {
        addDemoNotifications();
    }
    
    renderNotifications();
}

function addDemoNotifications() {
    const demoNotifications = [
        {
            id: Date.now() + 1,
            type: 'appointment',
            title: 'New Appointment Scheduled',
            message: 'John Doe has scheduled a 60-minute psychotherapy session for tomorrow at 2:00 PM.',
            timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 hours ago
            read: false,
            priority: 'high'
        },
        {
            id: Date.now() + 2,
            type: 'document',
            title: 'Document Completed',
            message: 'Sarah Johnson has completed and signed the Informed Consent form.',
            timestamp: new Date(Date.now() - 4 * 60 * 60 * 1000), // 4 hours ago
            read: false,
            priority: 'medium'
        },
        {
            id: Date.now() + 3,
            type: 'payment',
            title: 'Payment Received',
            message: 'Payment of $150.00 received from Mike Wilson for invoice INV-1001.',
            timestamp: new Date(Date.now() - 6 * 60 * 60 * 1000), // 6 hours ago
            read: true,
            priority: 'low'
        },
        {
            id: Date.now() + 4,
            type: 'system',
            title: 'System Update Available',
            message: 'A new version of ClinicalSpeak EHR is available with enhanced security features.',
            timestamp: new Date(Date.now() - 24 * 60 * 60 * 1000), // 1 day ago
            read: true,
            priority: 'low'
        }
    ];
    
    notifications = demoNotifications;
    saveNotifications();
    updateNotificationBadge();
}

function addNotification(notification) {
    const newNotification = {
        id: Date.now(),
        timestamp: new Date(),
        read: false,
        ...notification
    };
    
    notifications.unshift(newNotification);
    saveNotifications();
    updateNotificationBadge();
    renderNotifications();
    
    // Show browser notification if permission granted
    if (Notification.permission === 'granted') {
        new Notification(notification.title, {
            body: notification.message,
            icon: '/icon.svg'
        });
    }
}

function renderNotifications() {
    const container = document.getElementById('notificationsContainer');
    if (!container) return;
    
    if (notifications.length === 0) {
        container.innerHTML = '<div class="card"><p>No notifications yet.</p></div>';
        return;
    }
    
    const html = notifications.map(notification => `
        <div class="notification-item ${notification.read ? '' : 'unread'}" data-id="${notification.id}">
            <div class="notification-header">
                <h4 class="notification-title">${getNotificationIcon(notification.type)} ${notification.title}</h4>
                <span class="notification-time">${formatTimeAgo(notification.timestamp)}</span>
            </div>
            <p class="notification-message">${notification.message}</p>
            <div class="notification-actions">
                ${!notification.read ? `<button class="mark-read" onclick="markAsRead(${notification.id})">Mark Read</button>` : ''}
                <button class="delete" onclick="deleteNotification(${notification.id})">Delete</button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function getNotificationIcon(type) {
    const icons = {
        'appointment': 'üìÖ',
        'document': 'üìÑ',
        'payment': 'üí∞',
        'system': '‚öôÔ∏è',
        'client': 'üë§',
        'invoice': 'üßæ'
    };
    return icons[type] || 'üîî';
}

function formatTimeAgo(timestamp) {
    const now = new Date();
    const diff = now - new Date(timestamp);
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    return `${days}d ago`;
}

function markAsRead(notificationId) {
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
        notification.read = true;
        saveNotifications();
        updateNotificationBadge();
        renderNotifications();
    }
}

function markAllAsRead() {
    notifications.forEach(notification => {
        notification.read = true;
    });
    saveNotifications();
    updateNotificationBadge();
    renderNotifications();
    showNotification('All notifications marked as read', 'success');
}

function deleteNotification(notificationId) {
    notifications = notifications.filter(n => n.id !== notificationId);
    saveNotifications();
    updateNotificationBadge();
    renderNotifications();
}

function clearAllNotifications() {
    if (confirm('Are you sure you want to clear all notifications?')) {
        notifications = [];
        saveNotifications();
        updateNotificationBadge();
        renderNotifications();
        showNotification('All notifications cleared', 'success');
    }
}

function updateNotificationBadge() {
    const unreadCount = notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notifBadge');
    if (badge) {
        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    }
    notificationCount = unreadCount;
}

function saveNotifications() {
    localStorage.setItem('clinicalspeak_notifications', JSON.stringify(notifications));
}

// Request notification permission
function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                showNotification('Notifications enabled! You\'ll receive alerts for important events.', 'success');
            }
        });
    }
}

// Simulate real-time notifications
function simulateNotifications() {
    const notificationTypes = [
        {
            type: 'appointment',
            title: 'Appointment Reminder',
            message: 'You have an appointment with Jane Smith in 30 minutes.',
            priority: 'high'
        },
        {
            type: 'document',
            title: 'New Document Assignment',
            message: 'A new intake form has been assigned to a client.',
            priority: 'medium'
        },
        {
            type: 'payment',
            title: 'Payment Overdue',
            message: 'Invoice INV-1005 is 5 days overdue.',
            priority: 'high'
        }
    ];
    
    // Add a random notification every 30 seconds (for demo)
    setInterval(() => {
        if (Math.random() < 0.3) { // 30% chance
            const randomNotification = notificationTypes[Math.floor(Math.random() * notificationTypes.length)];
            addNotification(randomNotification);
        }
    }, 30000);
}

// Initialize notifications when the app loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize localStorage demo data
    initializeDemoData();
    
    // Load data from localStorage
    clients = loadFromStorage('clients', []);
    assignedDocs = loadFromStorage('assigned_docs', []);
    appointments = loadFromStorage('appointments', []);
    invoices = loadFromStorage('invoices', []);
    
    // Load auth state
    authToken = loadFromStorage('auth_token', null);
    currentUser = loadFromStorage('current_user', null);
    
    // Load templates
    loadTemplates();
    
    // Initialize notifications
    initNotifications();
    requestNotificationPermission();
    
    // Start simulation after 10 seconds
    setTimeout(simulateNotifications, 10000);
    
    console.log('‚úÖ ClinicalSpeak EHR initialized with localStorage');
});
</script>
</body>
</html>
